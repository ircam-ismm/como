"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _BaseLfo = _interopRequireDefault(require("./BaseLfo.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function simpleLinearRegression(values, dt) {
  // means
  let xSum = 0;
  let ySum = 0;
  const length = values.length;

  for (let i = 0; i < length; i++) {
    xSum += i * dt;
    ySum += values[i];
  }

  const xMean = xSum / length;
  const yMean = ySum / length;
  let sumDiffXMeanSquared = 0; // sum[ pow((x - xMean), 2) ]

  let sumDiffYMeanSquared = 0; // sum[ pow((y - yMean), 2) ]

  let sumDiffXYMean = 0; // sum[ (x - xMean)(y - yMean) ]

  for (let i = 0; i < length; i++) {
    const diffXMean = dt * i - xMean;
    const diffYMean = values[i] - yMean;
    const diffXMeanSquared = diffXMean * diffXMean;
    const diffYMeanSquared = diffYMean * diffYMean;
    const diffXYMean = diffXMean * diffYMean;
    sumDiffXMeanSquared += diffXMeanSquared;
    sumDiffYMeanSquared += diffYMeanSquared;
    sumDiffXYMean += diffXYMean;
  } // horizontal line, all y on same line


  if (sumDiffYMeanSquared === 0) return 0; // Pearson correlation coefficient:
  // cf. https://www.youtube.com/watch?v=2SCg8Kuh0tE
  //
  //                 ∑ [ (x - xMean)(y - yMean) ]
  // r = ------------------------------------------------------
  //     sqrt( ∑ [ pow((x - xMean), 2), pow((y - yMean), 2) ] )
  //
  //

  const r = sumDiffXYMean / Math.sqrt(sumDiffXMeanSquared * sumDiffYMeanSquared); // then we have:
  // cf. https://www.youtube.com/watch?v=GhrxgbQnEEU
  //
  // y = a + bx
  // where:
  //         Sy
  // b = r * --
  //         Sx
  //
  // a = yMean - b * xMean
  //
  // S for standard deviation
  //            ∑ [ pow((x - xMean), 2) ]
  // Sx = sqrt( -------------------------  )
  //                      N - 1

  const Sx = Math.sqrt(sumDiffXMeanSquared / (length - 1));
  const Sy = Math.sqrt(sumDiffYMeanSquared / (length - 1));
  const b = r * (Sy / Sx);
  return b;
}

const definitions = {
  size: {
    type: 'integer',
    min: 2,
    max: +Infinity,
    default: 3
  },
  useFrameRate: {
    type: 'integer',
    min: 0,
    max: +Infinity,
    default: null,
    nullable: true
  }
};
/**
 * Returns the simple derivative of successive value using
 * simple linear regression.
 * The current implementation assumes a fixed `frameRate` (`frame.time` is ignored)
 *
 * Before the module is filled, it outputs a value of 0.
 *
 * @param {Object} options - Override default parameters
 * @param {Number} [options.size=3] - Size of the window
 * @param {Number} [options.useFrameRate=null] - Override stream frame rate for
 *  the regression
 */

class Delta extends _BaseLfo.default {
  constructor(options = {}) {
    super(definitions, options);
    this.buffers = null;
    this.ringIndex = 0;
    this.frameRate = null;
  }
  /** @private */


  processStreamParams(prevStreamParams) {
    this.prepareStreamParams(prevStreamParams);
    const frameSize = this.streamParams.frameSize;
    const size = this.params.get('size');
    const bufferSize = frameSize * size;
    this.buffers = []; // counter before the operator starts outputing frames

    this.ringIndex = 0;
    this.frameRate = this.params.get('useFrameRate') === null ? this.streamParams.frameRate : this.params.get('useFrameRate');

    for (let i = 0; i < frameSize; i++) this.buffers[i] = new Float32Array(size);

    this.propagateStreamParams();
  }
  /** @private */


  resetStream() {
    super.resetStream();
    const frameSize = this.streamParams.frameSize;
    const size = this.params.get('size');
    const buffers = this.buffers;

    for (let i = 0; i < frameSize; i++) {
      for (let j = 0; j < size; j++) buffers[i][j] = 0;
    }

    this.ringIndex = 0;
  }
  /**
   * Assume a stream of vector at a fixed `frameRate`.
   */


  inputVector(data) {
    const size = this.params.get('size');
    const outData = this.frame.data;
    const frameSize = this.streamParams.frameSize; // const frameRate = this.streamParams.frameRate;

    const buffers = this.buffers;
    const dt = 1 / this.frameRate; // console.log(dt);

    if (this.ringIndex < size) this.ringIndex += 1; // copy incomming data into buffer

    for (let i = 0; i < frameSize; i++) {
      const buffer = buffers[i]; // we need to keep the order of the incomming frames
      // so we have to shift all the values in the buffers

      for (let j = 1; j < size; j++) buffer[j - 1] = buffer[j];

      buffer[size - 1] = data[i];
      if (this.ringIndex >= size) outData[i] = simpleLinearRegression(buffer, dt);else outData[i] = 0;
    }

    return outData;
  }
  /** @private */


  processVector(frame) {
    this.frame.data = this.inputVector(frame.data); // center time according to delta size

    const size = this.params.get('size');
    const frameRate = this.streamParams.frameRate;
    this.frame.time -= 0.5 * (size - 1) / frameRate;
  }

}

var _default = Delta;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vbGlicy9sZm8vRGVsdGEuanMiXSwibmFtZXMiOlsic2ltcGxlTGluZWFyUmVncmVzc2lvbiIsInZhbHVlcyIsImR0IiwieFN1bSIsInlTdW0iLCJsZW5ndGgiLCJpIiwieE1lYW4iLCJ5TWVhbiIsInN1bURpZmZYTWVhblNxdWFyZWQiLCJzdW1EaWZmWU1lYW5TcXVhcmVkIiwic3VtRGlmZlhZTWVhbiIsImRpZmZYTWVhbiIsImRpZmZZTWVhbiIsImRpZmZYTWVhblNxdWFyZWQiLCJkaWZmWU1lYW5TcXVhcmVkIiwiZGlmZlhZTWVhbiIsInIiLCJNYXRoIiwic3FydCIsIlN4IiwiU3kiLCJiIiwiZGVmaW5pdGlvbnMiLCJzaXplIiwidHlwZSIsIm1pbiIsIm1heCIsIkluZmluaXR5IiwiZGVmYXVsdCIsInVzZUZyYW1lUmF0ZSIsIm51bGxhYmxlIiwiRGVsdGEiLCJCYXNlTGZvIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiYnVmZmVycyIsInJpbmdJbmRleCIsImZyYW1lUmF0ZSIsInByb2Nlc3NTdHJlYW1QYXJhbXMiLCJwcmV2U3RyZWFtUGFyYW1zIiwicHJlcGFyZVN0cmVhbVBhcmFtcyIsImZyYW1lU2l6ZSIsInN0cmVhbVBhcmFtcyIsInBhcmFtcyIsImdldCIsImJ1ZmZlclNpemUiLCJGbG9hdDMyQXJyYXkiLCJwcm9wYWdhdGVTdHJlYW1QYXJhbXMiLCJyZXNldFN0cmVhbSIsImoiLCJpbnB1dFZlY3RvciIsImRhdGEiLCJvdXREYXRhIiwiZnJhbWUiLCJidWZmZXIiLCJwcm9jZXNzVmVjdG9yIiwidGltZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7O0FBRUEsU0FBU0Esc0JBQVQsQ0FBZ0NDLE1BQWhDLEVBQXdDQyxFQUF4QyxFQUE0QztBQUMxQztBQUNBLE1BQUlDLElBQUksR0FBRyxDQUFYO0FBQ0EsTUFBSUMsSUFBSSxHQUFHLENBQVg7QUFDQSxRQUFNQyxNQUFNLEdBQUdKLE1BQU0sQ0FBQ0ks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O0FBRUZLLE1BQUFBLE1BQU0sQ0FBQy9CLElBQUksR0FBRyxDQUFSLENBQU4sR0FBbUI0QixJQUFJLENBQUM5QyxDQUFELENBQXZCO0FBRUEsVUFBSSxLQUFLK0IsU0FBTCxJQUFrQmIsSUFBdEIsRUFDRTZCLE9BQU8sQ0FBQy9DLENBQUQsQ0FBUCxHQUFhTixzQkFBc0IsQ0FBQ3VELE1BQUQsRUFBU3JELEVBQVQsQ0FBbkMsQ0FERixLQUdFbUQsT0FBTyxDQUFDL0MsQ0FBRCxDQUFQLEdBQWEsQ0FBYjtBQUNIOztBQUVELFdBQU8rQyxPQUFQO0FBQ0Q7QUFFRDs7O0FBQ0FHLEVBQUFBLGFBQWEsQ0FBQ0YsS0FBRCxFQUFRO0FBQ25CLFNBQUtBLEtBQUwsQ0FBV0YsSUFBWCxHQUFrQixLQUFLRCxXQUFMLENBQWlCRyxLQUFLLENBQUNGLElBQXZCLENBQWxCLENBRG1CLENBRW5COztBQUNBLFVBQU01QixJQUFJLEdBQUcsS0FBS29CLE1BQUwsQ0FBWUMsR0FBWixDQUFnQixNQUFoQixDQUFiO0FBQ0EsVUFBTVAsU0FBUyxHQUFHLEtBQUtLLFlBQUwsQ0FBa0JMLFNBQXBDO0FBQ0EsU0FBS2dCLEtBQUwsQ0FBV0csSUFBWCxJQUFtQixPQUFPakMsSUFBSSxHQUFHLENBQWQsSUFBbUJjLFNBQXRDO0FBQ0Q7O0FBekZ5Qjs7ZUE0RmJOLEsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmFzZUxmbyBmcm9tICcuL0Jhc2VMZm8uanMnO1xuXG5mdW5jdGlvbiBzaW1wbGVMaW5lYXJSZWdyZXNzaW9uKHZhbHVlcywgZHQpIHtcbiAgLy8gbWVhbnNcbiAgbGV0IHhTdW0gPSAwO1xuICBsZXQgeVN1bSA9IDA7XG4gIGNvbnN0IGxlbmd0aCA9IHZhbHVlcy5sZW5ndGg7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIHhTdW0gKz0gaSAqIGR0O1xuICAgIHlTdW0gKz0gdmFsdWVzW2ldO1xuICB9XG5cbiAgY29uc3QgeE1lYW4gPSB4U3VtIC8gbGVuZ3RoO1xuICBjb25zdCB5TWVhbiA9IHlTdW0gLyBsZW5ndGg7XG5cbiAgbGV0IHN1bURpZmZYTWVhblNxdWFyZWQgPSAwOyAvLyBzdW1bIHBvdygoeCAtIHhNZWFuKSwgMikgXVxuICBsZXQgc3VtRGlmZllNZWFuU3F1YXJlZCA9IDA7IC8vIHN1bVsgcG93KCh5IC0geU1lYW4pLCAyKSBdXG4gIGxldCBzdW1EaWZmWFlNZWFuID0gMDsgICAgICAgLy8gc3VtWyAoeCAtIHhNZWFuKSh5IC0geU1lYW4pIF1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZGlmZlhNZWFuID0gZHQgKiBpIC0geE1lYW47XG4gICAgY29uc3QgZGlmZllNZWFuID0gdmFsdWVzW2ldIC0geU1lYW47XG5cbiAgICBjb25zdCBkaWZmWE1lYW5TcXVhcmVkID0gZGlmZlhNZWFuICogZGlmZlhNZWFuO1xuICAgIGNvbnN0IGRpZmZZTWVhblNxdWFyZWQgPSBkaWZmWU1lYW4gKiBkaWZmWU1lYW47XG4gICAgY29uc3QgZGlmZlhZTWVhbiA9IGRpZmZYTWVhbiAqIGRpZmZZTWVhbjtcblxuICAgIHN1bURpZmZYTWVhblNxdWFyZWQgKz0gZGlmZlhNZWFuU3F1YXJlZDtcbiAgICBzdW1EaWZmWU1lYW5TcXVhcmVkICs9IGRpZmZZTWVhblNxdWFyZWQ7XG4gICAgc3VtRGlmZlhZTWVhbiArPSBkaWZmWFlNZWFuO1xuICB9XG5cbiAgLy8gaG9yaXpvbnRhbCBsaW5lLCBhbGwgeSBvbiBzYW1lIGxpbmVcbiAgaWYgKHN1bURpZmZZTWVhblNxdWFyZWQgPT09IDApXG4gICAgcmV0dXJuIDA7XG5cbiAgLy8gUGVhcnNvbiBjb3JyZWxhdGlvbiBjb2VmZmljaWVudDpcbiAgLy8gY2YuIGh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9MlNDZzhLdWgwdEVcbiAgLy9cbiAgLy8gICAgICAgICAgICAgICAgIOKIkSBbICh4IC0geE1lYW4pKHkgLSB5TWVhbikgXVxuICAvLyByID0gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vICAgICBzcXJ0KCDiiJEgWyBwb3coKHggLSB4TWVhbiksIDIpLCBwb3coKHkgLSB5TWVhbiksIDIpIF0gKVxuICAvL1xuICAvL1xuICBjb25zdCByID0gc3VtRGlmZlhZTWVhbiAvIE1hdGguc3FydChzdW1EaWZmWE1lYW5TcXVhcmVkICogc3VtRGlmZllNZWFuU3F1YXJlZCk7XG5cbiAgLy8gdGhlbiB3ZSBoYXZlOlxuICAvLyBjZi4gaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1HaHJ4Z2JRbkVFVVxuICAvL1xuICAvLyB5ID0gYSArIGJ4XG4gIC8vIHdoZXJlOlxuICAvLyAgICAgICAgIFN5XG4gIC8vIGIgPSByICogLS1cbiAgLy8gICAgICAgICBTeFxuICAvL1xuICAvLyBhID0geU1lYW4gLSBiICogeE1lYW5cbiAgLy9cbiAgLy8gUyBmb3Igc3RhbmRhcmQgZGV2aWF0aW9uXG4gIC8vICAgICAgICAgICAg4oiRIFsgcG93KCh4IC0geE1lYW4pLCAyKSBdXG4gIC8vIFN4ID0gc3FydCggLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAgKVxuICAvLyAgICAgICAgICAgICAgICAgICAgICBOIC0gMVxuICBjb25zdCBTeCA9IE1hdGguc3FydChzdW1EaWZmWE1lYW5TcXVhcmVkIC8gKGxlbmd0aCAtIDEpKTtcbiAgY29uc3QgU3kgPSBNYXRoLnNxcnQoc3VtRGlmZllNZWFuU3F1YXJlZCAvIChsZW5ndGggLSAxKSk7XG4gIGNvbnN0IGIgPSByICogKFN5IC8gU3gpO1xuXG4gIHJldHVybiBiO1xufVxuXG5jb25zdCBkZWZpbml0aW9ucyA9IHtcbiAgc2l6ZToge1xuICAgIHR5cGU6ICdpbnRlZ2VyJyxcbiAgICBtaW46IDIsXG4gICAgbWF4OiArSW5maW5pdHksXG4gICAgZGVmYXVsdDogMyxcbiAgfSxcbiAgdXNlRnJhbWVSYXRlOiB7XG4gICAgdHlwZTogJ2ludGVnZXInLFxuICAgIG1pbjogMCxcbiAgICBtYXg6ICtJbmZpbml0eSxcbiAgICBkZWZhdWx0OiBudWxsLFxuICAgIG51bGxhYmxlOiB0cnVlLFxuICB9LFxufTtcblxuLyoqXG4gKiBSZXR1cm5zIHRoZSBzaW1wbGUgZGVyaXZhdGl2ZSBvZiBzdWNjZXNzaXZlIHZhbHVlIHVzaW5nXG4gKiBzaW1wbGUgbGluZWFyIHJlZ3Jlc3Npb24uXG4gKiBUaGUgY3VycmVudCBpbXBsZW1lbnRhdGlvbiBhc3N1bWVzIGEgZml4ZWQgYGZyYW1lUmF0ZWAgKGBmcmFtZS50aW1lYCBpcyBpZ25vcmVkKVxuICpcbiAqIEJlZm9yZSB0aGUgbW9kdWxlIGlzIGZpbGxlZCwgaXQgb3V0cHV0cyBhIHZhbHVlIG9mIDAuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBPdmVycmlkZSBkZWZhdWx0IHBhcmFtZXRlcnNcbiAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5zaXplPTNdIC0gU2l6ZSBvZiB0aGUgd2luZG93XG4gKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMudXNlRnJhbWVSYXRlPW51bGxdIC0gT3ZlcnJpZGUgc3RyZWFtIGZyYW1lIHJhdGUgZm9yXG4gKiAgdGhlIHJlZ3Jlc3Npb25cbiAqL1xuY2xhc3MgRGVsdGEgZXh0ZW5kcyBCYXNlTGZvIHtcbiAgY29uc3RydWN0b3Iob3B0aW9ucyA9wqB7fSkge1xuICAgIHN1cGVyKGRlZmluaXRpb25zLCBvcHRpb25zKTtcblxuICAgIHRoaXMuYnVmZmVycyA9IG51bGw7XG4gICAgdGhpcy5yaW5nSW5kZXggPSAwO1xuICAgIHRoaXMuZnJhbWVSYXRlID0gbnVsbDtcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBwcm9jZXNzU3RyZWFtUGFyYW1zKHByZXZTdHJlYW1QYXJhbXMpIHtcbiAgICB0aGlzLnByZXBhcmVTdHJlYW1QYXJhbXMocHJldlN0cmVhbVBhcmFtcyk7XG5cbiAgICBjb25zdCBmcmFtZVNpemUgPSB0aGlzLnN0cmVhbVBhcmFtcy5mcmFtZVNpemU7XG4gICAgY29uc3Qgc2l6ZSA9IHRoaXMucGFyYW1zLmdldCgnc2l6ZScpO1xuICAgIGNvbnN0IGJ1ZmZlclNpemUgPSBmcmFtZVNpemUgKiBzaXplO1xuXG4gICAgdGhpcy5idWZmZXJzID0gW107XG4gICAgLy8gY291bnRlciBiZWZvcmUgdGhlIG9wZXJhdG9yIHN0YXJ0cyBvdXRwdXRpbmcgZnJhbWVzXG4gICAgdGhpcy5yaW5nSW5kZXggPSAwO1xuICAgIHRoaXMuZnJhbWVSYXRlID0gdGhpcy5wYXJhbXMuZ2V0KCd1c2VGcmFtZVJhdGUnKSA9PT0gbnVsbCA/XG4gICAgICB0aGlzLnN0cmVhbVBhcmFtcy5mcmFtZVJhdGUgOlxuICAgICAgdGhpcy5wYXJhbXMuZ2V0KCd1c2VGcmFtZVJhdGUnKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVTaXplOyBpKyspXG4gICAgICB0aGlzLmJ1ZmZlcnNbaV0gPSBuZXcgRmxvYXQzMkFycmF5KHNpemUpO1xuXG4gICAgdGhpcy5wcm9wYWdhdGVTdHJlYW1QYXJhbXMoKTtcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICByZXNldFN0cmVhbSgpIHtcbiAgICBzdXBlci5yZXNldFN0cmVhbSgpO1xuXG4gICAgY29uc3QgZnJhbWVTaXplID0gdGhpcy5zdHJlYW1QYXJhbXMuZnJhbWVTaXplO1xuICAgIGNvbnN0IHNpemUgPSB0aGlzLnBhcmFtcy5nZXQoJ3NpemUnKTtcbiAgICBjb25zdCBidWZmZXJzID0gdGhpcy5idWZmZXJzO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZVNpemU7IGkrKykge1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzaXplOyBqKyspXG4gICAgICAgIGJ1ZmZlcnNbaV1bal0gPSAwO1xuICAgIH1cblxuICAgIHRoaXMucmluZ0luZGV4ID0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3N1bWUgYSBzdHJlYW0gb2YgdmVjdG9yIGF0IGEgZml4ZWQgYGZyYW1lUmF0ZWAuXG4gICAqL1xuICBpbnB1dFZlY3RvcihkYXRhKSB7XG4gICAgY29uc3Qgc2l6ZSA9IHRoaXMucGFyYW1zLmdldCgnc2l6ZScpO1xuICAgIGNvbnN0IG91dERhdGEgPSB0aGlzLmZyYW1lLmRhdGE7XG4gICAgY29uc3QgZnJhbWVTaXplID0gdGhpcy5zdHJlYW1QYXJhbXMuZnJhbWVTaXplO1xuICAgIC8vIGNvbnN0IGZyYW1lUmF0ZSA9IHRoaXMuc3RyZWFtUGFyYW1zLmZyYW1lUmF0ZTtcbiAgICBjb25zdCBidWZmZXJzID0gdGhpcy5idWZmZXJzO1xuICAgIGNvbnN0IGR0ID0gMSAvIHRoaXMuZnJhbWVSYXRlO1xuXG4gICAgLy8gY29uc29sZS5sb2coZHQpO1xuXG4gICAgaWYgKHRoaXMucmluZ0luZGV4IDwgc2l6ZSlcbiAgICAgIHRoaXMucmluZ0luZGV4ICs9IDE7XG5cbiAgICAvLyBjb3B5IGluY29tbWluZyBkYXRhIGludG8gYnVmZmVyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZVNpemU7IGkrKykge1xuICAgICAgY29uc3QgYnVmZmVyID0gYnVmZmVyc1tpXTtcblxuICAgICAgLy8gd2UgbmVlZCB0byBrZWVwIHRoZSBvcmRlciBvZiB0aGUgaW5jb21taW5nIGZyYW1lc1xuICAgICAgLy8gc28gd2UgaGF2ZSB0byBzaGlmdCBhbGwgdGhlIHZhbHVlcyBpbiB0aGUgYnVmZmVyc1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzaXplOyBqKyspXG4gICAgICAgIGJ1ZmZlcltqIC0gMV0gPSBidWZmZXJbal07XG5cbiAgICAgIGJ1ZmZlcltzaXplIC0gMV0gPSBkYXRhW2ldO1xuXG4gICAgICBpZiAodGhpcy5yaW5nSW5kZXggPj0gc2l6ZSlcbiAgICAgICAgb3V0RGF0YVtpXSA9IHNpbXBsZUxpbmVhclJlZ3Jlc3Npb24oYnVmZmVyLCBkdCk7XG4gICAgICBlbHNlXG4gICAgICAgIG91dERhdGFbaV0gPSAwO1xuICAgIH1cblxuICAgIHJldHVybiBvdXREYXRhO1xuICB9XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIHByb2Nlc3NWZWN0b3IoZnJhbWUpIHtcbiAgICB0aGlzLmZyYW1lLmRhdGEgPSB0aGlzLmlucHV0VmVjdG9yKGZyYW1lLmRhdGEpO1xuICAgIC8vIGNlbnRlciB0aW1lIGFjY29yZGluZyB0byBkZWx0YSBzaXplXG4gICAgY29uc3Qgc2l6ZSA9IHRoaXMucGFyYW1zLmdldCgnc2l6ZScpO1xuICAgIGNvbnN0IGZyYW1lUmF0ZSA9IHRoaXMuc3RyZWFtUGFyYW1zLmZyYW1lUmF0ZTtcbiAgICB0aGlzLmZyYW1lLnRpbWUgLT0gMC41ICogKHNpemUgLSAxKSAvIGZyYW1lUmF0ZTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBEZWx0YTtcblxuXG5cblxuXG4iXX0=