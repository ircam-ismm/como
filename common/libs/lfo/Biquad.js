"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _BaseLfo = _interopRequireDefault(require("./BaseLfo.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const sin = Math.sin;
const cos = Math.cos;
const sqrt = Math.sqrt;
const pow = Math.pow;

const _2PI = Math.PI * 2; // plot (from http://www.earlevel.com/scripts/widgets/20131013/biquads2.js)
// var len = 512;
// var magPlot = [];
// for (var idx = 0; idx < len; idx++) {
//   var w;
//   if (plotType == "linear")
//     w = idx / (len - 1) * Math.PI;  // 0 to pi, linear scale
//   else
//     w = Math.exp(Math.log(1 / 0.001) * idx / (len - 1)) * 0.001 * Math.PI;  // 0.001 to 1, times pi, log scale
//   var phi = Math.pow(Math.sin(w/2), 2);
//   var y = Math.log(Math.pow(a0+a1+a2, 2) - 4*(a0*a1 + 4*a0*a2 + a1*a2)*phi + 16*a0*a2*phi*phi) - Math.log(Math.pow(1+b1+b2, 2) - 4*(b1 + 4*b2 + b1*b2)*phi + 16*b2*phi*phi);
//   y = y * 10 / Math.LN10
//   if (y == -Infinity)
//     y = -200;
//   if (plotType == "linear")
//     magPlot.push([idx / (len - 1) * Fs / 2, y]);
//   else
//     magPlot.push([idx / (len - 1) / 2, y]);
//   if (idx == 0)
//     minVal = maxVal = y;
//   else if (y < minVal)
//     minVal = y;
//   else if (y > maxVal)
//     maxVal = y;
// }


const definitions = {
  type: {
    type: 'enum',
    default: 'lowpass',
    list: ['lowpass', 'highpass', 'bandpass_constant_skirt', 'bandpass', 'bandpass_constant_peak', 'notch', 'allpass', 'peaking', 'lowshelf', 'highshelf'],
    metas: {
      kind: 'dyanmic'
    }
  },
  f0: {
    type: 'float',
    default: 1,
    metas: {
      kind: 'dyanmic'
    }
  },
  gain: {
    type: 'float',
    default: 1,
    min: 0,
    metas: {
      kind: 'dyanmic'
    }
  },
  q: {
    type: 'float',
    default: 1,
    min: 0.001,
    // PIPO_BIQUAD_MIN_Q
    // max: 1,
    metas: {
      kind: 'dyanmic'
    }
  } // bandwidth: {
  //   type: 'float',
  //   default: null,
  //   nullable: true,
  //   metas: { kind: 'dyanmic' },
  // },

};
/**
 * Biquad filter (Direct form I). If input is of type `vector` the filter is
 * applied on each dimension i parallel.
 *
 * Based on the ["Cookbook formulae for audio EQ biquad filter coefficients"](http://www.musicdsp.org/files/Audio-EQ-Cookbook.txt)
 * by Robert Bristow-Johnson.
 *
 * @memberof module:common.operator
 *
 * @param {Object} options - Override default values.
 * @param {String} [options.type='lowpass'] - Type of the filter. Available
 *  filters: 'lowpass', 'highpass', 'bandpass_constant_skirt', 'bandpass_constant_peak'
 *  (alias 'bandpass'), 'notch', 'allpass', 'peaking', 'lowshelf', 'highshelf'.
 * @param {Number} [options.f0=1] - Cutoff or center frequency of the filter
 *  according to its type.
 * @param {Number} [options.gain=1] - Gain of the filter (in dB).
 * @param {Number} [options.q=1] - Quality factor of the filter.
 *
 * @example
 * import * as lfo from 'waves-lfo/client';
 *
 * const audioInBuffer = new lfo.source.AudioInBuffer({
 *   audioBuffer: buffer,
 * });
 *
 * const biquad = new lfo.operator.Biquad({
 *   type: 'lowpass',
 *   f0: 2000,
 *   gain: 3,
 *   q: 12,
 * });
 *
 * const spectrumDisplay = new lfo.sink.SpectrumDisplay({
 *   canvas: '#spectrum',
 * });
 *
 * audioInBuffer.connect(biquad);
 * biquad.connect(spectrumDisplay);
 *
 * audioInBuffer.start();
 */

class Biquad extends _BaseLfo.default {
  constructor(options = {}) {
    super(definitions, options);
  }

  onParamUpdate(name, value, metas) {
    this._calculateCoefs();
  }

  _calculateCoefs() {
    const sampleRate = this.streamParams.sourceSampleRate;
    const frameType = this.streamParams.frameType;
    const frameSize = this.streamParams.frameSize;
    const type = this.params.get('type');
    const f0 = this.params.get('f0');
    const gain = this.params.get('gain');
    const q = this.params.get('q'); // const bandwidth = this.params.get('bandwidth');

    const bandwidth = null;
    let b0 = 0,
        b1 = 0,
        b2 = 0,
        a0 = 0,
        a1 = 0,
        a2 = 0;
    const A = pow(10, gain / 40);
    const w0 = _2PI * f0 / sampleRate;
    const cosW0 = cos(w0);
    const sinW0 = sin(w0);
    let alpha; // depend of the filter type

    let _2RootAAlpha; // intermediate value for lowshelf and highshelf


    switch (type) {
      // H(s) = 1 / (s^2 + s/Q + 1)
      case 'lowpass':
        alpha = sinW0 / (2 * q);
        b0 = (1 - cosW0) / 2;
        b1 = 1 - cosW0;
        b2 = b0;
        a0 = 1 + alpha;
        a1 = -2 * cosW0;
        a2 = 1 - alpha;
        break;
      // H(s) = s^2 / (s^2 + s/Q + 1)

      case 'highpass':
        alpha = sinW0 / (2 * q);
        b0 = (1 + cosW0) / 2;
        b1 = -(1 + cosW0);
        b2 = b0;
        a0 = 1 + alpha;
        a1 = -2 * cosW0;
        a2 = 1 - alpha;
        break;
      // H(s) = s / (s^2 + s/Q + 1)  (constant skirt gain, peak gain = Q)

      case 'bandpass_constant_skirt':
        if (bandwidth) {// sin(w0)*sinh( ln(2)/2 * BW * w0/sin(w0) )           (case: BW)
        } else {
          alpha = sinW0 / (2 * q);
        }

        b0 = sinW0 / 2;
        b1 = 0;
        b2 = -b0;
        a0 = 1 + alpha;
        a1 = -2 * cosW0;
        a2 = 1 - alpha;
        break;
      // H(s) = (s/Q) / (s^2 + s/Q + 1)      (constant 0 dB peak gain)

      case 'bandpass': // looks like what is gnerally considered as a bandpass

      case 'bandpass_constant_peak':
        if (bandwidth) {// sin(w0)*sinh( ln(2)/2 * BW * w0/sin(w0) )           (case: BW)
        } else {
          alpha = sinW0 / (2 * q);
        }

        b0 = alpha;
        b1 = 0;
        b2 = -alpha;
        a0 = 1 + alpha;
        a1 = -2 * cosW0;
        a2 = 1 - alpha;
        break;
      // H(s) = (s^2 + 1) / (s^2 + s/Q + 1)

      case 'notch':
        alpha = sinW0 / (2 * q);
        b0 = 1;
        b1 = -2 * cosW0;
        b2 = 1;
        a0 = 1 + alpha;
        a1 = b1;
        a2 = 1 - alpha;
        break;
      // H(s) = (s^2 - s/Q + 1) / (s^2 + s/Q + 1)

      case 'allpass':
        alpha = sinW0 / (2 * q);
        b0 = 1 - alpha;
        b1 = -2 * cosW0;
        b2 = 1 + alpha;
        a0 = b2;
        a1 = b1;
        a2 = b0;
        break;
      // H(s) = (s^2 + s*(A/Q) + 1) / (s^2 + s/(A*Q) + 1)

      case 'peaking':
        if (bandwidth) {// sin(w0)*sinh( ln(2)/2 * BW * w0/sin(w0) )           (case: BW)
        } else {
          alpha = sinW0 / (2 * q);
        }

        b0 = 1 + alpha * A;
        b1 = -2 * cosW0;
        b2 = 1 - alpha * A;
        a0 = 1 + alpha / A;
        a1 = b1;
        a2 = 1 - alpha / A;
        break;
      // H(s) = A * (s^2 + (sqrt(A)/Q)*s + A)/(A*s^2 + (sqrt(A)/Q)*s + 1)

      case 'lowshelf':
        alpha = sinW0 / (2 * q);
        _2RootAAlpha = 2 * sqrt(A) * alpha;
        b0 = A * (A + 1 - (A - 1) * cosW0 + _2RootAAlpha);
        b1 = 2 * A * (A - 1 - (A + 1) * cosW0);
        b2 = A * (A + 1 - (A - 1) * cosW0 - _2RootAAlpha);
        a0 = A + 1 + (A - 1) * cosW0 + _2RootAAlpha;
        a1 = -2 * (A - 1 + (A + 1) * cosW0);
        a2 = A + 1 + (A - 1) * cosW0 - _2RootAAlpha;
        break;
      // H(s) = A * (A*s^2 + (sqrt(A)/Q)*s + 1)/(s^2 + (sqrt(A)/Q)*s + A)

      case 'highshelf':
        alpha = sinW0 / (2 * q);
        _2RootAAlpha = 2 * sqrt(A) * alpha;
        b0 = A * (A + 1 + (A - 1) * cosW0 + _2RootAAlpha);
        b1 = -2 * A * (A - 1 + (A + 1) * cosW0);
        b2 = A * (A + 1 + (A - 1) * cosW0 - _2RootAAlpha);
        a0 = A + 1 - (A - 1) * cosW0 + _2RootAAlpha;
        a1 = 2 * (A - 1 - (A + 1) * cosW0);
        a2 = A + 1 - (A - 1) * cosW0 - _2RootAAlpha;
        break;
    }

    this.coefs = {
      b0: b0 / a0,
      b1: b1 / a0,
      b2: b2 / a0,
      a1: a1 / a0,
      a2: a2 / a0
    }; // reset state

    if (frameType === 'signal') {
      this.state = {
        x1: 0,
        x2: 0,
        y1: 0,
        y2: 0
      };
    } else {
      this.state = {
        x1: new Float32Array(frameSize),
        x2: new Float32Array(frameSize),
        y1: new Float32Array(frameSize),
        y2: new Float32Array(frameSize)
      };
    }
  }
  /** @private */


  processStreamParams(prevStreamParams) {
    this.prepareStreamParams(prevStreamParams); // if no `sampleRate` or `sampleRate` is 0 we shall halt!

    const sampleRate = this.streamParams.sourceSampleRate;
    if (!sampleRate || sampleRate <= 0) throw new Error('Invalid sampleRate value (0) for biquad');

    this._calculateCoefs();

    this.propagateStreamParams();
  }
  /** @private */


  processVector(frame) {
    const frameSize = this.streamParams.frameSize;
    const outData = this.frame.data;
    const inData = frame.data;
    const state = this.state;
    const coefs = this.coefs;

    for (let i = 0; i < frameSize; i++) {
      const x = inData[i];
      const y = coefs.b0 * x + coefs.b1 * state.x1[i] + coefs.b2 * state.x2[i] - coefs.a1 * state.y1[i] - coefs.a2 * state.y2[i];
      outData[i] = y; // update states

      state.x2[i] = state.x1[i];
      state.x1[i] = x;
      state.y2[i] = state.y1[i];
      state.y1[i] = y;
    }
  }
  /** @private */


  processSignal(frame) {
    const frameSize = this.streamParams.frameSize;
    const outData = this.frame.data;
    const inData = frame.data;
    const state = this.state;
    const coefs = this.coefs;

    for (let i = 0; i < frameSize; i++) {
      const x = inData[i];
      const y = coefs.b0 * x + coefs.b1 * state.x1 + coefs.b2 * state.x2 - coefs.a1 * state.y1 - coefs.a2 * state.y2;
      outData[i] = y; // update states

      state.x2 = state.x1;
      state.x1 = x;
      state.y2 = state.y1;
      state.y1 = y;
    }
  }

}

var _default = Biquad;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vbGlicy9sZm8vQmlxdWFkLmpzIl0sIm5hbWVzIjpbInNpbiIsIk1hdGgiLCJjb3MiLCJzcXJ0IiwicG93IiwiXzJQSSIsIlBJIiwiZGVmaW5pdGlvbnMiLCJ0eXBlIiwiZGVmYXVsdCIsImxpc3QiLCJtZXRhcyIsImtpbmQiLCJmMCIsImdhaW4iLCJtaW4iLCJxIiwiQmlxdWFkIiwiQmFzZUxmbyIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsIm9uUGFyYW1VcGRhdGUiLCJuYW1lIiwidmFsdWUiLCJfY2FsY3VsYXRlQ29lZnMiLCJzYW1wbGVSYXRlIiwic3RyZWFtUGFyYW1zIiwic291cmNlU2FtcGxlUmF0ZSIsImZyYW1lVHlwZSIsImZyYW1lU2l6ZSIsInBhcmFtcyIsImdldCIsImJhbmR3aWR0aCIsImIwIiwiYjEiLCJiMiIsImEwIiwiYTEiLCJhMiIsIkEiLCJ3MCIsImNvc1cwIiwic2luVzAiLCJhbHBoYSIsIl8yUm9vdEFBbHBoYSIsImNvZWZzIiwic3RhdGUiLCJ4MSIsIngyIiwieTEiLCJ5MiIsIkZsb2F0MzJBcnJheSIsInByb2Nlc3NTdHJlYW1QYXJhbXMiLCJwcmV2U3RyZWFtUGFyYW1zIiwicHJlcGFyZVN0cmVhbVBhcmFtcyIsIkVycm9yIiwicHJvcGFnYXRlU3RyZWFtUGFyYW1zIiwicHJvY2Vzc1ZlY3RvciIsImZyYW1lIiwib3V0RGF0YSIsImRhdGEiLCJpbkRhdGEiLCJpIiwieCIsInkiLCJwcm9jZXNzU2lnbmFsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUdDLElBQUksQ0FBQ0QsR0FBakI7QUFDQSxNQUFNRSxHQUFHLEdBQUdELElBQUksQ0FBQ0MsR0FBakI7QUFDQSxNQUFNQyxJQUFJLEdBQUdGLElBQUksQ0FBQ0UsSUFBbEI7QUFDQSxNQUFNQyxHQUFHLEdBQUdILElBQUksQ0FBQ0csR0FBakI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHSixJQUFJLENB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RUFBZ0JBLENBQUMsR0FBR2pDLFNBQXBCLEVBQStCaUMsQ0FBQyxFQUFoQyxFQUFvQztBQUNsQyxZQUFNQyxDQUFDLEdBQUdGLE1BQU0sQ0FBQ0MsQ0FBRCxDQUFoQjtBQUNBLFlBQU1FLENBQUMsR0FBR25CLEtBQUssQ0FBQ1osRUFBTixHQUFXOEIsQ0FBWCxHQUNBbEIsS0FBSyxDQUFDWCxFQUFOLEdBQVdZLEtBQUssQ0FBQ0MsRUFEakIsR0FDc0JGLEtBQUssQ0FBQ1YsRUFBTixHQUFXVyxLQUFLLENBQUNFLEVBRHZDLEdBRUFILEtBQUssQ0FBQ1IsRUFBTixHQUFXUyxLQUFLLENBQUNHLEVBRmpCLEdBRXNCSixLQUFLLENBQUNQLEVBQU4sR0FBV1EsS0FBSyxDQUFDSSxFQUZqRDtBQUlBUyxNQUFBQSxPQUFPLENBQUNHLENBQUQsQ0FBUCxHQUFhRSxDQUFiLENBTmtDLENBUWxDOztBQUNBbEIsTUFBQUEsS0FBSyxDQUFDRSxFQUFOLEdBQVdGLEtBQUssQ0FBQ0MsRUFBakI7QUFDQUQsTUFBQUEsS0FBSyxDQUFDQyxFQUFOLEdBQVdnQixDQUFYO0FBQ0FqQixNQUFBQSxLQUFLLENBQUNJLEVBQU4sR0FBV0osS0FBSyxDQUFDRyxFQUFqQjtBQUNBSCxNQUFBQSxLQUFLLENBQUNHLEVBQU4sR0FBV2UsQ0FBWDtBQUNEO0FBQ0Y7O0FBak8wQjs7ZUFvT2QvQyxNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJhc2VMZm8gZnJvbSAnLi9CYXNlTGZvLmpzJztcblxuY29uc3Qgc2luID0gTWF0aC5zaW47XG5jb25zdCBjb3MgPSBNYXRoLmNvcztcbmNvbnN0IHNxcnQgPSBNYXRoLnNxcnQ7XG5jb25zdCBwb3cgPSBNYXRoLnBvdztcbmNvbnN0IF8yUEkgPSBNYXRoLlBJICogMjtcblxuLy8gcGxvdCAoZnJvbSBodHRwOi8vd3d3LmVhcmxldmVsLmNvbS9zY3JpcHRzL3dpZGdldHMvMjAxMzEwMTMvYmlxdWFkczIuanMpXG4vLyB2YXIgbGVuID0gNTEyO1xuLy8gdmFyIG1hZ1Bsb3QgPSBbXTtcbi8vIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGxlbjsgaWR4KyspIHtcbi8vICAgdmFyIHc7XG4vLyAgIGlmIChwbG90VHlwZSA9PSBcImxpbmVhclwiKVxuLy8gICAgIHcgPSBpZHggLyAobGVuIC0gMSkgKiBNYXRoLlBJOyAgLy8gMCB0byBwaSwgbGluZWFyIHNjYWxlXG4vLyAgIGVsc2Vcbi8vICAgICB3ID0gTWF0aC5leHAoTWF0aC5sb2coMSAvIDAuMDAxKSAqIGlkeCAvIChsZW4gLSAxKSkgKiAwLjAwMSAqIE1hdGguUEk7ICAvLyAwLjAwMSB0byAxLCB0aW1lcyBwaSwgbG9nIHNjYWxlXG5cbi8vICAgdmFyIHBoaSA9IE1hdGgucG93KE1hdGguc2luKHcvMiksIDIpO1xuLy8gICB2YXIgeSA9IE1hdGgubG9nKE1hdGgucG93KGEwK2ExK2EyLCAyKSAtIDQqKGEwKmExICsgNCphMCphMiArIGExKmEyKSpwaGkgKyAxNiphMCphMipwaGkqcGhpKSAtIE1hdGgubG9nKE1hdGgucG93KDErYjErYjIsIDIpIC0gNCooYjEgKyA0KmIyICsgYjEqYjIpKnBoaSArIDE2KmIyKnBoaSpwaGkpO1xuLy8gICB5ID0geSAqIDEwIC8gTWF0aC5MTjEwXG4vLyAgIGlmICh5ID09IC1JbmZpbml0eSlcbi8vICAgICB5ID0gLTIwMDtcblxuLy8gICBpZiAocGxvdFR5cGUgPT0gXCJsaW5lYXJcIilcbi8vICAgICBtYWdQbG90LnB1c2goW2lkeCAvIChsZW4gLSAxKSAqIEZzIC8gMiwgeV0pO1xuLy8gICBlbHNlXG4vLyAgICAgbWFnUGxvdC5wdXNoKFtpZHggLyAobGVuIC0gMSkgLyAyLCB5XSk7XG5cbi8vICAgaWYgKGlkeCA9PSAwKVxuLy8gICAgIG1pblZhbCA9IG1heFZhbCA9IHk7XG4vLyAgIGVsc2UgaWYgKHkgPCBtaW5WYWwpXG4vLyAgICAgbWluVmFsID0geTtcbi8vICAgZWxzZSBpZiAoeSA+IG1heFZhbClcbi8vICAgICBtYXhWYWwgPSB5O1xuLy8gfVxuXG5jb25zdCBkZWZpbml0aW9ucyA9IHtcbiAgdHlwZToge1xuICAgIHR5cGU6ICdlbnVtJyxcbiAgICBkZWZhdWx0OiAnbG93cGFzcycsXG4gICAgbGlzdDogW1xuICAgICAgJ2xvd3Bhc3MnLFxuICAgICAgJ2hpZ2hwYXNzJyxcbiAgICAgICdiYW5kcGFzc19jb25zdGFudF9za2lydCcsXG4gICAgICAnYmFuZHBhc3MnLFxuICAgICAgJ2JhbmRwYXNzX2NvbnN0YW50X3BlYWsnLFxuICAgICAgJ25vdGNoJyxcbiAgICAgICdhbGxwYXNzJyxcbiAgICAgICdwZWFraW5nJyxcbiAgICAgICdsb3dzaGVsZicsXG4gICAgICAnaGlnaHNoZWxmJyxcbiAgICBdLFxuICAgIG1ldGFzOiB7IGtpbmQ6ICdkeWFubWljJyB9LFxuICB9LFxuICBmMDoge1xuICAgIHR5cGU6ICdmbG9hdCcsXG4gICAgZGVmYXVsdDogMSxcbiAgICBtZXRhczogeyBraW5kOiAnZHlhbm1pYycgfSxcbiAgfSxcbiAgZ2Fpbjoge1xuICAgIHR5cGU6ICdmbG9hdCcsXG4gICAgZGVmYXVsdDogMSxcbiAgICBtaW46IDAsXG4gICAgbWV0YXM6IHsga2luZDogJ2R5YW5taWMnIH0sXG4gIH0sXG4gIHE6IHtcbiAgICB0eXBlOiAnZmxvYXQnLFxuICAgIGRlZmF1bHQ6IDEsXG4gICAgbWluOiAwLjAwMSwgLy8gUElQT19CSVFVQURfTUlOX1FcbiAgICAvLyBtYXg6IDEsXG4gICAgbWV0YXM6IHsga2luZDogJ2R5YW5taWMnIH0sXG4gIH0sXG4gIC8vIGJhbmR3aWR0aDoge1xuICAvLyAgIHR5cGU6ICdmbG9hdCcsXG4gIC8vICAgZGVmYXVsdDogbnVsbCxcbiAgLy8gICBudWxsYWJsZTogdHJ1ZSxcbiAgLy8gICBtZXRhczogeyBraW5kOiAnZHlhbm1pYycgfSxcbiAgLy8gfSxcbn1cblxuXG4vKipcbiAqIEJpcXVhZCBmaWx0ZXIgKERpcmVjdCBmb3JtIEkpLiBJZiBpbnB1dCBpcyBvZiB0eXBlIGB2ZWN0b3JgIHRoZSBmaWx0ZXIgaXNcbiAqIGFwcGxpZWQgb24gZWFjaCBkaW1lbnNpb24gaSBwYXJhbGxlbC5cbiAqXG4gKiBCYXNlZCBvbiB0aGUgW1wiQ29va2Jvb2sgZm9ybXVsYWUgZm9yIGF1ZGlvIEVRIGJpcXVhZCBmaWx0ZXIgY29lZmZpY2llbnRzXCJdKGh0dHA6Ly93d3cubXVzaWNkc3Aub3JnL2ZpbGVzL0F1ZGlvLUVRLUNvb2tib29rLnR4dClcbiAqIGJ5IFJvYmVydCBCcmlzdG93LUpvaG5zb24uXG4gKlxuICogQG1lbWJlcm9mIG1vZHVsZTpjb21tb24ub3BlcmF0b3JcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIE92ZXJyaWRlIGRlZmF1bHQgdmFsdWVzLlxuICogQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLnR5cGU9J2xvd3Bhc3MnXSAtIFR5cGUgb2YgdGhlIGZpbHRlci4gQXZhaWxhYmxlXG4gKiAgZmlsdGVyczogJ2xvd3Bhc3MnLCAnaGlnaHBhc3MnLCAnYmFuZHBhc3NfY29uc3RhbnRfc2tpcnQnLCAnYmFuZHBhc3NfY29uc3RhbnRfcGVhaydcbiAqICAoYWxpYXMgJ2JhbmRwYXNzJyksICdub3RjaCcsICdhbGxwYXNzJywgJ3BlYWtpbmcnLCAnbG93c2hlbGYnLCAnaGlnaHNoZWxmJy5cbiAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5mMD0xXSAtIEN1dG9mZiBvciBjZW50ZXIgZnJlcXVlbmN5IG9mIHRoZSBmaWx0ZXJcbiAqICBhY2NvcmRpbmcgdG8gaXRzIHR5cGUuXG4gKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMuZ2Fpbj0xXSAtIEdhaW4gb2YgdGhlIGZpbHRlciAoaW4gZEIpLlxuICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLnE9MV0gLSBRdWFsaXR5IGZhY3RvciBvZiB0aGUgZmlsdGVyLlxuICpcbiAqIEBleGFtcGxlXG4gKiBpbXBvcnQgKiBhcyBsZm8gZnJvbSAnd2F2ZXMtbGZvL2NsaWVudCc7XG4gKlxuICogY29uc3QgYXVkaW9JbkJ1ZmZlciA9IG5ldyBsZm8uc291cmNlLkF1ZGlvSW5CdWZmZXIoe1xuICogICBhdWRpb0J1ZmZlcjogYnVmZmVyLFxuICogfSk7XG4gKlxuICogY29uc3QgYmlxdWFkID0gbmV3IGxmby5vcGVyYXRvci5CaXF1YWQoe1xuICogICB0eXBlOiAnbG93cGFzcycsXG4gKiAgIGYwOiAyMDAwLFxuICogICBnYWluOiAzLFxuICogICBxOiAxMixcbiAqIH0pO1xuICpcbiAqIGNvbnN0IHNwZWN0cnVtRGlzcGxheSA9IG5ldyBsZm8uc2luay5TcGVjdHJ1bURpc3BsYXkoe1xuICogICBjYW52YXM6ICcjc3BlY3RydW0nLFxuICogfSk7XG4gKlxuICogYXVkaW9JbkJ1ZmZlci5jb25uZWN0KGJpcXVhZCk7XG4gKiBiaXF1YWQuY29ubmVjdChzcGVjdHJ1bURpc3BsYXkpO1xuICpcbiAqIGF1ZGlvSW5CdWZmZXIuc3RhcnQoKTtcbiAqL1xuY2xhc3MgQmlxdWFkIGV4dGVuZHMgQmFzZUxmbyB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkge1xuICAgIHN1cGVyKGRlZmluaXRpb25zLCBvcHRpb25zKTtcbiAgfVxuXG4gIG9uUGFyYW1VcGRhdGUobmFtZSwgdmFsdWUsIG1ldGFzKSB7XG4gICAgdGhpcy5fY2FsY3VsYXRlQ29lZnMoKTtcbiAgfVxuXG4gIF9jYWxjdWxhdGVDb2VmcygpIHtcbiAgICBjb25zdCBzYW1wbGVSYXRlID0gdGhpcy5zdHJlYW1QYXJhbXMuc291cmNlU2FtcGxlUmF0ZTtcbiAgICBjb25zdCBmcmFtZVR5cGUgPSB0aGlzLnN0cmVhbVBhcmFtcy5mcmFtZVR5cGU7XG4gICAgY29uc3QgZnJhbWVTaXplID0gdGhpcy5zdHJlYW1QYXJhbXMuZnJhbWVTaXplO1xuXG4gICAgY29uc3QgdHlwZSA9IHRoaXMucGFyYW1zLmdldCgndHlwZScpO1xuICAgIGNvbnN0IGYwID0gdGhpcy5wYXJhbXMuZ2V0KCdmMCcpO1xuICAgIGNvbnN0IGdhaW4gPSB0aGlzLnBhcmFtcy5nZXQoJ2dhaW4nKTtcbiAgICBjb25zdCBxID0gdGhpcy5wYXJhbXMuZ2V0KCdxJyk7XG4gICAgLy8gY29uc3QgYmFuZHdpZHRoID0gdGhpcy5wYXJhbXMuZ2V0KCdiYW5kd2lkdGgnKTtcbiAgICBjb25zdCBiYW5kd2lkdGggPSBudWxsO1xuXG4gICAgbGV0IGIwID0gMCwgYjEgPSAwLCBiMiA9IDAsIGEwID0gMCwgYTEgPSAwLCBhMiA9IDA7XG5cbiAgICBjb25zdCBBID0gcG93KDEwLCBnYWluIC8gNDApO1xuICAgIGNvbnN0IHcwID0gXzJQSSAqIGYwIC8gc2FtcGxlUmF0ZTtcbiAgICBjb25zdCBjb3NXMCA9IGNvcyh3MCk7XG4gICAgY29uc3Qgc2luVzAgPSBzaW4odzApO1xuICAgIGxldCBhbHBoYTsgLy8gZGVwZW5kIG9mIHRoZSBmaWx0ZXIgdHlwZVxuICAgIGxldCBfMlJvb3RBQWxwaGE7IC8vIGludGVybWVkaWF0ZSB2YWx1ZSBmb3IgbG93c2hlbGYgYW5kIGhpZ2hzaGVsZlxuXG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAvLyBIKHMpID0gMSAvIChzXjIgKyBzL1EgKyAxKVxuICAgICAgY2FzZSAnbG93cGFzcyc6XG4gICAgICAgIGFscGhhID0gc2luVzAgLyAoMiAqIHEpO1xuICAgICAgICBiMCA9ICgxIC0gY29zVzApIC8gMjtcbiAgICAgICAgYjEgPSAxIC0gY29zVzA7XG4gICAgICAgIGIyID0gYjA7XG4gICAgICAgIGEwID0gMSArIGFscGhhO1xuICAgICAgICBhMSA9IC0yICogY29zVzA7XG4gICAgICAgIGEyID0gMSAtYWxwaGE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgLy8gSChzKSA9IHNeMiAvIChzXjIgKyBzL1EgKyAxKVxuICAgICAgY2FzZSAnaGlnaHBhc3MnOlxuICAgICAgICBhbHBoYSA9IHNpblcwIC8gKDIgKiBxKTtcbiAgICAgICAgYjAgPSAoMSArIGNvc1cwKSAvIDI7XG4gICAgICAgIGIxID0gLSAoMSArIGNvc1cwKVxuICAgICAgICBiMiA9IGIwO1xuICAgICAgICBhMCA9IDEgKyBhbHBoYTtcbiAgICAgICAgYTEgPSAtMiAqIGNvc1cwO1xuICAgICAgICBhMiA9IDEgLSBhbHBoYTtcbiAgICAgICAgYnJlYWs7XG4gICAgICAvLyBIKHMpID0gcyAvIChzXjIgKyBzL1EgKyAxKSAgKGNvbnN0YW50IHNraXJ0IGdhaW4sIHBlYWsgZ2FpbiA9IFEpXG4gICAgICBjYXNlICdiYW5kcGFzc19jb25zdGFudF9za2lydCc6XG4gICAgICAgIGlmIChiYW5kd2lkdGgpIHtcbiAgICAgICAgICAvLyBzaW4odzApKnNpbmgoIGxuKDIpLzIgKiBCVyAqIHcwL3Npbih3MCkgKSAgICAgICAgICAgKGNhc2U6IEJXKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFscGhhID0gc2luVzAgLyAoMiAqIHEpO1xuICAgICAgICB9XG5cbiAgICAgICAgYjAgPSBzaW5XMCAvIDI7XG4gICAgICAgIGIxID0gMDtcbiAgICAgICAgYjIgPSAtYjA7XG4gICAgICAgIGEwID0gMSArIGFscGhhO1xuICAgICAgICBhMSA9IC0yICogY29zVzA7XG4gICAgICAgIGEyID0gMSAtIGFscGhhO1xuICAgICAgICBicmVhaztcbiAgICAgIC8vIEgocykgPSAocy9RKSAvIChzXjIgKyBzL1EgKyAxKSAgICAgIChjb25zdGFudCAwIGRCIHBlYWsgZ2FpbilcbiAgICAgIGNhc2UgJ2JhbmRwYXNzJzogLy8gbG9va3MgbGlrZSB3aGF0IGlzIGduZXJhbGx5IGNvbnNpZGVyZWQgYXMgYSBiYW5kcGFzc1xuICAgICAgY2FzZSAnYmFuZHBhc3NfY29uc3RhbnRfcGVhayc6XG4gICAgICAgIGlmIChiYW5kd2lkdGgpIHtcbiAgICAgICAgICAvLyBzaW4odzApKnNpbmgoIGxuKDIpLzIgKiBCVyAqIHcwL3Npbih3MCkgKSAgICAgICAgICAgKGNhc2U6IEJXKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFscGhhID0gc2luVzAgLyAoMiAqIHEpO1xuICAgICAgICB9XG5cbiAgICAgICAgYjAgPSBhbHBoYTtcbiAgICAgICAgYjEgPSAwO1xuICAgICAgICBiMiA9IC1hbHBoYTtcbiAgICAgICAgYTAgPSAxICsgYWxwaGE7XG4gICAgICAgIGExID0gLTIgKiBjb3NXMDtcbiAgICAgICAgYTIgPSAxIC0gYWxwaGE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgLy8gSChzKSA9IChzXjIgKyAxKSAvIChzXjIgKyBzL1EgKyAxKVxuICAgICAgY2FzZSAnbm90Y2gnOlxuICAgICAgICBhbHBoYSA9IHNpblcwIC8gKDIgKiBxKTtcbiAgICAgICAgYjAgPSAxO1xuICAgICAgICBiMSA9IC0yICogY29zVzA7XG4gICAgICAgIGIyID0gMTtcbiAgICAgICAgYTAgPSAxICsgYWxwaGE7XG4gICAgICAgIGExID0gYjE7XG4gICAgICAgIGEyID0gMSAtIGFscGhhO1xuICAgICAgICBicmVhaztcbiAgICAgIC8vIEgocykgPSAoc14yIC0gcy9RICsgMSkgLyAoc14yICsgcy9RICsgMSlcbiAgICAgIGNhc2UgJ2FsbHBhc3MnOlxuICAgICAgICBhbHBoYSA9IHNpblcwIC8gKDIgKiBxKTtcbiAgICAgICAgYjAgPSAxIC0gYWxwaGE7XG4gICAgICAgIGIxID0gLTIgKiBjb3NXMDtcbiAgICAgICAgYjIgPSAxICsgYWxwaGE7XG4gICAgICAgIGEwID0gYjI7XG4gICAgICAgIGExID0gYjE7XG4gICAgICAgIGEyID0gYjA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgLy8gSChzKSA9IChzXjIgKyBzKihBL1EpICsgMSkgLyAoc14yICsgcy8oQSpRKSArIDEpXG4gICAgICBjYXNlICdwZWFraW5nJzpcbiAgICAgICAgaWYgKGJhbmR3aWR0aCkge1xuICAgICAgICAgIC8vIHNpbih3MCkqc2luaCggbG4oMikvMiAqIEJXICogdzAvc2luKHcwKSApICAgICAgICAgICAoY2FzZTogQlcpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYWxwaGEgPSBzaW5XMCAvICgyICogcSk7XG4gICAgICAgIH1cblxuICAgICAgICBiMCA9IDEgKyBhbHBoYSAqIEE7XG4gICAgICAgIGIxID0gLTIgKiBjb3NXMDtcbiAgICAgICAgYjIgPSAxIC0gYWxwaGEgKiBBO1xuICAgICAgICBhMCA9IDEgKyBhbHBoYSAvIEE7XG4gICAgICAgIGExID0gYjE7XG4gICAgICAgIGEyID0gMSAtIGFscGhhIC8gQTtcbiAgICAgICAgYnJlYWs7XG4gICAgICAvLyBIKHMpID0gQSAqIChzXjIgKyAoc3FydChBKS9RKSpzICsgQSkvKEEqc14yICsgKHNxcnQoQSkvUSkqcyArIDEpXG4gICAgICBjYXNlICdsb3dzaGVsZic6XG4gICAgICAgIGFscGhhID0gc2luVzAgLyAoMiAqIHEpO1xuICAgICAgICBfMlJvb3RBQWxwaGEgPSAyICogc3FydChBKSAqIGFscGhhO1xuXG4gICAgICAgIGIwID0gICAgIEEgKiAoKEEgKyAxKSAtIChBIC0gMSkgKiBjb3NXMCArIF8yUm9vdEFBbHBoYSk7XG4gICAgICAgIGIxID0gMiAqIEEgKiAoKEEgLSAxKSAtIChBICsgMSkgKiBjb3NXMCk7XG4gICAgICAgIGIyID0gICAgIEEgKiAoKEEgKyAxKSAtIChBIC0gMSkgKiBjb3NXMCAtIF8yUm9vdEFBbHBoYSk7XG4gICAgICAgIGEwID0gICAgICAgICAgKEEgKyAxKSArIChBIC0gMSkgKiBjb3NXMCArIF8yUm9vdEFBbHBoYTtcbiAgICAgICAgYTEgPSAgICAtMiAqICgoQSAtIDEpICsgKEEgKyAxKSAqIGNvc1cwKTtcbiAgICAgICAgYTIgPSAgICAgICAgICAoQSArIDEpICsgKEEgLSAxKSAqIGNvc1cwIC0gXzJSb290QUFscGhhO1xuICAgICAgICBicmVhaztcbiAgICAgIC8vIEgocykgPSBBICogKEEqc14yICsgKHNxcnQoQSkvUSkqcyArIDEpLyhzXjIgKyAoc3FydChBKS9RKSpzICsgQSlcbiAgICAgIGNhc2UgJ2hpZ2hzaGVsZic6XG4gICAgICAgIGFscGhhID0gc2luVzAgLyAoMiAqIHEpO1xuICAgICAgICBfMlJvb3RBQWxwaGEgPSAyICogc3FydChBKSAqIGFscGhhO1xuXG4gICAgICAgIGIwID0gICAgICBBICogKChBICsgMSkgKyAoQSAtIDEpICogY29zVzAgKyBfMlJvb3RBQWxwaGEpO1xuICAgICAgICBiMSA9IC0yICogQSAqICgoQSAtIDEpICsgKEEgKyAxKSAqIGNvc1cwKTtcbiAgICAgICAgYjIgPSAgICAgIEEgKiAoKEEgKyAxKSArIChBIC0gMSkgKiBjb3NXMCAtIF8yUm9vdEFBbHBoYSk7XG4gICAgICAgIGEwID0gICAgICAgICAgIChBICsgMSkgLSAoQSAtIDEpICogY29zVzAgKyBfMlJvb3RBQWxwaGE7XG4gICAgICAgIGExID0gICAgICAyICogKChBIC0gMSkgLSAoQSArIDEpICogY29zVzApO1xuICAgICAgICBhMiA9ICAgICAgICAgICAoQSArIDEpIC0gKEEgLSAxKSAqIGNvc1cwIC0gXzJSb290QUFscGhhO1xuXG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHRoaXMuY29lZnMgPSB7XG4gICAgICBiMDogYjAgLyBhMCxcbiAgICAgIGIxOiBiMSAvIGEwLFxuICAgICAgYjI6IGIyIC8gYTAsXG4gICAgICBhMTogYTEgLyBhMCxcbiAgICAgIGEyOiBhMiAvIGEwLFxuICAgIH07XG5cbiAgICAvLyByZXNldCBzdGF0ZVxuICAgIGlmIChmcmFtZVR5cGUgPT09ICdzaWduYWwnKSB7XG4gICAgICB0aGlzLnN0YXRlID0geyB4MTogMCwgeDI6IDAsIHkxOiAwLCB5MjogMCB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICB4MTogbmV3IEZsb2F0MzJBcnJheShmcmFtZVNpemUpLFxuICAgICAgICB4MjogbmV3IEZsb2F0MzJBcnJheShmcmFtZVNpemUpLFxuICAgICAgICB5MTogbmV3IEZsb2F0MzJBcnJheShmcmFtZVNpemUpLFxuICAgICAgICB5MjogbmV3IEZsb2F0MzJBcnJheShmcmFtZVNpemUpLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgcHJvY2Vzc1N0cmVhbVBhcmFtcyhwcmV2U3RyZWFtUGFyYW1zKSB7XG4gICAgdGhpcy5wcmVwYXJlU3RyZWFtUGFyYW1zKHByZXZTdHJlYW1QYXJhbXMpO1xuXG4gICAgLy8gaWYgbm8gYHNhbXBsZVJhdGVgIG9yIGBzYW1wbGVSYXRlYCBpcyAwIHdlIHNoYWxsIGhhbHQhXG4gICAgY29uc3Qgc2FtcGxlUmF0ZSA9IHRoaXMuc3RyZWFtUGFyYW1zLnNvdXJjZVNhbXBsZVJhdGU7XG5cbiAgICBpZiAoIXNhbXBsZVJhdGUgfHwgc2FtcGxlUmF0ZSA8PSAwKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNhbXBsZVJhdGUgdmFsdWUgKDApIGZvciBiaXF1YWQnKTtcblxuICAgIHRoaXMuX2NhbGN1bGF0ZUNvZWZzKCk7XG4gICAgdGhpcy5wcm9wYWdhdGVTdHJlYW1QYXJhbXMoKTtcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBwcm9jZXNzVmVjdG9yKGZyYW1lKSB7XG4gICAgY29uc3QgZnJhbWVTaXplID0gdGhpcy5zdHJlYW1QYXJhbXMuZnJhbWVTaXplO1xuICAgIGNvbnN0IG91dERhdGEgPSB0aGlzLmZyYW1lLmRhdGE7XG4gICAgY29uc3QgaW5EYXRhID0gZnJhbWUuZGF0YTtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgY29lZnMgPSB0aGlzLmNvZWZzO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZVNpemU7IGkrKykge1xuICAgICAgY29uc3QgeCA9IGluRGF0YVtpXTtcbiAgICAgIGNvbnN0IHkgPSBjb2Vmcy5iMCAqIHhcbiAgICAgICAgICAgICAgKyBjb2Vmcy5iMSAqIHN0YXRlLngxW2ldICsgY29lZnMuYjIgKiBzdGF0ZS54MltpXVxuICAgICAgICAgICAgICAtIGNvZWZzLmExICogc3RhdGUueTFbaV0gLSBjb2Vmcy5hMiAqIHN0YXRlLnkyW2ldO1xuXG4gICAgICBvdXREYXRhW2ldID0geTtcblxuICAgICAgLy8gdXBkYXRlIHN0YXRlc1xuICAgICAgc3RhdGUueDJbaV0gPSBzdGF0ZS54MVtpXTtcbiAgICAgIHN0YXRlLngxW2ldID0geDtcbiAgICAgIHN0YXRlLnkyW2ldID0gc3RhdGUueTFbaV07XG4gICAgICBzdGF0ZS55MVtpXSA9IHk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIHByb2Nlc3NTaWduYWwoZnJhbWUpIHtcbiAgICBjb25zdCBmcmFtZVNpemUgPSB0aGlzLnN0cmVhbVBhcmFtcy5mcmFtZVNpemU7XG4gICAgY29uc3Qgb3V0RGF0YSA9IHRoaXMuZnJhbWUuZGF0YTtcbiAgICBjb25zdCBpbkRhdGEgPSBmcmFtZS5kYXRhO1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBjb2VmcyA9IHRoaXMuY29lZnM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lU2l6ZTsgaSsrKSB7XG4gICAgICBjb25zdCB4ID0gaW5EYXRhW2ldO1xuICAgICAgY29uc3QgeSA9IGNvZWZzLmIwICogeFxuICAgICAgICAgICAgICArIGNvZWZzLmIxICogc3RhdGUueDEgKyBjb2Vmcy5iMiAqIHN0YXRlLngyXG4gICAgICAgICAgICAgIC0gY29lZnMuYTEgKiBzdGF0ZS55MSAtIGNvZWZzLmEyICogc3RhdGUueTI7XG5cbiAgICAgIG91dERhdGFbaV0gPSB5O1xuXG4gICAgICAvLyB1cGRhdGUgc3RhdGVzXG4gICAgICBzdGF0ZS54MiA9IHN0YXRlLngxO1xuICAgICAgc3RhdGUueDEgPSB4O1xuICAgICAgc3RhdGUueTIgPSBzdGF0ZS55MTtcbiAgICAgIHN0YXRlLnkxID0geTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQmlxdWFkO1xuIl19