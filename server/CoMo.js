"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _serveStatic = _interopRequireDefault(require("serve-static"));

var _server = _interopRequireDefault(require("@soundworks/plugin-filesystem/server"));

var _server2 = _interopRequireDefault(require("@soundworks/plugin-platform/server"));

var _server3 = _interopRequireDefault(require("@soundworks/plugin-checkin/server"));

var _server4 = _interopRequireDefault(require("@soundworks/plugin-audio-buffer-loader/server"));

var _server5 = _interopRequireDefault(require("@soundworks/plugin-sync/server"));

var _server6 = _interopRequireDefault(require("@soundworks/plugin-scripting/server"));

var _server7 = _interopRequireDefault(require("@soundworks/plugin-logger/server"));

var _index = _interopRequireDefault(require("./sources/index.js"));

var _index2 = _interopRequireDefault(require("../common/modules/index.js"));

var _Project = _interopRequireDefault(require("./Project.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class CoMo {
  // init
  constructor(server, projectsDirectory, projectName) {
    this.server = server;
    this.projectName = projectName;
    this.projectDirectory = _path.default.join(projectsDirectory, projectName);
    this.project = null;
    this.sources = _index.default;
    this.modules = _index2.default;
    this.idClientMap = new Map(); // register plugins needed for

    this.server.pluginManager.register('file-watcher', _server.default, {
      directories: [{
        name: 'audio',
        path: _path.default.join(this.projectDirectory, 'audio'),
        publicDirectory: 'audio'
      }, {
        name: 'sessions',
        path: _path.default.join(this.projectDirectory, 'sessions'),
        publicDirectory: 'sessions'
      }, {
        // for now, we can't create presets dynamically
        name: 'presets',
        path: _path.default.join(this.projectDirectory, 'presets'),
        publicDirectory: 'presets'
      }]
    });
    this.server.pluginManager.register('logger', _server7.default, {
      directory: _path.default.join(this.projectDirectory, 'recordings')
    });

    const scriptsDataDir = _path.default.join(this.projectDirectory, 'scripts/data');

    const scriptsAudioDir = _path.default.join(this.projectDirectory, 'scripts/audio');

    this.server.pluginManager.register('scripts-data', _server6.default, {
      directory: scriptsDataDir,
      defaultScriptValue: _fs.default.readFileSync(_path.default.join(scriptsDataDir, 'default.js')).toString()
    });
    this.server.pluginManager.register('scripts-audio', _server6.default, {
      directory: scriptsAudioDir,
      defaultScriptValue: _fs.default.readFileSync(_path.default.join(scriptsAudioDir, 'default.js')).toString()
    });
    this.server.pluginManager.register('sync', _server5.default);
    this.server.pluginManager.register('platform', _server2.default);
    this.server.pluginManager.register('checkin', _server3.default);
    this.server.pluginManager.register('audio-buffer-loader', _server4.default);
  }

  get clientTypes() {
    const clientTypes = Object.keys(this.server.config.app.clients);
    return clientTypes;
  }

  async init(config) {
    // open public route for audio files
    this.server.router.use('audio', (0, _serveStatic.default)(_path.default.join(this.projectDirectory, 'audio'))); // projects needs the file watcher

    this.fileWatcher = this.server.pluginManager.get('file-watcher');
    return Promise.resolve(true);
  }

  async start() {
    // server is started and all plugins are ready
    this.project = new _Project.default(this);
    await this.project.init();
    return Promise.resolve(true);
  }

  configureExperience(experience) {
    this.experience = experience;
    this.experience.plugins = {};
    const plugins = ['file-watcher', 'sync', 'platform', 'checkin', 'audio-buffer-loader', 'scripts-data', 'scripts-audio', 'logger'];
    plugins.forEach(pluginName => {
      this.experience.plugins[pluginName] = this.experience.require(pluginName);
    });
  }

  addClient(client) {
    this.idClientMap.set(client.id, client);
    client.socket.addListener(`como:project:createSession:req`, async (sessionName, graphPreset) => {
      const uuid = await this.project.createSession(sessionName, graphPreset);

      if (uuid !== null) {
        client.socket.send(`como:project:createSession:ack`, uuid);
      } else {
        client.socket.send(`como:project:createSession:err`, 'session already exists');
      }
    });
    client.socket.addListener(`como:project:deleteSession:req`, async sessionId => {
      const result = await this.project.deleteSession(sessionId);

      if (result === true) {
        client.socket.send(`como:project:deleteSession:ack`);
      } else {
        client.socket.send(`como:project:deleteSession:err`, 'session ${sessionId} does not exists');
      }
    }); // streams routing definitions

    client.socket.addListener(`como:routing:createStreamRoute:req`, async (fromSourceId, toNodeId) => {
      const result = await this.project.createStreamRoute(fromSourceId, toNodeId);

      if (result === true) {
        client.socket.send(`como:routing:createStreamRoute:ack`, result);
      } else {
        client.socket.send(`como:routing:createStreamRoute:err`, `an error occured creating route [${fromSourceId}, ${toNodeId}]`);
      }
    });
    client.socket.addListener(`como:routing:deleteStreamRoute:req`, async (fromSourceId, toNodeId) => {
      const result = await this.project.deleteStreamRoute(fromSourceId, toNodeId);

      if (result === true) {
        client.socket.send(`como:routing:deleteStreamRoute:ack`, result);
      } else {
        client.socket.send(`como:routing:deleteStreamRoute:err`, `an error occured creating route [${fromSourceId}, ${toNodeId}]`);
      }
    }); // streams routing

    client.socket.addBinaryListener('stream', frame => {
      this.project.propagateStreamFrame(frame);
    }); // ------------------------------------------------------------
    // session management

    client.socket.addListener(`como:session:addExample`, async (sessionId, example) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.addExample(example);
      }
    });
    client.socket.addListener(`como:session:deleteExample`, async (sessionId, exampleUuid) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.deleteExample(exampleUuid);
      }
    });
    client.socket.addListener(`como:session:clearExamples`, async (sessionId, label = null) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId, label);
        session.clearExamples(label);
      }
    });
    client.socket.addListener(`como:session:createLabel`, async (sessionId, label) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.createLabel(label);
      }
    });
    client.socket.addListener(`como:session:updateLabel`, async (sessionId, oldLabel, newLabel) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.updateLabel(oldLabel, newLabel);
      }
    });
    client.socket.addListener(`como:session:deleteLabel`, async (sessionId, label) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.deleteLabel(label);
      }
    });
    client.socket.addListener(`como:session:toggleAudioFile`, async (sessionId, filename, active) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.toggleAudioFile(filename, active);
      }
    });
    client.socket.addListener(`como:session:createLabelAudioFileRow`, async (sessionId, row) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.createLabelAudioFileRow(row);
      }
    });
    client.socket.addListener(`como:session:deleteLabelAudioFileRow`, async (sessionId, row) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.deleteLabelAudioFileRow(row);
      }
    });
  }

  deleteClient(client) {
    this.idClientMap.delete(client.id, client);
    this.project.clearStreamRouting(null, client.id); // clear routing where client is the target
  }

}

var _default = CoMo;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIvQ29Nby5qcyJdLCJuYW1lcyI6WyJDb01vIiwiY29uc3RydWN0b3IiLCJzZXJ2ZXIiLCJwcm9qZWN0c0RpcmVjdG9yeSIsInByb2plY3ROYW1lIiwicHJvamVjdERpcmVjdG9yeSIsInBhdGgiLCJqb2luIiwicHJvamVjdCIsInNvdXJjZXMiLCJtb2R1bGVzIiwiaWRDbGllbnRNYXAiLCJNYXAiLCJwbHVnaW5NYW5hZ2VyIiwicmVnaXN0ZXIiLCJwbHVnaW5GaWxlU3lzdGVtRmFjdG9yeSIsImRpcmVjdG9yaWVzIiwibmFtZSIsInB1YmxpY0RpcmVjdG9yeSIsInBsdWdpbkxvZ2dlckZhY3RvcnkiLCJkaXJlY3RvcnkiLCJzY3JpcHRzRGF0YURpciIsInNjcmlwdHNBdWRpb0RpciIsInBsdWdpblNjcmlwdGluZ0ZhY3RvcnkiLCJkZWZhdWx0U2NyaXB0VmFsdWUiLCJmcyIsInJlYWRGaWxlU3luYyIsInRvU3RyaW5nIiwicGx1Z2luU3luY0ZhY3RvcnkiLCJwbHVnaW5QbGF0Zm9ybUZhY3RvcnkiLCJwbHVnaW5DaGVja2luRmFjdG9yeSIsInBsdWdpbkF1ZGlvQnVmZmVyTG9hZGVyRmFjdG9yeSIsImNsaWVudFR5cGVzIiwiT2JqZWN0Iiwia2V5cyIsImNvbmZpZyIsImFwcCIsImNsaWVudHMiLCJpbml0Iiwicm91dGVyIiwidXNlIiwiZmlsZVdhdGNoZXIiLCJnZXQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInN0YXJ0IiwiUHJvamVjdCIsImNvbmZpZ3VyZUV4cGVyaWVuY2UiLCJleHBlcmllbmNlIiwicGx1Z2lucyIsImZvckVhY2giLCJwbHVnaW5OYW1lIiwicmVxdWlyZSIsImFkZENsaWVudCIsImNsaWVudCIsInNldCIsImlkIiwic29ja2V0IiwiYWRkTGlzdGVuZXIiLCJzZXNzaW9uTmFtZSIsImdyYXBoUHJlc2V0IiwidXVpZCIsImNyZWF0ZVNlc3Npb24iLCJzZW5kIiwic2Vzc2lvbklkIiwicmVzdWx0IiwiZGVsZXRlU2Vzc2lvbiIsImZyb21Tb3VyY2VJZCIsInRvTm9kZUlkIiwiY3JlYXRlU3RyZWFtUm91dGUiLCJkZWxldGVTdHJlYW1Sb3V0ZSIsImFkZEJpbmFyeUxpc3RlbmVyIiwiZnJhbWUiLCJwcm9wYWdhdGVTdHJlYW1GcmFtZSIsImV4YW1wbGUiLCJzZXNzaW9ucyIsImhhcyIsInNlc3Npb24iLCJhZGRFeGFtcGxlIiwiZXhhbXBsZVV1aWQiLCJkZWxldGVFeGFtcGxlIiwibGFiZWwiLCJjbGVhckV4YW1wbGVzIiwiY3JlYXRlTGFiZWwiLCJvbGRMYWJlbCIsIm5ld0xhYmVsIiwidXBkYXRlTGFiZWwiLCJkZWxldGVMYWJlbCIsImZpbGVuYW1lIiwiYWN0aXZlIiwidG9nZ2xlQXVkaW9GaWxlIiwicm93IiwiY3JlYXRlTGFiZWxBdWRpb0ZpbGVSb3ciLCJkZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyIsImRlbGV0ZUNsaWVudCIsImRlbGV0ZSIsImNsZWFyU3RyZWFtUm91dGluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOzs7O0FBR0EsTUFBTUEsSUFBTixDQUFXO0FBQ1Q7QUFDQUMsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQVNDLGlCQUFULEVBQTRCQyxXQUE1QixFQUF5QztBQUNsRCxTQUFLRixNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLRSxXQUFMLEdBQW1CQSxXQUFuQjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCQyxjQUFLQyxJQUFMLENBQVVKLGlCQUFWLEVBQTZCQyxXQUE3QixDQUF4QjtBQUNBLFNBQUtJLE9BQUwsR0FBZSxJQUFmO0FBRUEsU0FBS0MsT0FBTCxHQUFlQSxjQUFmO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxlQUFmO0FBRUEsU0FBS0MsV0FBTCxHQUFtQixJQUFJQyxHQUFKLEVBQW5CLENBVGtELENBV2xEOztBQUNBLFNBQUtWLE1BQUwsQ0FBWVcsYUFBWixD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ICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgc2VydmVTdGF0aWMgZnJvbSAnc2VydmUtc3RhdGljJztcbmltcG9ydCBwbHVnaW5GaWxlU3lzdGVtRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tZmlsZXN5c3RlbS9zZXJ2ZXInO1xuaW1wb3J0IHBsdWdpblBsYXRmb3JtRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tcGxhdGZvcm0vc2VydmVyJztcbmltcG9ydCBwbHVnaW5DaGVja2luRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tY2hlY2tpbi9zZXJ2ZXInO1xuaW1wb3J0IHBsdWdpbkF1ZGlvQnVmZmVyTG9hZGVyRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tYXVkaW8tYnVmZmVyLWxvYWRlci9zZXJ2ZXInO1xuaW1wb3J0IHBsdWdpblN5bmNGYWN0b3J5IGZyb20gJ0Bzb3VuZHdvcmtzL3BsdWdpbi1zeW5jL3NlcnZlcic7XG5pbXBvcnQgcGx1Z2luU2NyaXB0aW5nRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tc2NyaXB0aW5nL3NlcnZlcic7XG5pbXBvcnQgcGx1Z2luTG9nZ2VyRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tbG9nZ2VyL3NlcnZlcic7XG5cbmltcG9ydCBzb3VyY2VzIGZyb20gJy4vc291cmNlcy9pbmRleC5qcyc7XG5pbXBvcnQgbW9kdWxlcyBmcm9tICcuLi9jb21tb24vbW9kdWxlcy9pbmRleC5qcyc7XG5cbmltcG9ydCBQcm9qZWN0IGZyb20gJy4vUHJvamVjdC5qcyc7XG5cblxuY2xhc3MgQ29NbyB7XG4gIC8vIGluaXRcbiAgY29uc3RydWN0b3Ioc2VydmVyLCBwcm9qZWN0c0RpcmVjdG9yeSwgcHJvamVjdE5hbWUpIHtcbiAgICB0aGlzLnNlcnZlciA9IHNlcnZlcjtcbiAgICB0aGlzLnByb2plY3ROYW1lID0gcHJvamVjdE5hbWU7XG4gICAgdGhpcy5wcm9qZWN0RGlyZWN0b3J5ID0gcGF0aC5qb2luKHByb2plY3RzRGlyZWN0b3J5LCBwcm9qZWN0TmFtZSk7XG4gICAgdGhpcy5wcm9qZWN0ID0gbnVsbDtcblxuICAgIHRoaXMuc291cmNlcyA9IHNvdXJjZXM7XG4gICAgdGhpcy5tb2R1bGVzID0gbW9kdWxlcztcblxuICAgIHRoaXMuaWRDbGllbnRNYXAgPSBuZXcgTWFwKCk7XG5cbiAgICAvLyByZWdpc3RlciBwbHVnaW5zIG5lZWRlZCBmb3JcbiAgICB0aGlzLnNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKCdmaWxlLXdhdGNoZXInLCBwbHVnaW5GaWxlU3lzdGVtRmFjdG9yeSwge1xuICAgICAgZGlyZWN0b3JpZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6ICdhdWRpbycsXG4gICAgICAgICAgcGF0aDogcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ2F1ZGlvJyksXG4gICAgICAgICAgcHVibGljRGlyZWN0b3J5OiAnYXVkaW8nLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ3Nlc3Npb25zJyxcbiAgICAgICAgICBwYXRoOiBwYXRoLmpvaW4odGhpcy5wcm9qZWN0RGlyZWN0b3J5LCAnc2Vzc2lvbnMnKSxcbiAgICAgICAgICBwdWJsaWNEaXJlY3Rvcnk6ICdzZXNzaW9ucycsXG4gICAgICAgIH0sXG4gICAgICAgIHsgLy8gZm9yIG5vdywgd2UgY2FuJ3QgY3JlYXRlIHByZXNldHMgZHluYW1pY2FsbHlcbiAgICAgICAgICBuYW1lOiAncHJlc2V0cycsXG4gICAgICAgICAgcGF0aDogcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ3ByZXNldHMnKSxcbiAgICAgICAgICBwdWJsaWNEaXJlY3Rvcnk6ICdwcmVzZXRzJyxcbiAgICAgICAgfVxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ2xvZ2dlcicsIHBsdWdpbkxvZ2dlckZhY3RvcnksIHtcbiAgICAgIGRpcmVjdG9yeTogcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ3JlY29yZGluZ3MnKSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHNjcmlwdHNEYXRhRGlyID0gcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ3NjcmlwdHMvZGF0YScpO1xuICAgIGNvbnN0IHNjcmlwdHNBdWRpb0RpciA9IHBhdGguam9pbih0aGlzLnByb2plY3REaXJlY3RvcnksICdzY3JpcHRzL2F1ZGlvJyk7XG5cbiAgICB0aGlzLnNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKCdzY3JpcHRzLWRhdGEnLCBwbHVnaW5TY3JpcHRpbmdGYWN0b3J5LCB7XG4gICAgICBkaXJlY3Rvcnk6IHNjcmlwdHNEYXRhRGlyLFxuICAgICAgZGVmYXVsdFNjcmlwdFZhbHVlOiBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKHNjcmlwdHNEYXRhRGlyLCAnZGVmYXVsdC5qcycpKS50b1N0cmluZygpLFxuICAgIH0pO1xuXG4gICAgdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3Rlcignc2NyaXB0cy1hdWRpbycsIHBsdWdpblNjcmlwdGluZ0ZhY3RvcnksIHtcbiAgICAgIGRpcmVjdG9yeTogc2NyaXB0c0F1ZGlvRGlyLFxuICAgICAgZGVmYXVsdFNjcmlwdFZhbHVlOiBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKHNjcmlwdHNBdWRpb0RpciwgJ2RlZmF1bHQuanMnKSkudG9TdHJpbmcoKSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ3N5bmMnLCBwbHVnaW5TeW5jRmFjdG9yeSk7XG4gICAgdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3RlcigncGxhdGZvcm0nLCBwbHVnaW5QbGF0Zm9ybUZhY3RvcnkpO1xuICAgIHRoaXMuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ2NoZWNraW4nLCBwbHVnaW5DaGVja2luRmFjdG9yeSk7XG4gICAgdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3RlcignYXVkaW8tYnVmZmVyLWxvYWRlcicsIHBsdWdpbkF1ZGlvQnVmZmVyTG9hZGVyRmFjdG9yeSk7XG4gIH1cblxuICBnZXQgY2xpZW50VHlwZXMoKSB7XG4gICAgY29uc3QgY2xpZW50VHlwZXMgPSBPYmplY3Qua2V5cyh0aGlzLnNlcnZlci5jb25maWcuYXBwLmNsaWVudHMpO1xuICAgIHJldHVybiBjbGllbnRUeXBlcztcbiAgfVxuXG4gIGFzeW5jIGluaXQoY29uZmlnKSB7XG4gICAgLy8gb3BlbiBwdWJsaWMgcm91dGUgZm9yIGF1ZGlvIGZpbGVzXG4gICAgdGhpcy5zZXJ2ZXIucm91dGVyLnVzZSgnYXVkaW8nLCBzZXJ2ZVN0YXRpYyhwYXRoLmpvaW4odGhpcy5wcm9qZWN0RGlyZWN0b3J5LCAnYXVkaW8nKSkpO1xuICAgIC8vIHByb2plY3RzIG5lZWRzIHRoZSBmaWxlIHdhdGNoZXJcbiAgICB0aGlzLmZpbGVXYXRjaGVyID0gdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5nZXQoJ2ZpbGUtd2F0Y2hlcicpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0KCkge1xuICAgIC8vIHNlcnZlciBpcyBzdGFydGVkIGFuZCBhbGwgcGx1Z2lucyBhcmUgcmVhZHlcbiAgICB0aGlzLnByb2plY3QgPSBuZXcgUHJvamVjdCh0aGlzKTtcbiAgICBhd2FpdCB0aGlzLnByb2plY3QuaW5pdCgpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgfVxuXG4gIGNvbmZpZ3VyZUV4cGVyaWVuY2UoZXhwZXJpZW5jZSkge1xuICAgIHRoaXMuZXhwZXJpZW5jZSA9IGV4cGVyaWVuY2U7XG4gICAgdGhpcy5leHBlcmllbmNlLnBsdWdpbnMgPSB7fTtcblxuICAgIGNvbnN0IHBsdWdpbnMgPSBbXG4gICAgICAnZmlsZS13YXRjaGVyJyxcbiAgICAgICdzeW5jJyxcbiAgICAgICdwbGF0Zm9ybScsXG4gICAgICAnY2hlY2tpbicsXG4gICAgICAnYXVkaW8tYnVmZmVyLWxvYWRlcicsXG4gICAgICAnc2NyaXB0cy1kYXRhJyxcbiAgICAgICdzY3JpcHRzLWF1ZGlvJyxcbiAgICAgICdsb2dnZXInLFxuICAgIF07XG5cbiAgICBwbHVnaW5zLmZvckVhY2gocGx1Z2luTmFtZSA9PiB7XG4gICAgICB0aGlzLmV4cGVyaWVuY2UucGx1Z2luc1twbHVnaW5OYW1lXSA9IHRoaXMuZXhwZXJpZW5jZS5yZXF1aXJlKHBsdWdpbk5hbWUpO1xuICAgIH0pO1xuICB9XG5cbiAgYWRkQ2xpZW50KGNsaWVudCkge1xuICAgIHRoaXMuaWRDbGllbnRNYXAuc2V0KGNsaWVudC5pZCwgY2xpZW50KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86cHJvamVjdDpjcmVhdGVTZXNzaW9uOnJlcWAsIGFzeW5jIChzZXNzaW9uTmFtZSwgZ3JhcGhQcmVzZXQpID0+IHtcbiAgICAgIGNvbnN0IHV1aWQgPSBhd2FpdCB0aGlzLnByb2plY3QuY3JlYXRlU2Vzc2lvbihzZXNzaW9uTmFtZSwgZ3JhcGhQcmVzZXQpO1xuXG4gICAgICBpZiAodXVpZCAhPT0gbnVsbCkge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpjcmVhdGVTZXNzaW9uOmFja2AsIHV1aWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnByb2plY3Q6Y3JlYXRlU2Vzc2lvbjplcnJgLCAnc2Vzc2lvbiBhbHJlYWR5IGV4aXN0cycpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpwcm9qZWN0OmRlbGV0ZVNlc3Npb246cmVxYCwgYXN5bmMgKHNlc3Npb25JZCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wcm9qZWN0LmRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkKTtcblxuICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOmFja2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnByb2plY3Q6ZGVsZXRlU2Vzc2lvbjplcnJgLCAnc2Vzc2lvbiAke3Nlc3Npb25JZH0gZG9lcyBub3QgZXhpc3RzJyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBzdHJlYW1zIHJvdXRpbmcgZGVmaW5pdGlvbnNcbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6cmVxYCwgYXN5bmMgKGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucHJvamVjdC5jcmVhdGVTdHJlYW1Sb3V0ZShmcm9tU291cmNlSWQsIHRvTm9kZUlkKTtcblxuICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTphY2tgLCByZXN1bHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6ZXJyYCxcbiAgICAgICAgICBgYW4gZXJyb3Igb2NjdXJlZCBjcmVhdGluZyByb3V0ZSBbJHtmcm9tU291cmNlSWR9LCAke3RvTm9kZUlkfV1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTpyZXFgLCBhc3luYyAoZnJvbVNvdXJjZUlkLCB0b05vZGVJZCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wcm9qZWN0LmRlbGV0ZVN0cmVhbVJvdXRlKGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpO1xuXG4gICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7XG4gICAgICAgIGNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOmFja2AsIHJlc3VsdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTplcnJgLFxuICAgICAgICAgIGBhbiBlcnJvciBvY2N1cmVkIGNyZWF0aW5nIHJvdXRlIFske2Zyb21Tb3VyY2VJZH0sICR7dG9Ob2RlSWR9XWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gc3RyZWFtcyByb3V0aW5nXG4gICAgY2xpZW50LnNvY2tldC5hZGRCaW5hcnlMaXN0ZW5lcignc3RyZWFtJywgZnJhbWUgPT4ge1xuICAgICAgdGhpcy5wcm9qZWN0LnByb3BhZ2F0ZVN0cmVhbUZyYW1lKGZyYW1lKTtcbiAgICB9KTtcblxuXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gc2Vzc2lvbiBtYW5hZ2VtZW50XG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpzZXNzaW9uOmFkZEV4YW1wbGVgLCBhc3luYyAoc2Vzc2lvbklkLCBleGFtcGxlKSA9PiB7XG4gICAgICBpZiAodGhpcy5wcm9qZWN0LnNlc3Npb25zLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnByb2plY3Quc2Vzc2lvbnMuZ2V0KHNlc3Npb25JZCk7XG4gICAgICAgIHNlc3Npb24uYWRkRXhhbXBsZShleGFtcGxlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86c2Vzc2lvbjpkZWxldGVFeGFtcGxlYCwgYXN5bmMgKHNlc3Npb25JZCwgZXhhbXBsZVV1aWQpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5kZWxldGVFeGFtcGxlKGV4YW1wbGVVdWlkKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86c2Vzc2lvbjpjbGVhckV4YW1wbGVzYCwgYXN5bmMgKHNlc3Npb25JZCwgbGFiZWwgPSBudWxsKSA9PiB7XG4gICAgICBpZiAodGhpcy5wcm9qZWN0LnNlc3Npb25zLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnByb2plY3Quc2Vzc2lvbnMuZ2V0KHNlc3Npb25JZCwgbGFiZWwpO1xuICAgICAgICBzZXNzaW9uLmNsZWFyRXhhbXBsZXMobGFiZWwpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpzZXNzaW9uOmNyZWF0ZUxhYmVsYCwgYXN5bmMgKHNlc3Npb25JZCwgbGFiZWwpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5jcmVhdGVMYWJlbChsYWJlbCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnNlc3Npb246dXBkYXRlTGFiZWxgLCBhc3luYyAoc2Vzc2lvbklkLCBvbGRMYWJlbCwgbmV3TGFiZWwpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi51cGRhdGVMYWJlbChvbGRMYWJlbCwgbmV3TGFiZWwpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpzZXNzaW9uOmRlbGV0ZUxhYmVsYCwgYXN5bmMgKHNlc3Npb25JZCwgbGFiZWwpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5kZWxldGVMYWJlbChsYWJlbCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnNlc3Npb246dG9nZ2xlQXVkaW9GaWxlYCwgYXN5bmMgKHNlc3Npb25JZCwgZmlsZW5hbWUsIGFjdGl2ZSkgPT4ge1xuICAgICAgaWYgKHRoaXMucHJvamVjdC5zZXNzaW9ucy5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5wcm9qZWN0LnNlc3Npb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBzZXNzaW9uLnRvZ2dsZUF1ZGlvRmlsZShmaWxlbmFtZSwgYWN0aXZlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86c2Vzc2lvbjpjcmVhdGVMYWJlbEF1ZGlvRmlsZVJvd2AsIGFzeW5jIChzZXNzaW9uSWQsIHJvdykgPT4ge1xuICAgICAgaWYgKHRoaXMucHJvamVjdC5zZXNzaW9ucy5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5wcm9qZWN0LnNlc3Npb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBzZXNzaW9uLmNyZWF0ZUxhYmVsQXVkaW9GaWxlUm93KHJvdyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnNlc3Npb246ZGVsZXRlTGFiZWxBdWRpb0ZpbGVSb3dgLCBhc3luYyAoc2Vzc2lvbklkLCByb3cpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5kZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyhyb3cpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZGVsZXRlQ2xpZW50KGNsaWVudCkge1xuICAgIHRoaXMuaWRDbGllbnRNYXAuZGVsZXRlKGNsaWVudC5pZCwgY2xpZW50KTtcbiAgICB0aGlzLnByb2plY3QuY2xlYXJTdHJlYW1Sb3V0aW5nKG51bGwsIGNsaWVudC5pZCk7IC8vIGNsZWFyIHJvdXRpbmcgd2hlcmUgY2xpZW50IGlzIHRoZSB0YXJnZXRcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBDb01vO1xuXG4iXX0=