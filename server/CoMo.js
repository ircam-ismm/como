"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _serveStatic = _interopRequireDefault(require("serve-static"));

var _server = _interopRequireDefault(require("@soundworks/plugin-filesystem/server"));

var _server2 = _interopRequireDefault(require("@soundworks/plugin-platform/server"));

var _server3 = _interopRequireDefault(require("@soundworks/plugin-checkin/server"));

var _server4 = _interopRequireDefault(require("@soundworks/plugin-audio-buffer-loader/server"));

var _server5 = _interopRequireDefault(require("@soundworks/plugin-sync/server"));

var _server6 = _interopRequireDefault(require("@soundworks/plugin-scripting/server"));

var _server7 = _interopRequireDefault(require("@soundworks/plugin-logger/server"));

var _index = _interopRequireDefault(require("./sources/index.js"));

var _index2 = _interopRequireDefault(require("../common/modules/index.js"));

var _index3 = _interopRequireDefault(require("../common/helpers/index.js"));

var _Project = _interopRequireDefault(require("./Project.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class CoMo {
  // init
  constructor(server, projectsDirectory, projectName) {
    this.server = server;
    this.projectName = projectName;
    this.projectDirectory = _path.default.join(projectsDirectory, projectName);
    this.project = null;
    this.sources = _index.default;
    this.modules = _index2.default;
    this.helpers = _index3.default;
    this.idClientMap = new Map(); // register plugins needed for

    this.server.pluginManager.register('file-watcher', _server.default, {
      directories: [{
        name: 'audio',
        path: _path.default.join(this.projectDirectory, 'audio'),
        publicDirectory: 'audio'
      }, {
        name: 'sessions',
        path: _path.default.join(this.projectDirectory, 'sessions'),
        publicDirectory: 'sessions'
      }, {
        // for now, we can't create presets dynamically
        name: 'presets',
        path: _path.default.join(this.projectDirectory, 'presets'),
        publicDirectory: 'presets'
      }]
    });
    this.server.pluginManager.register('logger', _server7.default, {
      directory: _path.default.join(this.projectDirectory, 'recordings')
    });

    const scriptsDataDir = _path.default.join(this.projectDirectory, 'scripts/data');

    const scriptsAudioDir = _path.default.join(this.projectDirectory, 'scripts/audio');

    this.server.pluginManager.register('scripts-data', _server6.default, {
      directory: scriptsDataDir,
      defaultScriptValue: _fs.default.readFileSync(_path.default.join(scriptsDataDir, 'default.js')).toString()
    });
    this.server.pluginManager.register('scripts-audio', _server6.default, {
      directory: scriptsAudioDir,
      defaultScriptValue: _fs.default.readFileSync(_path.default.join(scriptsAudioDir, 'default.js')).toString()
    });
    this.server.pluginManager.register('sync', _server5.default);
    this.server.pluginManager.register('platform', _server2.default);
    this.server.pluginManager.register('checkin', _server3.default);
    this.server.pluginManager.register('audio-buffer-loader', _server4.default);
  }

  get clientTypes() {
    const clientTypes = Object.keys(this.server.config.app.clients);
    return clientTypes;
  }

  async init(config) {
    // open public route for audio files
    this.server.router.use('audio', (0, _serveStatic.default)(_path.default.join(this.projectDirectory, 'audio'))); // projects needs the file watcher

    this.fileWatcher = this.server.pluginManager.get('file-watcher');
    return Promise.resolve(true);
  }

  async start() {
    // server is started and all plugins are ready
    this.project = new _Project.default(this);
    await this.project.init();
    return Promise.resolve(true);
  }

  configureExperience(experience) {
    this.experience = experience;
    this.experience.plugins = {};
    const plugins = ['file-watcher', 'sync', 'platform', 'checkin', 'audio-buffer-loader', 'scripts-data', 'scripts-audio', 'logger'];
    plugins.forEach(pluginName => {
      this.experience.plugins[pluginName] = this.experience.require(pluginName);
    });
  }

  addClient(client) {
    this.idClientMap.set(client.id, client);
    client.socket.addListener(`como:project:createSession:req`, async (sessionName, graphPreset) => {
      const uuid = await this.project.createSession(sessionName, graphPreset);

      if (uuid !== null) {
        client.socket.send(`como:project:createSession:ack`, uuid);
      } else {
        client.socket.send(`como:project:createSession:err`, 'session already exists');
      }
    });
    client.socket.addListener(`como:project:deleteSession:req`, async sessionId => {
      const result = await this.project.deleteSession(sessionId);

      if (result === true) {
        client.socket.send(`como:project:deleteSession:ack`);
      } else {
        client.socket.send(`como:project:deleteSession:err`, 'session ${sessionId} does not exists');
      }
    }); // streams routing definitions

    client.socket.addListener(`como:routing:createStreamRoute:req`, async (fromSourceId, toNodeId) => {
      const result = await this.project.createStreamRoute(fromSourceId, toNodeId);

      if (result === true) {
        client.socket.send(`como:routing:createStreamRoute:ack`, result);
      } else {
        client.socket.send(`como:routing:createStreamRoute:err`, `an error occured creating route [${fromSourceId}, ${toNodeId}]`);
      }
    });
    client.socket.addListener(`como:routing:deleteStreamRoute:req`, async (fromSourceId, toNodeId) => {
      const result = await this.project.deleteStreamRoute(fromSourceId, toNodeId);

      if (result === true) {
        client.socket.send(`como:routing:deleteStreamRoute:ack`, result);
      } else {
        client.socket.send(`como:routing:deleteStreamRoute:err`, `an error occured creating route [${fromSourceId}, ${toNodeId}]`);
      }
    }); // streams routing

    client.socket.addBinaryListener('stream', frame => {
      this.project.propagateStreamFrame(frame);
    }); // ------------------------------------------------------------
    // session management

    client.socket.addListener(`como:session:addExample`, async (sessionId, example) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.addExample(example);
      }
    });
    client.socket.addListener(`como:session:deleteExample`, async (sessionId, exampleUuid) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.deleteExample(exampleUuid);
      }
    });
    client.socket.addListener(`como:session:clearExamples`, async (sessionId, label = null) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId, label);
        session.clearExamples(label);
      }
    });
    client.socket.addListener(`como:session:createLabel`, async (sessionId, label) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.createLabel(label);
      }
    });
    client.socket.addListener(`como:session:updateLabel`, async (sessionId, oldLabel, newLabel) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.updateLabel(oldLabel, newLabel);
      }
    });
    client.socket.addListener(`como:session:deleteLabel`, async (sessionId, label) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.deleteLabel(label);
      }
    });
    client.socket.addListener(`como:session:toggleAudioFile`, async (sessionId, filename, active) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.toggleAudioFile(filename, active);
      }
    });
    client.socket.addListener(`como:session:createLabelAudioFileRow`, async (sessionId, row) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.createLabelAudioFileRow(row);
      }
    });
    client.socket.addListener(`como:session:deleteLabelAudioFileRow`, async (sessionId, row) => {
      if (this.project.sessions.has(sessionId)) {
        const session = this.project.sessions.get(sessionId);
        session.deleteLabelAudioFileRow(row);
      }
    });
  }

  deleteClient(client) {
    this.idClientMap.delete(client.id, client);
    this.project.clearStreamRouting(null, client.id); // clear routing where client is the target
  }

}

var _default = CoMo;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIvQ29Nby5qcyJdLCJuYW1lcyI6WyJDb01vIiwiY29uc3RydWN0b3IiLCJzZXJ2ZXIiLCJwcm9qZWN0c0RpcmVjdG9yeSIsInByb2plY3ROYW1lIiwicHJvamVjdERpcmVjdG9yeSIsInBhdGgiLCJqb2luIiwicHJvamVjdCIsInNvdXJjZXMiLCJtb2R1bGVzIiwiaGVscGVycyIsImlkQ2xpZW50TWFwIiwiTWFwIiwicGx1Z2luTWFuYWdlciIsInJlZ2lzdGVyIiwicGx1Z2luRmlsZVN5c3RlbUZhY3RvcnkiLCJkaXJlY3RvcmllcyIsIm5hbWUiLCJwdWJsaWNEaXJlY3RvcnkiLCJwbHVnaW5Mb2dnZXJGYWN0b3J5IiwiZGlyZWN0b3J5Iiwic2NyaXB0c0RhdGFEaXIiLCJzY3JpcHRzQXVkaW9EaXIiLCJwbHVnaW5TY3JpcHRpbmdGYWN0b3J5IiwiZGVmYXVsdFNjcmlwdFZhbHVlIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsInBsdWdpblN5bmNGYWN0b3J5IiwicGx1Z2luUGxhdGZvcm1GYWN0b3J5IiwicGx1Z2luQ2hlY2tpbkZhY3RvcnkiLCJwbHVnaW5BdWRpb0J1ZmZlckxvYWRlckZhY3RvcnkiLCJjbGllbnRUeXBlcyIsIk9iamVjdCIsImtleXMiLCJjb25maWciLCJhcHAiLCJjbGllbnRzIiwiaW5pdCIsInJvdXRlciIsInVzZSIsImZpbGVXYXRjaGVyIiwiZ2V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJzdGFydCIsIlByb2plY3QiLCJjb25maWd1cmVFeHBlcmllbmNlIiwiZXhwZXJpZW5jZSIsInBsdWdpbnMiLCJmb3JFYWNoIiwicGx1Z2luTmFtZSIsInJlcXVpcmUiLCJhZGRDbGllbnQiLCJjbGllbnQiLCJzZXQiLCJpZCIsInNvY2tldCIsImFkZExpc3RlbmVyIiwic2Vzc2lvbk5hbWUiLCJncmFwaFByZXNldCIsInV1aWQiLCJjcmVhdGVTZXNzaW9uIiwic2VuZCIsInNlc3Npb25JZCIsInJlc3VsdCIsImRlbGV0ZVNlc3Npb24iLCJmcm9tU291cmNlSWQiLCJ0b05vZGVJZCIsImNyZWF0ZVN0cmVhbVJvdXRlIiwiZGVsZXRlU3RyZWFtUm91dGUiLCJhZGRCaW5hcnlMaXN0ZW5lciIsImZyYW1lIiwicHJvcGFnYXRlU3RyZWFtRnJhbWUiLCJleGFtcGxlIiwic2Vzc2lvbnMiLCJoYXMiLCJzZXNzaW9uIiwiYWRkRXhhbXBsZSIsImV4YW1wbGVVdWlkIiwiZGVsZXRlRXhhbXBsZSIsImxhYmVsIiwiY2xlYXJFeGFtcGxlcyIsImNyZWF0ZUxhYmVsIiwib2xkTGFiZWwiLCJuZXdMYWJlbCIsInVwZGF0ZUxhYmVsIiwiZGVsZXRlTGFiZWwiLCJmaWxlbmFtZSIsImFjdGl2ZSIsInRvZ2dsZUF1ZGlvRmlsZSIsInJvdyIsImNyZWF0ZUxhYmVsQXVkaW9GaWxlUm93IiwiZGVsZXRlTGFiZWxBdWRpb0ZpbGVSb3ciLCJkZWxldGVDbGllbnQiLCJkZWxldGUiLCJjbGVhclN0cmVhbVJvdXRpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7OztBQUdBLE1BQU1BLElBQU4sQ0FBVztBQUNUO0FBQ0FDLEVBQUFBLFdBQVcsQ0FBQ0MsTUFBRCxFQUFTQyxpQkFBVCxFQUE0QkMsV0FBNUIsRUFBeUM7QUFDbEQsU0FBS0YsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0UsV0FBTCxHQUFtQkEsV0FBbkI7QUFDQSxTQUFLQyxnQkFBTCxHQUF3QkMsY0FBS0MsSUFBTCxDQUFVSixpQkFBVixFQUE2QkMsV0FBN0IsQ0FBeEI7QUFDQSxTQUFLSSxPQUFMLEdBQWUsSUFBZjtBQUVBLFNBQUtDLE9BQUwsR0FBZUEsY0FBZjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsZUFBZjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsZUFBZjtBQUVBLFNBQUtDLFdBQUwsR0FBbUIsSUFBSUMsR0FBSixFQUFu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T0l6RCxJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHNlcnZlU3RhdGljIGZyb20gJ3NlcnZlLXN0YXRpYyc7XG5pbXBvcnQgcGx1Z2luRmlsZVN5c3RlbUZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLWZpbGVzeXN0ZW0vc2VydmVyJztcbmltcG9ydCBwbHVnaW5QbGF0Zm9ybUZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLXBsYXRmb3JtL3NlcnZlcic7XG5pbXBvcnQgcGx1Z2luQ2hlY2tpbkZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLWNoZWNraW4vc2VydmVyJztcbmltcG9ydCBwbHVnaW5BdWRpb0J1ZmZlckxvYWRlckZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLWF1ZGlvLWJ1ZmZlci1sb2FkZXIvc2VydmVyJztcbmltcG9ydCBwbHVnaW5TeW5jRmFjdG9yeSBmcm9tICdAc291bmR3b3Jrcy9wbHVnaW4tc3luYy9zZXJ2ZXInO1xuaW1wb3J0IHBsdWdpblNjcmlwdGluZ0ZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLXNjcmlwdGluZy9zZXJ2ZXInO1xuaW1wb3J0IHBsdWdpbkxvZ2dlckZhY3RvcnkgZnJvbSAnQHNvdW5kd29ya3MvcGx1Z2luLWxvZ2dlci9zZXJ2ZXInO1xuXG5pbXBvcnQgc291cmNlcyBmcm9tICcuL3NvdXJjZXMvaW5kZXguanMnO1xuaW1wb3J0IG1vZHVsZXMgZnJvbSAnLi4vY29tbW9uL21vZHVsZXMvaW5kZXguanMnO1xuaW1wb3J0IGhlbHBlcnMgZnJvbSAnLi4vY29tbW9uL2hlbHBlcnMvaW5kZXguanMnO1xuXG5pbXBvcnQgUHJvamVjdCBmcm9tICcuL1Byb2plY3QuanMnO1xuXG5cbmNsYXNzIENvTW8ge1xuICAvLyBpbml0XG4gIGNvbnN0cnVjdG9yKHNlcnZlciwgcHJvamVjdHNEaXJlY3RvcnksIHByb2plY3ROYW1lKSB7XG4gICAgdGhpcy5zZXJ2ZXIgPSBzZXJ2ZXI7XG4gICAgdGhpcy5wcm9qZWN0TmFtZSA9IHByb2plY3ROYW1lO1xuICAgIHRoaXMucHJvamVjdERpcmVjdG9yeSA9IHBhdGguam9pbihwcm9qZWN0c0RpcmVjdG9yeSwgcHJvamVjdE5hbWUpO1xuICAgIHRoaXMucHJvamVjdCA9IG51bGw7XG5cbiAgICB0aGlzLnNvdXJjZXMgPSBzb3VyY2VzO1xuICAgIHRoaXMubW9kdWxlcyA9IG1vZHVsZXM7XG4gICAgdGhpcy5oZWxwZXJzID0gaGVscGVycztcblxuICAgIHRoaXMuaWRDbGllbnRNYXAgPSBuZXcgTWFwKCk7XG5cbiAgICAvLyByZWdpc3RlciBwbHVnaW5zIG5lZWRlZCBmb3JcbiAgICB0aGlzLnNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKCdmaWxlLXdhdGNoZXInLCBwbHVnaW5GaWxlU3lzdGVtRmFjdG9yeSwge1xuICAgICAgZGlyZWN0b3JpZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6ICdhdWRpbycsXG4gICAgICAgICAgcGF0aDogcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ2F1ZGlvJyksXG4gICAgICAgICAgcHVibGljRGlyZWN0b3J5OiAnYXVkaW8nLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ3Nlc3Npb25zJyxcbiAgICAgICAgICBwYXRoOiBwYXRoLmpvaW4odGhpcy5wcm9qZWN0RGlyZWN0b3J5LCAnc2Vzc2lvbnMnKSxcbiAgICAgICAgICBwdWJsaWNEaXJlY3Rvcnk6ICdzZXNzaW9ucycsXG4gICAgICAgIH0sXG4gICAgICAgIHsgLy8gZm9yIG5vdywgd2UgY2FuJ3QgY3JlYXRlIHByZXNldHMgZHluYW1pY2FsbHlcbiAgICAgICAgICBuYW1lOiAncHJlc2V0cycsXG4gICAgICAgICAgcGF0aDogcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ3ByZXNldHMnKSxcbiAgICAgICAgICBwdWJsaWNEaXJlY3Rvcnk6ICdwcmVzZXRzJyxcbiAgICAgICAgfVxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ2xvZ2dlcicsIHBsdWdpbkxvZ2dlckZhY3RvcnksIHtcbiAgICAgIGRpcmVjdG9yeTogcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ3JlY29yZGluZ3MnKSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHNjcmlwdHNEYXRhRGlyID0gcGF0aC5qb2luKHRoaXMucHJvamVjdERpcmVjdG9yeSwgJ3NjcmlwdHMvZGF0YScpO1xuICAgIGNvbnN0IHNjcmlwdHNBdWRpb0RpciA9IHBhdGguam9pbih0aGlzLnByb2plY3REaXJlY3RvcnksICdzY3JpcHRzL2F1ZGlvJyk7XG5cbiAgICB0aGlzLnNlcnZlci5wbHVnaW5NYW5hZ2VyLnJlZ2lzdGVyKCdzY3JpcHRzLWRhdGEnLCBwbHVnaW5TY3JpcHRpbmdGYWN0b3J5LCB7XG4gICAgICBkaXJlY3Rvcnk6IHNjcmlwdHNEYXRhRGlyLFxuICAgICAgZGVmYXVsdFNjcmlwdFZhbHVlOiBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKHNjcmlwdHNEYXRhRGlyLCAnZGVmYXVsdC5qcycpKS50b1N0cmluZygpLFxuICAgIH0pO1xuXG4gICAgdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3Rlcignc2NyaXB0cy1hdWRpbycsIHBsdWdpblNjcmlwdGluZ0ZhY3RvcnksIHtcbiAgICAgIGRpcmVjdG9yeTogc2NyaXB0c0F1ZGlvRGlyLFxuICAgICAgZGVmYXVsdFNjcmlwdFZhbHVlOiBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKHNjcmlwdHNBdWRpb0RpciwgJ2RlZmF1bHQuanMnKSkudG9TdHJpbmcoKSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ3N5bmMnLCBwbHVnaW5TeW5jRmFjdG9yeSk7XG4gICAgdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3RlcigncGxhdGZvcm0nLCBwbHVnaW5QbGF0Zm9ybUZhY3RvcnkpO1xuICAgIHRoaXMuc2VydmVyLnBsdWdpbk1hbmFnZXIucmVnaXN0ZXIoJ2NoZWNraW4nLCBwbHVnaW5DaGVja2luRmFjdG9yeSk7XG4gICAgdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5yZWdpc3RlcignYXVkaW8tYnVmZmVyLWxvYWRlcicsIHBsdWdpbkF1ZGlvQnVmZmVyTG9hZGVyRmFjdG9yeSk7XG4gIH1cblxuICBnZXQgY2xpZW50VHlwZXMoKSB7XG4gICAgY29uc3QgY2xpZW50VHlwZXMgPSBPYmplY3Qua2V5cyh0aGlzLnNlcnZlci5jb25maWcuYXBwLmNsaWVudHMpO1xuICAgIHJldHVybiBjbGllbnRUeXBlcztcbiAgfVxuXG4gIGFzeW5jIGluaXQoY29uZmlnKSB7XG4gICAgLy8gb3BlbiBwdWJsaWMgcm91dGUgZm9yIGF1ZGlvIGZpbGVzXG4gICAgdGhpcy5zZXJ2ZXIucm91dGVyLnVzZSgnYXVkaW8nLCBzZXJ2ZVN0YXRpYyhwYXRoLmpvaW4odGhpcy5wcm9qZWN0RGlyZWN0b3J5LCAnYXVkaW8nKSkpO1xuICAgIC8vIHByb2plY3RzIG5lZWRzIHRoZSBmaWxlIHdhdGNoZXJcbiAgICB0aGlzLmZpbGVXYXRjaGVyID0gdGhpcy5zZXJ2ZXIucGx1Z2luTWFuYWdlci5nZXQoJ2ZpbGUtd2F0Y2hlcicpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0KCkge1xuICAgIC8vIHNlcnZlciBpcyBzdGFydGVkIGFuZCBhbGwgcGx1Z2lucyBhcmUgcmVhZHlcbiAgICB0aGlzLnByb2plY3QgPSBuZXcgUHJvamVjdCh0aGlzKTtcbiAgICBhd2FpdCB0aGlzLnByb2plY3QuaW5pdCgpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgfVxuXG4gIGNvbmZpZ3VyZUV4cGVyaWVuY2UoZXhwZXJpZW5jZSkge1xuICAgIHRoaXMuZXhwZXJpZW5jZSA9IGV4cGVyaWVuY2U7XG4gICAgdGhpcy5leHBlcmllbmNlLnBsdWdpbnMgPSB7fTtcblxuICAgIGNvbnN0IHBsdWdpbnMgPSBbXG4gICAgICAnZmlsZS13YXRjaGVyJyxcbiAgICAgICdzeW5jJyxcbiAgICAgICdwbGF0Zm9ybScsXG4gICAgICAnY2hlY2tpbicsXG4gICAgICAnYXVkaW8tYnVmZmVyLWxvYWRlcicsXG4gICAgICAnc2NyaXB0cy1kYXRhJyxcbiAgICAgICdzY3JpcHRzLWF1ZGlvJyxcbiAgICAgICdsb2dnZXInLFxuICAgIF07XG5cbiAgICBwbHVnaW5zLmZvckVhY2gocGx1Z2luTmFtZSA9PiB7XG4gICAgICB0aGlzLmV4cGVyaWVuY2UucGx1Z2luc1twbHVnaW5OYW1lXSA9IHRoaXMuZXhwZXJpZW5jZS5yZXF1aXJlKHBsdWdpbk5hbWUpO1xuICAgIH0pO1xuICB9XG5cbiAgYWRkQ2xpZW50KGNsaWVudCkge1xuICAgIHRoaXMuaWRDbGllbnRNYXAuc2V0KGNsaWVudC5pZCwgY2xpZW50KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86cHJvamVjdDpjcmVhdGVTZXNzaW9uOnJlcWAsIGFzeW5jIChzZXNzaW9uTmFtZSwgZ3JhcGhQcmVzZXQpID0+IHtcbiAgICAgIGNvbnN0IHV1aWQgPSBhd2FpdCB0aGlzLnByb2plY3QuY3JlYXRlU2Vzc2lvbihzZXNzaW9uTmFtZSwgZ3JhcGhQcmVzZXQpO1xuXG4gICAgICBpZiAodXVpZCAhPT0gbnVsbCkge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpjcmVhdGVTZXNzaW9uOmFja2AsIHV1aWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnByb2plY3Q6Y3JlYXRlU2Vzc2lvbjplcnJgLCAnc2Vzc2lvbiBhbHJlYWR5IGV4aXN0cycpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpwcm9qZWN0OmRlbGV0ZVNlc3Npb246cmVxYCwgYXN5bmMgKHNlc3Npb25JZCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wcm9qZWN0LmRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkKTtcblxuICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOmFja2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnByb2plY3Q6ZGVsZXRlU2Vzc2lvbjplcnJgLCAnc2Vzc2lvbiAke3Nlc3Npb25JZH0gZG9lcyBub3QgZXhpc3RzJyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBzdHJlYW1zIHJvdXRpbmcgZGVmaW5pdGlvbnNcbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6cmVxYCwgYXN5bmMgKGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucHJvamVjdC5jcmVhdGVTdHJlYW1Sb3V0ZShmcm9tU291cmNlSWQsIHRvTm9kZUlkKTtcblxuICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTphY2tgLCByZXN1bHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6ZXJyYCxcbiAgICAgICAgICBgYW4gZXJyb3Igb2NjdXJlZCBjcmVhdGluZyByb3V0ZSBbJHtmcm9tU291cmNlSWR9LCAke3RvTm9kZUlkfV1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTpyZXFgLCBhc3luYyAoZnJvbVNvdXJjZUlkLCB0b05vZGVJZCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wcm9qZWN0LmRlbGV0ZVN0cmVhbVJvdXRlKGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpO1xuXG4gICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7XG4gICAgICAgIGNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOmFja2AsIHJlc3VsdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTplcnJgLFxuICAgICAgICAgIGBhbiBlcnJvciBvY2N1cmVkIGNyZWF0aW5nIHJvdXRlIFske2Zyb21Tb3VyY2VJZH0sICR7dG9Ob2RlSWR9XWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gc3RyZWFtcyByb3V0aW5nXG4gICAgY2xpZW50LnNvY2tldC5hZGRCaW5hcnlMaXN0ZW5lcignc3RyZWFtJywgZnJhbWUgPT4ge1xuICAgICAgdGhpcy5wcm9qZWN0LnByb3BhZ2F0ZVN0cmVhbUZyYW1lKGZyYW1lKTtcbiAgICB9KTtcblxuXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gc2Vzc2lvbiBtYW5hZ2VtZW50XG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpzZXNzaW9uOmFkZEV4YW1wbGVgLCBhc3luYyAoc2Vzc2lvbklkLCBleGFtcGxlKSA9PiB7XG4gICAgICBpZiAodGhpcy5wcm9qZWN0LnNlc3Npb25zLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnByb2plY3Quc2Vzc2lvbnMuZ2V0KHNlc3Npb25JZCk7XG4gICAgICAgIHNlc3Npb24uYWRkRXhhbXBsZShleGFtcGxlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86c2Vzc2lvbjpkZWxldGVFeGFtcGxlYCwgYXN5bmMgKHNlc3Npb25JZCwgZXhhbXBsZVV1aWQpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5kZWxldGVFeGFtcGxlKGV4YW1wbGVVdWlkKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86c2Vzc2lvbjpjbGVhckV4YW1wbGVzYCwgYXN5bmMgKHNlc3Npb25JZCwgbGFiZWwgPSBudWxsKSA9PiB7XG4gICAgICBpZiAodGhpcy5wcm9qZWN0LnNlc3Npb25zLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnByb2plY3Quc2Vzc2lvbnMuZ2V0KHNlc3Npb25JZCwgbGFiZWwpO1xuICAgICAgICBzZXNzaW9uLmNsZWFyRXhhbXBsZXMobGFiZWwpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpzZXNzaW9uOmNyZWF0ZUxhYmVsYCwgYXN5bmMgKHNlc3Npb25JZCwgbGFiZWwpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5jcmVhdGVMYWJlbChsYWJlbCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnNlc3Npb246dXBkYXRlTGFiZWxgLCBhc3luYyAoc2Vzc2lvbklkLCBvbGRMYWJlbCwgbmV3TGFiZWwpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi51cGRhdGVMYWJlbChvbGRMYWJlbCwgbmV3TGFiZWwpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihgY29tbzpzZXNzaW9uOmRlbGV0ZUxhYmVsYCwgYXN5bmMgKHNlc3Npb25JZCwgbGFiZWwpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5kZWxldGVMYWJlbChsYWJlbCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnNlc3Npb246dG9nZ2xlQXVkaW9GaWxlYCwgYXN5bmMgKHNlc3Npb25JZCwgZmlsZW5hbWUsIGFjdGl2ZSkgPT4ge1xuICAgICAgaWYgKHRoaXMucHJvamVjdC5zZXNzaW9ucy5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5wcm9qZWN0LnNlc3Npb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBzZXNzaW9uLnRvZ2dsZUF1ZGlvRmlsZShmaWxlbmFtZSwgYWN0aXZlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYGNvbW86c2Vzc2lvbjpjcmVhdGVMYWJlbEF1ZGlvRmlsZVJvd2AsIGFzeW5jIChzZXNzaW9uSWQsIHJvdykgPT4ge1xuICAgICAgaWYgKHRoaXMucHJvamVjdC5zZXNzaW9ucy5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5wcm9qZWN0LnNlc3Npb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBzZXNzaW9uLmNyZWF0ZUxhYmVsQXVkaW9GaWxlUm93KHJvdyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGBjb21vOnNlc3Npb246ZGVsZXRlTGFiZWxBdWRpb0ZpbGVSb3dgLCBhc3luYyAoc2Vzc2lvbklkLCByb3cpID0+IHtcbiAgICAgIGlmICh0aGlzLnByb2plY3Quc2Vzc2lvbnMuaGFzKHNlc3Npb25JZCkpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMucHJvamVjdC5zZXNzaW9ucy5nZXQoc2Vzc2lvbklkKTtcbiAgICAgICAgc2Vzc2lvbi5kZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyhyb3cpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZGVsZXRlQ2xpZW50KGNsaWVudCkge1xuICAgIHRoaXMuaWRDbGllbnRNYXAuZGVsZXRlKGNsaWVudC5pZCwgY2xpZW50KTtcbiAgICB0aGlzLnByb2plY3QuY2xlYXJTdHJlYW1Sb3V0aW5nKG51bGwsIGNsaWVudC5pZCk7IC8vIGNsZWFyIHJvdXRpbmcgd2hlcmUgY2xpZW50IGlzIHRoZSB0YXJnZXRcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBDb01vO1xuXG4iXX0=