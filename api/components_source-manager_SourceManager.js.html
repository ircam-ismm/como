<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>components/source-manager/SourceManager.js - como</title>
    
    <meta name="description" content="Documentation of the como framework" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/overrides.css">
    <script src="scripts/nav.js" defer></script>
    
    
    <link rel="icon" href="/como/favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    
        <h2 class="home">
            <a href="index.html" style="background-image: url('/como/logo-200x200.png')">
                Home
            </a>
        </h2>
    <h2><a href="../" class="menu-item" >Website</a></h2><h2><a href="https://github.com/ircam-ismm/como" target="_blank" class="menu-item" >Github</a></h2><h3>Classes</h3><ul><li><a href="ComoClient.html">ComoClient</a><ul class='members'><li data-type='member' style='display: none;'><a href="ComoClient.html#audioBufferLoader">audioBufferLoader</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#audioContext">audioContext</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#audioScheduler">audioScheduler</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#components">components</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#host">host</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#id">id</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#keyValueStore">keyValueStore</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#nodeId">nodeId</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#playerManager">playerManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#pluginManager">pluginManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#projectManager">projectManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#role">role</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#runtime">runtime</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#scheduler">scheduler</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#scriptManager">scriptManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#sessionManager">sessionManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#soundbankManager">soundbankManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#sourceManager">sourceManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#stateManager">stateManager</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="ComoClient.html#init">init</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#requestRfc">requestRfc</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#setProject">setProject</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#setRfcHandler">setRfcHandler</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#setRfcResolverHook">setRfcResolverHook</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#start">start</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#stop">stop</a></li></ul></li><li><a href="ComoNode.html">ComoNode</a><ul class='members'><li data-type='member' style='display: none;'><a href="ComoNode.html#audioBufferLoader">audioBufferLoader</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#audioContext">audioContext</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#audioScheduler">audioScheduler</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#components">components</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#host">host</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#id">id</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#nodeId">nodeId</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#pluginManager">pluginManager</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#role">role</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#runtime">runtime</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#scheduler">scheduler</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#stateManager">stateManager</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="ComoNode.html#init">init</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#requestRfc">requestRfc</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#setProject">setProject</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#setRfcHandler">setRfcHandler</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#setRfcResolverHook">setRfcResolverHook</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#start">start</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#stop">stop</a></li></ul></li><li><a href="ComoServer.html">ComoServer</a><ul class='members'><li data-type='member' style='display: none;'><a href="ComoServer.html#audioBufferLoader">audioBufferLoader</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#audioContext">audioContext</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#audioScheduler">audioScheduler</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#components">components</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#host">host</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#id">id</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#keyValueStore">keyValueStore</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#nodeId">nodeId</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#playerManager">playerManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#pluginManager">pluginManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#projectManager">projectManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#role">role</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#runtime">runtime</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#scheduler">scheduler</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#scriptManager">scriptManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#sessionManager">sessionManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#soundbankManager">soundbankManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#sourceManager">sourceManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#stateManager">stateManager</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="ComoServer.html#init">init</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#requestRfc">requestRfc</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#setProject">setProject</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#setRfcHandler">setRfcHandler</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#setRfcResolverHook">setRfcResolverHook</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#start">start</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#stop">stop</a></li></ul></li><li><a href="KeyValueStore.html">KeyValueStore</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KeyValueStore.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="KeyValueStore.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="KeyValueStore.html#get">get</a></li><li data-type='method' style='display: none;'><a href="KeyValueStore.html#set">set</a></li></ul></li><li><a href="KeyValueStoreClient.html">KeyValueStoreClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KeyValueStoreClient.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="KeyValueStoreClient.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="KeyValueStoreClient.html#get">get</a></li><li data-type='method' style='display: none;'><a href="KeyValueStoreClient.html#set">set</a></li></ul></li><li><a href="KeyValueStoreServer.html">KeyValueStoreServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KeyValueStoreServer.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="KeyValueStoreServer.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="KeyValueStoreServer.html#get">get</a></li><li data-type='method' style='display: none;'><a href="KeyValueStoreServer.html#set">set</a></li></ul></li><li><a href="ScriptManager.html">ScriptManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ScriptManager.html#attach">attach</a></li><li data-type='method' style='display: none;'><a href="ScriptManager.html#getCollection">getCollection</a></li><li data-type='method' style='display: none;'><a href="ScriptManager.html#getList">getList</a></li><li data-type='method' style='display: none;'><a href="ScriptManager.html#onUpdate">onUpdate</a></li></ul></li><li><a href="ScriptManagerClient.html">ScriptManagerClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#attach">attach</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#getCollection">getCollection</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#getList">getList</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#onUpdate">onUpdate</a></li></ul></li><li><a href="ScriptManagerServer.html">ScriptManagerServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#attach">attach</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#getCollection">getCollection</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#getList">getList</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SessionManager.html">SessionManager</a><ul class='members'><li data-type='member' style='display: none;'><a href="SessionManager.html#sessions">sessions</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SessionManager.html#createSession">createSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#getSessionBus">getSessionBus</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#getSessionSoundbank">getSessionSoundbank</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#persistSession">persistSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#renameSession">renameSession</a></li></ul></li><li><a href="SessionManagerClient.html">SessionManagerClient</a><ul class='members'><li data-type='member' style='display: none;'><a href="SessionManagerClient.html#sessions">sessions</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#createSession">createSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#getSessionBus">getSessionBus</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#getSessionSoundbank">getSessionSoundbank</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#persistSession">persistSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#renameSession">renameSession</a></li></ul></li><li><a href="SessionManagerServer.html">SessionManagerServer</a><ul class='members'><li data-type='member' style='display: none;'><a href="SessionManagerServer.html#sessions">sessions</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#createSession">createSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#getSessionBus">getSessionBus</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#getSessionSoundbank">getSessionSoundbank</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#persistSession">persistSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#renameSession">renameSession</a></li></ul></li><li><a href="SoundbankManager.html">SoundbankManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoundbankManager.html#getBuffer">getBuffer</a></li><li data-type='method' style='display: none;'><a href="SoundbankManager.html#getBuffers">getBuffers</a></li><li data-type='method' style='display: none;'><a href="SoundbankManager.html#getTreeAsUrlMap">getTreeAsUrlMap</a></li><li data-type='method' style='display: none;'><a href="SoundbankManager.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SoundbankManagerClient.html">SoundbankManagerClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#getBuffer">getBuffer</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#getBuffers">getBuffers</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#getTreeAsUrlMap">getTreeAsUrlMap</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SoundbankManagerServer.html">SoundbankManagerServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#getBuffer">getBuffer</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#getBuffers">getBuffers</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#getTreeAsUrlMap">getTreeAsUrlMap</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SourceManager.html">SourceManager</a><ul class='members'><li data-type='member' style='display: none;'><a href="SourceManager.html#list">list</a></li><li data-type='member' style='display: none;'><a href="SourceManager.html#sources">sources</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SourceManager.html#createSource">createSource</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#deleteRecording">deleteRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#deleteSource">deleteSource</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#getSource">getSource</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#getSourceFiltered">getSourceFiltered</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#listRecordings">listRecordings</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#readRecording">readRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#sourceExists">sourceExists</a></li></ul></li><li><a href="SourceManagerClient.html">SourceManagerClient</a><ul class='members'><li data-type='member' style='display: none;'><a href="SourceManagerClient.html#list">list</a></li><li data-type='member' style='display: none;'><a href="SourceManagerClient.html#sources">sources</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#createSource">createSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#deleteRecording">deleteRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#deleteSource">deleteSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#getSource">getSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#getSourceFiltered">getSourceFiltered</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#listRecordings">listRecordings</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#readRecording">readRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#sourceExists">sourceExists</a></li></ul></li><li><a href="SourceManagerServer.html">SourceManagerServer</a><ul class='members'><li data-type='member' style='display: none;'><a href="SourceManagerServer.html#list">list</a></li><li data-type='member' style='display: none;'><a href="SourceManagerServer.html#sources">sources</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#createSource">createSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#deleteRecording">deleteRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#deleteSource">deleteSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#getSource">getSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#getSourceFiltered">getSourceFiltered</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#listRecordings">listRecordings</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#readRecording">readRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#sourceExists">sourceExists</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">components/source-manager/SourceManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ComoComponent from '../../core/ComoComponent.js';

import {
  isPlainObject,
} from '@ircam/sc-utils';

import SourceFactory from '#sources/factory.js';

/**
 * The SourceManager component is responsible for creating and dispatching
 * sources of motion sensors.
 *
 * Como sources are represented as soundworks SharedState and act as
 * middlewares between the actual sources of data (e.g. hardware) and the application, e.g.:
 * ```
 * motion sensor -- [OSC] -> como source -- [websocket / SharedState] -> como application
 * ```
 * Hence, the como source can exists but be inactive due to its underlying motion
 * sensor being shutdown.
 *
 * Como source stream must output a stream that follows the specification defined
 * here: &lt;https://github.com/ircam-ismm/sc-motion/blob/main/FORMAT.md>
 *
 * The shared state is defined by the following parameters:
 * - `id` - id of the source
 * - `type` - type of the "real" source of motion data
 * - `nodeId` - node who owns the source
 * - `infos` - information (e.g. OSC config) used to configure the source
 * - `frame` - motion data stream
 * - `active` - whether the underlying sensor is active or not
 * - `record` - if true record the source on the filesystem
 *
 * @example
 * import { Client } from '@soundworks/core/client.js';
 * import ComoClient from '@ircam/como/ComoClient.js';
 *
 * const client = new Client(config);
 * const como = new ComoClient(client);
 * await como.start();
 *
 * const sourceId = await como.sourceManager.createSource({
 *   type: 'riot',
 *   id: '0',
 *   port: 8081,
 *   verbose: false,
 * });
 */
class SourceManager extends ComoComponent {
  #recordingFilesystem;
  #ownedSources = new Set(); // owned sources created on this node
  #sources;
  #factory;

  /**
   * The SourceManager component is automatically created by the {@link ComoNode} instance.
   *
   * _This constructor should never be called manually_
   * @param {ComoNode} como
   * @param {String} name
   */
  constructor(como, name) {
    super(como, name);

    this.#factory = new SourceFactory(como);
  }

  /**
   * Lightweight collection of all the sources on the network. The collection
   * only contains information that allows to monitor or control the sources,
   * but does not contain the actual stream of data.
   *
   * If a node is interested in a particular motion stream source, it should
   * explicity retrieve to the "full" source using {@link SourceManager#getSource}.
   *
   * @readonly
   * @type {SharedStateCollection}
   */
  get sources() {
    return this.#sources;
  }

  /**
   * List of current source ids.
   *
   * @readonly
   * @type {Array&lt;String>}
   */
  get list() {
    return this.#sources.get('id');
  }

  /**
   * SourceManagerServer requires access to the plugin
   * @private
   */
  get recordingFilesystem() {
    return this.#recordingFilesystem;
  }

  /** @private */
  async start() {
    await super.start();

    this.#recordingFilesystem = await this.como.pluginManager.get(`${this.name}:filesystem`);

    this.#sources = await this.como.stateManager.getCollection(`${this.name}:source`,
      // parameter whitelist - we really don't want the streams here
      // @todo - move to blacklist once implemented in soundworks
      ['id', 'type', 'infos', 'active', 'record', 'control']
    );

    this.como.setRfcHandler(`${this.name}:createSource`, this.#createSourceHandler);
    this.como.setRfcHandler(`${this.name}:deleteSource`, this.#deleteSourceHandler);

    this.como.setRfcResolverHook(`${this.name}:createSource`, this.#createSourceResolverHook);
  }

  /** @private */
  async stop() {
    await super.stop();

    await this.#sources.detach();

    for (let source of this.#ownedSources.values()) {
      await source.delete();
    }

    this.#factory.stop();
  }

  /**
   * Check whether the given source id correspond to an existing source
   *
   * @param {String} sourceId
   * @returns {Boolean}
   */
  sourceExists(sourceId) {
    return !!this.sources.find(s => s.get('id') === sourceId);
  }

  /**
   * Return the lightweight version of a source (i.e. without its stream) from its id.
   *
   * @param {String} sourceId
   * @returns {SharedState|undefined}
   */
  getSourceFiltered(sourceId) {
    return this.sources.find(source => source.get('id') === sourceId);
  }

  /**
   * Retrieve the full version of a source (i.e. with its stream) from its id.
   *
   * If the node is the owner of the source, the retrieved source will be the owned
   * original instance of the shared state.
   *
   * @param {String} sourceId
   * @returns {SharedState|null}
   */
  async getSource(sourceId) {
    // if the source has been created on this node, return the underlying owned source state
    const owned = Array.from(this.#ownedSources).find(source => source.id === sourceId);
    if (owned) {
      return owned.state;
    }

    // if the source has been created on another node, attach to the "real" source
    const notOwned = this.sources.find(s => s.get('id') === sourceId);
    if (notOwned) {
      return await this.como.stateManager.attach(`${this.name}:source`, notOwned.id);
    }

    // source does not exits
    return null;
  }

  /**
   * Create a new como source.
   *
   * @param {Object} config - The configuration object for the source.
   * @param {String} [nodeId=this.como.nodeId] - If given, creates the source on
   *  given como node.
   * @returns {String} The id of the created source
   */
  async createSource(config, nodeId = this.como.nodeId) {
    if (!isPlainObject(config)) {
      throw new Error(`Cannot execute "createSource" on SourceManager: argument 1 is not an object`);
    }

    if (!('id' in config)) {
      throw new Error(`Cannot execute "createSource" on SourceManager: config.id is not defined`);
    }

    const exists = this.#sources.find(source => source.get('id') === config.id);

    if (exists) {
      throw new Error(`Cannot execute "createSource" on SourceManager: a source with id "${config.id}" already exists`);
    }

    // always go though the rfc roundtrip, even if `nodeId = this.como.nodeId`,
    // to benefit from the hook logic
    // @note - this could be optimized within the Rfc logic
    return await this.como.requestRfc(nodeId, `${this.name}:createSource`, config);
  }

  /**
   * _NOT IMPLEMENTED YET_
   *
   * Delete an existing source.
   */
  async deleteSource(config, nodeId = this.como.nodeId) {
    // always go though the rfc roundtrip, even if `nodeId = this.como.nodeId`,
    // to benefit from the hook logic
    // @note - this could be optimized within the Rfc logic
    return await this.como.requestRfc(nodeId, `${this.name}:deleteSource`, config);
  }


  #createSourceHandler = async (config) => {
    const source = await this.#factory.createSource(config);
    this.#ownedSources.add(source);

    return source.id;
  }

  #createSourceResolverHook = async (err, sourceId) => {
    if (err) {
      return;
    }

    // make sure the new source is in the list before we resolve `createSource`
    // cf. https://github.com/collective-soundworks/soundworks/issues/118
    //
    // 1. check that the source is not already in list, this may happen server-side
    const source = this.como.sourceManager.sources.find(s => s.get('id') === sourceId);

    if (source !== undefined) {
      return Promise.resolve();
    }

    // 2. else, wait for the source to attach to the collection before resolving
    return new Promise(resolve => {
      // detach listener will be defined as we will be asynchronous
      //
      const detachListener = this.como.sourceManager.sources.onAttach(source => {
        // console.log(source.get('id'), sourceId);
        if (source.get('id') === sourceId) {
          detachListener();
          resolve();
        }
      });
    });
  }

  #deleteSourceHandler = async (config) => {
    return this.#factory.deleteSource(config);
  }

  // ----------------------------------------------------------------------
  // RECORDINGS MANAGEMENT
  // ----------------------------------------------------------------------

  /**
   * Returns the list of the existing recordings.
   *
   * @returns {Object} The file tree of the projects's recordings directory
   */
  listRecordings() {
    return this.#recordingFilesystem.getTree();
  }

  /**
   * Retrieve the content of a given recording.
   * @param {Filename} Filename - Filename of the recording
   * @returns {Blob}
   */
  async readRecording(filename) {
    return await this.#recordingFilesystem.readFile(filename);
  }

  /**
   * Delete a given recording.
   * @param {Filename} Filename - Filename of the recording
   */
  async deleteRecording(filename) {
    return await this.#recordingFilesystem.rm(filename);
  }
}

export default SourceManager;
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Wed Feb 18 2026 18:46:51 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
