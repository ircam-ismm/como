<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>core/ComoNode.js - como</title>
    
    <meta name="description" content="Documentation of the como framework" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/overrides.css">
    <script src="scripts/nav.js" defer></script>
    
    
    <link rel="icon" href="/como/favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    
        <h2 class="home">
            <a href="index.html" style="background-image: url('/como/logo-200x200.png')">
                Home
            </a>
        </h2>
    <h2><a href="../" class="menu-item" >Website</a></h2><h2><a href="https://github.com/ircam-ismm/como" target="_blank" class="menu-item" >Github</a></h2><h3>Classes</h3><ul><li><a href="ComoClient.html">ComoClient</a><ul class='members'><li data-type='member' style='display: none;'><a href="ComoClient.html#audioBufferLoader">audioBufferLoader</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#audioContext">audioContext</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#audioScheduler">audioScheduler</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#components">components</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#host">host</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#id">id</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#nodeId">nodeId</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#playerManager">playerManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#pluginManager">pluginManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#projectManager">projectManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#role">role</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#runtime">runtime</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#scheduler">scheduler</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#scriptManager">scriptManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#sessionManager">sessionManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#soundbankManager">soundbankManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#sourceManager">sourceManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#stateManager">stateManager</a></li><li data-type='member' style='display: none;'><a href="ComoClient.html#store">store</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="ComoClient.html#init">init</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#requestRfc">requestRfc</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#setProject">setProject</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#setRfcHandler">setRfcHandler</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#setRfcResolverHook">setRfcResolverHook</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#start">start</a></li><li data-type='method' style='display: none;'><a href="ComoClient.html#stop">stop</a></li></ul></li><li><a href="ComoNode.html">ComoNode</a><ul class='members'><li data-type='member' style='display: none;'><a href="ComoNode.html#audioBufferLoader">audioBufferLoader</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#audioContext">audioContext</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#audioScheduler">audioScheduler</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#components">components</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#host">host</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#id">id</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#nodeId">nodeId</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#pluginManager">pluginManager</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#role">role</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#runtime">runtime</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#scheduler">scheduler</a></li><li data-type='member' style='display: none;'><a href="ComoNode.html#stateManager">stateManager</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="ComoNode.html#init">init</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#requestRfc">requestRfc</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#setProject">setProject</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#setRfcHandler">setRfcHandler</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#setRfcResolverHook">setRfcResolverHook</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#start">start</a></li><li data-type='method' style='display: none;'><a href="ComoNode.html#stop">stop</a></li></ul></li><li><a href="ComoServer.html">ComoServer</a><ul class='members'><li data-type='member' style='display: none;'><a href="ComoServer.html#audioBufferLoader">audioBufferLoader</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#audioContext">audioContext</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#audioScheduler">audioScheduler</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#components">components</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#host">host</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#id">id</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#nodeId">nodeId</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#playerManager">playerManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#pluginManager">pluginManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#projectManager">projectManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#role">role</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#runtime">runtime</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#scheduler">scheduler</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#scriptManager">scriptManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#sessionManager">sessionManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#soundbankManager">soundbankManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#sourceManager">sourceManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#stateManager">stateManager</a></li><li data-type='member' style='display: none;'><a href="ComoServer.html#store">store</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="ComoServer.html#init">init</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#requestRfc">requestRfc</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#setProject">setProject</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#setRfcHandler">setRfcHandler</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#setRfcResolverHook">setRfcResolverHook</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#start">start</a></li><li data-type='method' style='display: none;'><a href="ComoServer.html#stop">stop</a></li></ul></li><li><a href="ScriptManager.html">ScriptManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ScriptManager.html#attach">attach</a></li><li data-type='method' style='display: none;'><a href="ScriptManager.html#getCollection">getCollection</a></li><li data-type='method' style='display: none;'><a href="ScriptManager.html#getList">getList</a></li><li data-type='method' style='display: none;'><a href="ScriptManager.html#onUpdate">onUpdate</a></li></ul></li><li><a href="ScriptManagerClient.html">ScriptManagerClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#attach">attach</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#getCollection">getCollection</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#getList">getList</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerClient.html#onUpdate">onUpdate</a></li></ul></li><li><a href="ScriptManagerServer.html">ScriptManagerServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#attach">attach</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#getCollection">getCollection</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#getList">getList</a></li><li data-type='method' style='display: none;'><a href="ScriptManagerServer.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SessionManager.html">SessionManager</a><ul class='members'><li data-type='member' style='display: none;'><a href="SessionManager.html#sessions">sessions</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SessionManager.html#createSession">createSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#getSessionBus">getSessionBus</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#getSessionSoundbank">getSessionSoundbank</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#persistSession">persistSession</a></li><li data-type='method' style='display: none;'><a href="SessionManager.html#renameSession">renameSession</a></li></ul></li><li><a href="SessionManagerClient.html">SessionManagerClient</a><ul class='members'><li data-type='member' style='display: none;'><a href="SessionManagerClient.html#sessions">sessions</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#createSession">createSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#getSessionBus">getSessionBus</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#getSessionSoundbank">getSessionSoundbank</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#persistSession">persistSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerClient.html#renameSession">renameSession</a></li></ul></li><li><a href="SessionManagerServer.html">SessionManagerServer</a><ul class='members'><li data-type='member' style='display: none;'><a href="SessionManagerServer.html#sessions">sessions</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#createSession">createSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#deleteSession">deleteSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#getSession">getSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#getSessionBus">getSessionBus</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#getSessionSoundbank">getSessionSoundbank</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#persistSession">persistSession</a></li><li data-type='method' style='display: none;'><a href="SessionManagerServer.html#renameSession">renameSession</a></li></ul></li><li><a href="SoundbankManager.html">SoundbankManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoundbankManager.html#getBuffer">getBuffer</a></li><li data-type='method' style='display: none;'><a href="SoundbankManager.html#getBuffers">getBuffers</a></li><li data-type='method' style='display: none;'><a href="SoundbankManager.html#getTreeAsUrlMap">getTreeAsUrlMap</a></li><li data-type='method' style='display: none;'><a href="SoundbankManager.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SoundbankManagerClient.html">SoundbankManagerClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#getBuffer">getBuffer</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#getBuffers">getBuffers</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#getTreeAsUrlMap">getTreeAsUrlMap</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerClient.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SoundbankManagerServer.html">SoundbankManagerServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#getBuffer">getBuffer</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#getBuffers">getBuffers</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#getTreeAsUrlMap">getTreeAsUrlMap</a></li><li data-type='method' style='display: none;'><a href="SoundbankManagerServer.html#onUpdate">onUpdate</a></li></ul></li><li><a href="SourceManager.html">SourceManager</a><ul class='members'><li data-type='member' style='display: none;'><a href="SourceManager.html#list">list</a></li><li data-type='member' style='display: none;'><a href="SourceManager.html#sources">sources</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SourceManager.html#createSource">createSource</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#deleteRecording">deleteRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#deleteSource">deleteSource</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#getSource">getSource</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#getSourceFiltered">getSourceFiltered</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#listRecordings">listRecordings</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#readRecording">readRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManager.html#sourceExists">sourceExists</a></li></ul></li><li><a href="SourceManagerClient.html">SourceManagerClient</a><ul class='members'><li data-type='member' style='display: none;'><a href="SourceManagerClient.html#list">list</a></li><li data-type='member' style='display: none;'><a href="SourceManagerClient.html#sources">sources</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#createSource">createSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#deleteRecording">deleteRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#deleteSource">deleteSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#getSource">getSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#getSourceFiltered">getSourceFiltered</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#listRecordings">listRecordings</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#readRecording">readRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerClient.html#sourceExists">sourceExists</a></li></ul></li><li><a href="SourceManagerServer.html">SourceManagerServer</a><ul class='members'><li data-type='member' style='display: none;'><a href="SourceManagerServer.html#list">list</a></li><li data-type='member' style='display: none;'><a href="SourceManagerServer.html#sources">sources</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#createSource">createSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#deleteRecording">deleteRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#deleteSource">deleteSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#getSource">getSource</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#getSourceFiltered">getSourceFiltered</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#listRecordings">listRecordings</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#readRecording">readRecording</a></li><li data-type='method' style='display: none;'><a href="SourceManagerServer.html#sourceExists">sourceExists</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">core/ComoNode.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
  counter,
  isFunction,
  isString,
  getTime,
  isBrowser,
} from '@ircam/sc-utils';
import {
  Scheduler,
} from '@ircam/sc-scheduling';
import {
  AudioBufferLoader,
} from '@ircam/sc-loader';
import {
  serializeError,
  deserializeError,
} from 'serialize-error';
import * as webaudio from 'isomorphic-web-audio-api';

import * as constants from './constants.js';
import { getId } from '#isomorphic-utils.js';

// register webaudio globally on node clients
if (!isBrowser()) {
  Object.assign(globalThis, webaudio);
}

/**
 * A Node in a como application.
 *
 * A ComoNode is a wrapper around a soundworks node (Client or Server) with dedicated functionality.
 *
 * @see {@link https://soundworks.dev/}
 * @see {@link https://soundworks.dev/soundworks/Client.html}
 * @see {@link https://soundworks.dev/soundworks/Server.html}
 */
class ComoNode {
  #host; // soundworks node
  #config;
  #constants = Object.freeze({
    ...constants,
  });

  #node;
  #nodes; // collection of node-infos

  // #plugins = [];
  #components = new Map();

  // global shared states
  #global; // @todo - rename to config
  #project;
  #rfcMessageBus;
  #rfcIdGenerator = counter();
  #rfcPendingStore = new Map();
  #rfcHandlers = new Map();
  #rfcResolverHooks = new Map();

  // audio / schedulers
  #audioContext;
  #audioBufferLoader;
  #scheduler;
  #audioScheduler;
  #syncedScheduler;

  /**
   * @param {Client|Server} host - Instance of soundworks client or server
   */
  constructor(host, options) {
    this.#host = host;
    this.#config = options;
    this.#audioContext = new AudioContext();
    this.#audioBufferLoader = new AudioBufferLoader(this.#audioContext);
  }

  /**
   * The underlying soundworks client or server instance.
   * @readonly
   * @see {@link https://soundworks.dev/soundworks/Client.html}
   * @see {@link https://soundworks.dev/soundworks/Server.html}
   */
  get host() {
    return this.#host;
  }

  /** @private */
  get options() {
    return this.options;
  }

  /** @private */
  get constants() {
    return this.#constants;
  }

  /**
   * Soundworks id, uniquely generated at runtime
   * @type {Number}
   * @readonly
   */
  get nodeId() {
    return this.#node.get('nodeId');
  }

  /**
   * Topological id (can be fixed between different restarts):
   * - For browser clients: generated from soundworks node id, or user defined
   * through query parameter, i.e. http://host.local?id=my-client-id
   * - For node clients: hostname
   * - For server: 'server' constant
   *
   * @type {String}
   * @readonly
   */
  get id() {
    return this.#node.get('id');
  }

  /**
   * Runtime in which the node is running
   * @type {'node'|'browser'}
   * @readonly
   */
  get runtime() {
    return this.#node.get('runtime');
  }

  /**
   * Role of the node, as defined in soundworks config
   * @type {String}
   * @readonly
   */
  get role() {
    return this.#node.get('role');
  }

  /** @private */
  get nodes() {

  }

  /** @private */
  get global() {
    return this.#global;
  }

  /** @private */
  get project() {
    return this.#project;
  }

  /**
   * List of registered components
   * @type {Map&lt;String, ComoComponent>}
   * @readonly
   */
  get components() {
    return this.#components;
  }

  /**
   * Accessor to the soundworks `StateManager`
   * @readonly
   * @see {@link https://soundworks.dev/soundworks/ClientStateManager.html}
   * @see {@link https://soundworks.dev/soundworks/ServerStateManager.html}
   */
  get stateManager() {
    return this.#host.stateManager;
  }

  /**
   * Accessor to the soundworks `PluginManager`
   * @readonly
   * @see {@link https://soundworks.dev/soundworks/ClientPluginManager.html}
   * @see {@link https://soundworks.dev/soundworks/ServerPluginManager.html}
   */
  get pluginManager() {
    return this.#host.pluginManager;
  }

  /**
   * Instance of `AudioContext`
   * @readonly
   * @see {@link https://developer.mozilla.org/fr/docs/Web/API/AudioContext}
   */
  get audioContext() {
    return this.#audioContext;
  }

  /**
   * Instance of `AudioBufferLoader`
   * @readonly
   * @see {@link https://github.com/ircam-ismm/sc-loader?tab=readme-ov-file#audiobufferloader}
   */
  get audioBufferLoader() {
    return this.#audioBufferLoader;
  }

  /**
   * Instance of Scheduler, running in arbitrary timeline
   * @readonly
   * @see {@link https://github.com/ircam-ismm/sc-scheduling/?tab=readme-ov-file#scheduler}
   * @see {@link https://github.com/ircam-ismm/sc-utils?tab=readme-ov-file#gettime}
   */
  get scheduler() {
    return this.#scheduler;
  }

  /**
   * Instance of Scheduler, running in AudioContext timeline
   * @readonly
   * @see {@link https://github.com/ircam-ismm/sc-scheduling/?tab=readme-ov-file#scheduler}
   */
  get audioScheduler() {
    return this.#audioScheduler;
  }

  /** @private */
  get syncedScheduler() {
    throw new Error(`Cannot get "${syncedScheduler}" on ComoNode: not implemented yet`);
  }

  /**
   * The init method is part of the initialization lifecycle of the como node.
   * Most of the time, this method will be implicitly executed by the `{@link ComoNode#start}` method.
   *
   * Note that will automatically call the `init` method of the soundworks host as well.
   *
   * In some situations you might want to call this method manually, in such cases the method
   * should be called before the `{@link ComoNode#start}` method.`.
   *
   * @example
   * import { Client } from '@soundworks/core/client.js';
   * import { ComoClient } from '@ircam/como';
   *
   * const client = new Client(config);
   * const como = new ComoClient(client);
   * // optional explicit call of `init` before `start`
   * await como.init();
   * await como.start();
   */
  async init() {
    if (this.#host.status === 'idle') {
      await this.host.init();

      for (let component of this.#components.values()) {
        await component.init();
      }
    }
  }

  /**
   * The start method is part of the initialization lifecycle of the como node.
   * This method will implicitly execute {@link ComoNode#init} method if it has not been called manually.
   *
   * Note that will automatically call the `start` method of the soundworks host as well.
   *
   * @example
   * import { Client } from '@soundworks/core/client.js';
   * import { ComoClient } from '@ircam/como';
   *
   * const client = new Client(config);
   * const como = new ComoClient(client);
   * // implicit execution of `init` method
   * await como.start();
   */
  async start() {
    await this.init();
    await this.#host.start();

    // node own state
    this.#node = await this.stateManager.create('como:node', {
      nodeId: this.host.id,
      id: getId(this.host.id),
      runtime: this.host.id === this.constants.SERVER_ID ? 'node' : this.host.runtime,
      role: this.host.id === this.constants.SERVER_ID ? 'server' : this.host.role,
    });

    // create / attach to global shared states
    if (this.nodeId === this.constants.SERVER_ID) {
      // @todo - rename to config
      this.#global = await this.stateManager.create('como:global', {
        ...this.#config,
      });
      this.#project = await this.stateManager.create('como:project');
      // global command mechanism: send a command and await for its execution
      this.#rfcMessageBus = await this.stateManager.create('como:rfc');
      this.#rfcMessageBus.onUpdate(this.#handleRfc.bind(this));
    } else {
      this.#global = await this.stateManager.attach('como:global');
      this.#project = await this.stateManager.attach('como:project');
      // global command mechanism: send a command and await for its execution
      this.#rfcMessageBus = await this.stateManager.attach('como:rfc');
      this.#rfcMessageBus.onUpdate(this.#handleRfc.bind(this));
    }

    this.#nodes = await this.stateManager.getCollection('como:node');

    for (let component of this.#components.values()) {
      await component.start();
    }

    this.#scheduler = new Scheduler(getTime);
    this.#audioScheduler = new Scheduler(() => this.#audioContext.currentTime);
    // @todo
    // this.#syncedScheduler;
  }

  /**
   * The stop method is part of the lifecycle of the como node.
   * Notes:
   * - will automatically call the `stop` method of the soundworks host as well.
   * - most of the time, you should not have to call this method manually, mainly
   * meant for testing purposes.
   *
   * @example
   * import { Client } from '@soundworks/core/client.js';
   * import { ComoClient } from '@ircam/como';
   *
   * const client = new Client(config);
   * const como = new ComoClient(client);
   * await como.start();
   * // ...
   * await como.stop();
   */
  async stop() {
    for (let component of this.#components.values()) {
      await component.stop();
    }

    await this.#host.stop();
  }

  /**
   * Change the current project of the whole Como application.
   *
   * - **Important** Calling this method method on any node will change the project for all connected nodes.
   * - **Unstable** The signature of this method is subject to change
   *
   * @unstable
   *
   * @param {String} projectDirname - Dirname of the project
   */
  async setProject(projectDirname) {
    return await this.requestRfc(this.constants.SERVER_ID, 'como:setProject', { projectDirname });
  }

  /**
   * Request a remote function call on a given node.
   *
   * **Warning** - This method should be considered protected and may be subject to change,
   * use at your own risk.
   *
   * @unstable
   * @todo
   * - Lazily attach to a peer node owned state to minimize network load
   * - This could be integrated into soundworks
   *
   * @param {Number} executorNodeId - Id of the node that should execute the procedure
   * @param {String} name - Name of the procedure
   * @param {Object} [payload={}] - Arguments of the procedure
   * @returns {Promise&lt;any>} The return value of the remote procedure call
   */
  async requestRfc(executorNodeId, name, payload = {}) {
    if (!Number.isInteger(executorNodeId)) {
      throw new Error('Cannot execute "requestRfc" on ComoNode: argument 1 is not a valid node id');
    }

    if (!isString(name)) {
      throw new Error('Cannot execute "requestRfc" on ComoNode: argument 2 is not a valid remote function call name, must be a string');
    }

    try {
      JSON.stringify(payload);
    } catch(err) {
      throw new Error('Cannot execute "requestRfc" on ComoNode: argument 3 cannot be stringified to JSON');
    }

    const commandId = this.#rfcIdGenerator();

    this.#rfcMessageBus.set({
      name,
      sourceNodeId: this.nodeId,
      executorNodeId,
      commandId,
      payload,
    });

    return new Promise((resolve, reject) => {
      this.#rfcPendingStore.set(commandId, { resolve, reject });
    });
  }

  /**
   * Function to execute when a remote function call is requested on this node
   *
   * **Warning** - This method should be considered protected and may be subject to change,
   * use at your own risk.
   *
   * @unstable
   * @param {String} name - Name of the procedure
   * @param {Function} callback - Function to be executed
   */
  setRfcHandler(name, callback) {
    if (!isString(name)) {
      throw new Error('Cannot execute "setRfcHandler" on ComoNode: argument 1 is not a string');
    }

    if (!isFunction(callback)) {
      throw new Error('Cannot execute "setRfcHandler" on ComoNode: argument 2 is not a function');
    }

    this.#rfcHandlers.set(name, callback);
  }

  /**
   * Function executed by the requesting node when the rfc is settled to perform
   * additional logic on rfc result before fulfilling the promise.
   *
   * **Warning** - This method should be considered protected and may be subject to change,
   * use at your own risk.
   *
   * @unstable
   * @param {*} name
   * @param {*} callback
   */
  setRfcResolverHook(name, callback) {
    if (!isString(name)) {
      throw new Error('Cannot execute "setRfcHandler" on ComoNode: argument 1 is not a string');
    }

    if (!isFunction(callback)) {
      throw new Error('Cannot execute "setRfcHandler" on ComoNode: argument 2 is not a function');
    }

    this.#rfcResolverHooks.set(name, callback);

  }

  /** @private */
  async #handleRfc(infos) {
    if (infos.settled === true) {
      // check if node is initiator of command
      const { sourceNodeId, commandId, name } = infos;

      if (sourceNodeId === this.nodeId) {
        if (this.#rfcPendingStore.has(commandId)) {
          const { resolve, reject } = this.#rfcPendingStore.get(commandId);
          this.#rfcPendingStore.delete(commandId);

          // @note - maybe we would also like to override the return value
          if (this.#rfcResolverHooks.has(name)) {
            const hook = this.#rfcResolverHooks.get(name);
            await hook(infos.responseErr, infos.responseAck);
          }

          // this will resolve even if responseAck is undefined
          if ('responseErr' in infos) {
            reject(deserializeError(infos.responseErr));
          } else {
            resolve(infos.responseAck);
          }
        } else {
          throw new Error(`Cannot retrieve command resolvers from this.#rfcPendingStore for command id: ${commandId}`)
        }
      }
    } else {
      // check if this node should execute the command
      const { executorNodeId, name, payload } = infos;

      if (executorNodeId === this.nodeId) {
        try {
          if (!this.#rfcHandlers.has(name)) {
            throw new Error(`Cannot execute Rfc, no handler set for command ${name} (cf. CoMoNode#setRfcHandler)`);
          }

          const handler = this.#rfcHandlers.get(name);
          const responseAck = await handler(payload);
          const response = {
            settled: true,
            ...infos,
          }

          if (responseAck !== undefined || responseAck !== null) {
            response.responseAck = responseAck;
          }

          this.#rfcMessageBus.set(response);
        } catch (err) {
          this.#rfcMessageBus.set({
            settled: true,
            responseErr: serializeError(err),
            ...infos
          });
        }
      }
    }
  }
}

export default ComoNode;
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Wed Feb 11 2026 16:53:07 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
