"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Sessions = _interopRequireDefault(require("./Sessions.js"));

var _Players = _interopRequireDefault(require("./Players.js"));

var _Graph = _interopRequireDefault(require("../common/Graph.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Project {
  constructor(como) {
    this.como = como;
  }

  async init() {
    this.state = await this.como.client.stateManager.attach('project');
    this.players = new _Players.default(this.como);
    this.sessions = new _Sessions.default(this.como);
  }

  subscribe(func) {
    const unsubscribe = this.state.subscribe(func);
    return unsubscribe;
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async createSession(sessionName, graphPreset) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:createSession:ack`;
      const errChannel = `como:project:createSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:createSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:createSession:req`, sessionName, graphPreset);
    });
  }

  async deleteSession(sessionId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:deleteSession:ack`;
      const errChannel = `como:project:deleteSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:deleteSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:deleteSession:req`, sessionId);
    });
  }

  async createStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:createStreamRoute:ack`;
      const errChannel = `como:routing:createStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:createStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:createStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  async deleteStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:deleteStreamRoute:ack`;
      const errChannel = `como:routing:deleteStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:deleteStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:deleteStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  propagateStreamFrame(frame) {
    this.como.client.socket.sendBinary('stream', frame);
  }
  /**
   * @param {Int} playerId - Id of the player in the como application, the
   *  given `id` should be unique. In most case, the node id
   *  (e.g. soudnworks.client.id) will be a good choice.
   */


  async createPlayer(playerId = null) {
    return this.players.create(playerId);
  }
  /**
   * @note - this API is not a good thing, it prevents to add user / application
   * defined modules
   */


  async createGraph(session, player, slave) {
    const graphDescription = session.get('graph');
    const graph = new _Graph.default(this.como, graphDescription, session, player, slave);
    await graph.init();
    return graph;
  }

}

var _default = Project;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvUHJvamVjdC5qcyJdLCJuYW1lcyI6WyJQcm9qZWN0IiwiY29uc3RydWN0b3IiLCJjb21vIiwiaW5pdCIsInN0YXRlIiwiY2xpZW50Iiwic3RhdGVNYW5hZ2VyIiwiYXR0YWNoIiwicGxheWVycyIsIlBsYXllcnMiLCJzZXNzaW9ucyIsIlNlc3Npb25zIiwic3Vic2NyaWJlIiwiZnVuYyIsInVuc3Vic2NyaWJlIiwiZ2V0VmFsdWVzIiwiZ2V0IiwibmFtZSIsImNyZWF0ZVNlc3Npb24iLCJzZXNzaW9uTmFtZSIsImdyYXBoUHJlc2V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJhY2tDaGFubmVsIiwiZXJyQ2hhbm5lbCIsInJlc29sdmVQcm9taXNlIiwidmFsdWUiLCJzb2NrZXQiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJhZGRMaXN0ZW5lciIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJzZW5kIiwiZGVsZXRlU2Vzc2lvbiIsInNlc3Npb25JZCIsImNyZWF0ZVN0cmVhbVJvdXRlIiwiZnJvbVNvdXJjZUlkIiwidG9Ob2RlSWQiLCJkZWxldGVTdHJlYW1Sb3V0ZSIsInByb3BhZ2F0ZVN0cmVhbUZyYW1lIiwiZnJhbWUiLCJzZW5kQmluYXJ5IiwiY3JlYXRlUGxheWVyIiwicGxheWVySWQiLCJjcmVhdGUiLCJjcmVhdGVHcmFwaCIsInNlc3Npb24iLCJwbGF5ZXIiLCJzbGF2ZSIsImdyYXBoRGVzY3JpcHRpb24iLCJncmFwaCIsIkdyYXBoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxPQUFOLENBQWM7QUFDWkMsRUFBQUEsV0FBVyxDQUFDQyxJQUFELEVBQU87QUFDaEIsU0FBS0EsSUFBTCxHQUFZQSxJQUFaO0FBQ0Q7O0FBRVMsUUFBSkMsSUFBSSxHQUFHO0FBQ1gsU0FBS0MsS0FBTCxHQUFhLE1BQU0sS0FBS0YsSUFBTCxDQUFVRyxNQUFWLENBQWlCQyxZQUFqQixDQUE4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QUFPLEtBQUtyQyxPQUFMLENBQWFzQyxNQUFiLENBQW9CRCxRQUFwQixDQUFQO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTs7O0FBQ21CLFFBQVhFLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQWtCQyxLQUFsQixFQUF5QjtBQUN4QyxVQUFNQyxnQkFBZ0IsR0FBR0gsT0FBTyxDQUFDaEMsR0FBUixDQUFZLE9BQVosQ0FBekI7QUFDQSxVQUFNb0MsS0FBSyxHQUFHLElBQUlDLGNBQUosQ0FBVSxLQUFLbkQsSUFBZixFQUFxQmlELGdCQUFyQixFQUF1Q0gsT0FBdkMsRUFBZ0RDLE1BQWhELEVBQXdEQyxLQUF4RCxDQUFkO0FBQ0EsVUFBTUUsS0FBSyxDQUFDakQsSUFBTixFQUFOO0FBRUEsV0FBT2lELEtBQVA7QUFDRDs7QUFwSVc7O2VBdUlDcEQsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTZXNzaW9ucyBmcm9tICcuL1Nlc3Npb25zLmpzJztcbmltcG9ydCBQbGF5ZXJzIGZyb20gJy4vUGxheWVycy5qcyc7XG5pbXBvcnQgR3JhcGggZnJvbSAnLi4vY29tbW9uL0dyYXBoLmpzJztcblxuY2xhc3MgUHJvamVjdCB7XG4gIGNvbnN0cnVjdG9yKGNvbW8pIHtcbiAgICB0aGlzLmNvbW8gPSBjb21vO1xuICB9XG5cbiAgYXN5bmMgaW5pdCgpIHtcbiAgICB0aGlzLnN0YXRlID0gYXdhaXQgdGhpcy5jb21vLmNsaWVudC5zdGF0ZU1hbmFnZXIuYXR0YWNoKCdwcm9qZWN0Jyk7XG5cbiAgICB0aGlzLnBsYXllcnMgPSBuZXcgUGxheWVycyh0aGlzLmNvbW8pO1xuICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgU2Vzc2lvbnModGhpcy5jb21vKTtcbiAgfVxuXG4gIHN1YnNjcmliZShmdW5jKSB7XG4gICAgY29uc3QgdW5zdWJzY3JpYmUgPSB0aGlzLnN0YXRlLnN1YnNjcmliZShmdW5jKTtcbiAgICByZXR1cm4gdW5zdWJzY3JpYmU7XG4gIH1cblxuICBnZXRWYWx1ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0VmFsdWVzKCk7XG4gIH1cblxuICBnZXQobmFtZSkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldChuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24oc2Vzc2lvbk5hbWUsIGdyYXBoUHJlc2V0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmNyZWF0ZVNlc3Npb246YWNrYDtcbiAgICAgIGNvbnN0IGVyckNoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmNyZWF0ZVNlc3Npb246ZXJyYDtcblxuICAgICAgY29uc3QgcmVzb2x2ZVByb21pc2UgPSB2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhhY2tDaGFubmVsKTtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGVyckNoYW5uZWwpO1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYWNrQ2hhbm5lbCwgcmVzb2x2ZVByb21pc2UpO1xuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoZXJyQ2hhbm5lbCwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3Byb2plY3Q6Y3JlYXRlU2Vzc2lvbiBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpjcmVhdGVTZXNzaW9uOnJlcWAsIHNlc3Npb25OYW1lLCBncmFwaFByZXNldCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uKHNlc3Npb25JZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhY2tDaGFubmVsID0gYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOmFja2A7XG4gICAgICBjb25zdCBlcnJDaGFubmVsID0gYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOmVycmA7XG5cbiAgICAgIGNvbnN0IHJlc29sdmVQcm9taXNlID0gdmFsdWUgPT4ge1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoYWNrQ2hhbm5lbCk7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhlcnJDaGFubmVsKTtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGFja0NoYW5uZWwsIHJlc29sdmVQcm9taXNlKTtcbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGVyckNoYW5uZWwsIGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdwcm9qZWN0OmRlbGV0ZVNlc3Npb24gZXJyb3InLCBlcnIpO1xuICAgICAgICByZXNvbHZlUHJvbWlzZShudWxsKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnByb2plY3Q6ZGVsZXRlU2Vzc2lvbjpyZXFgLCBzZXNzaW9uSWQpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU3RyZWFtUm91dGUoZnJvbVNvdXJjZUlkLCB0b05vZGVJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhY2tDaGFubmVsID0gYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTphY2tgO1xuICAgICAgY29uc3QgZXJyQ2hhbm5lbCA9IGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6ZXJyYDtcblxuICAgICAgY29uc3QgcmVzb2x2ZVByb21pc2UgPSB2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhhY2tDaGFubmVsKTtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGVyckNoYW5uZWwpO1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYWNrQ2hhbm5lbCwgcmVzb2x2ZVByb21pc2UpO1xuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoZXJyQ2hhbm5lbCwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3JvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGUgZXJyb3InLCBlcnIpO1xuICAgICAgICByZXNvbHZlUHJvbWlzZShudWxsKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6cmVxYCwgZnJvbVNvdXJjZUlkLCB0b05vZGVJZCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTdHJlYW1Sb3V0ZShmcm9tU291cmNlSWQsIHRvTm9kZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOmFja2A7XG4gICAgICBjb25zdCBlcnJDaGFubmVsID0gYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTplcnJgO1xuXG4gICAgICBjb25zdCByZXNvbHZlUHJvbWlzZSA9IHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGFja0NoYW5uZWwpO1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoZXJyQ2hhbm5lbCk7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihhY2tDaGFubmVsLCByZXNvbHZlUHJvbWlzZSk7XG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihlcnJDaGFubmVsLCBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZSBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTpyZXFgLCBmcm9tU291cmNlSWQsIHRvTm9kZUlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByb3BhZ2F0ZVN0cmVhbUZyYW1lKGZyYW1lKSB7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZEJpbmFyeSgnc3RyZWFtJywgZnJhbWUpXG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtJbnR9IHBsYXllcklkIC0gSWQgb2YgdGhlIHBsYXllciBpbiB0aGUgY29tbyBhcHBsaWNhdGlvbiwgdGhlXG4gICAqICBnaXZlbiBgaWRgIHNob3VsZCBiZSB1bmlxdWUuIEluIG1vc3QgY2FzZSwgdGhlIG5vZGUgaWRcbiAgICogIChlLmcuIHNvdWRud29ya3MuY2xpZW50LmlkKSB3aWxsIGJlIGEgZ29vZCBjaG9pY2UuXG4gICAqL1xuICBhc3luYyBjcmVhdGVQbGF5ZXIocGxheWVySWQgPSBudWxsKSB7XG4gICAgcmV0dXJuIHRoaXMucGxheWVycy5jcmVhdGUocGxheWVySWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBub3RlIC0gdGhpcyBBUEkgaXMgbm90IGEgZ29vZCB0aGluZywgaXQgcHJldmVudHMgdG8gYWRkIHVzZXIgLyBhcHBsaWNhdGlvblxuICAgKiBkZWZpbmVkIG1vZHVsZXNcbiAgICovXG4gIGFzeW5jIGNyZWF0ZUdyYXBoKHNlc3Npb24sIHBsYXllciwgc2xhdmUpIHtcbiAgICBjb25zdCBncmFwaERlc2NyaXB0aW9uID0gc2Vzc2lvbi5nZXQoJ2dyYXBoJyk7XG4gICAgY29uc3QgZ3JhcGggPSBuZXcgR3JhcGgodGhpcy5jb21vLCBncmFwaERlc2NyaXB0aW9uLCBzZXNzaW9uLCBwbGF5ZXIsIHNsYXZlKTtcbiAgICBhd2FpdCBncmFwaC5pbml0KCk7XG5cbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHJvamVjdDtcbiJdfQ==