"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Sessions = _interopRequireDefault(require("./Sessions.js"));

var _Players = _interopRequireDefault(require("./Players.js"));

var _Graph = _interopRequireDefault(require("../common/Graph.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Project {
  constructor(como) {
    this.como = como;
  }

  async init() {
    this.state = await this.como.client.stateManager.attach('project');
    this.players = new _Players.default(this.como);
    this.sessions = new _Sessions.default(this.como);
    /**
     * @note: if preloadAudioFiles is true, we load all the audio files, so
     * that we can still update active and inactive files per session without
     * having to restart the server each time.
     */

    if (this.state.get('preloadAudioFiles')) {
      const audioFiles = this.state.get('audioFiles').reduce((acc, file) => {
        acc[file.name] = file.url;
        return acc;
      }, {});
      await this.como.experience.plugins['audio-buffer-loader'].load(audioFiles);
    }
  }

  subscribe(func) {
    const unsubscribe = this.state.subscribe(func);
    return unsubscribe;
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async createSession(sessionName, graphPreset) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:createSession:ack`;
      const errChannel = `como:project:createSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:createSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:createSession:req`, sessionName, graphPreset);
    });
  }

  async deleteSession(sessionId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:deleteSession:ack`;
      const errChannel = `como:project:deleteSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:deleteSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:deleteSession:req`, sessionId);
    });
  }

  async createStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:createStreamRoute:ack`;
      const errChannel = `como:routing:createStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:createStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:createStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  async deleteStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:deleteStreamRoute:ack`;
      const errChannel = `como:routing:deleteStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:deleteStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:deleteStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  propagateStreamFrame(frame) {
    this.como.client.socket.sendBinary('stream', frame);
  }
  /**
   * @param {Int} playerId - Id of the player in the como application, the
   *  given `id` should be unique. In most case, the node id
   *  (e.g. soudnworks.client.id) will be a good choice.
   */


  async createPlayer(playerId = null) {
    return this.players.create(playerId);
  }
  /**
   * @note - this API is not a good thing, it prevents to add user / application
   * defined modules
   */


  async createGraph(session, player, slave) {
    const graphDescription = session.get('graph');
    const graph = new _Graph.default(this.como, graphDescription, session, player, slave);
    await graph.init();
    return graph;
  }

}

var _default = Project;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvUHJvamVjdC5qcyJdLCJuYW1lcyI6WyJQcm9qZWN0IiwiY29uc3RydWN0b3IiLCJjb21vIiwiaW5pdCIsInN0YXRlIiwiY2xpZW50Iiwic3RhdGVNYW5hZ2VyIiwiYXR0YWNoIiwicGxheWVycyIsIlBsYXllcnMiLCJzZXNzaW9ucyIsIlNlc3Npb25zIiwiZ2V0IiwiYXVkaW9GaWxlcyIsInJlZHVjZSIsImFjYyIsImZpbGUiLCJuYW1lIiwidXJsIiwiZXhwZXJpZW5jZSIsInBsdWdpbnMiLCJsb2FkIiwic3Vic2NyaWJlIiwiZnVuYyIsInVuc3Vic2NyaWJlIiwiZ2V0VmFsdWVzIiwiY3JlYXRlU2Vzc2lvbiIsInNlc3Npb25OYW1lIiwiZ3JhcGhQcmVzZXQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImFja0NoYW5uZWwiLCJlcnJDaGFubmVsIiwicmVzb2x2ZVByb21pc2UiLCJ2YWx1ZSIsInNvY2tldCIsInJlbW92ZUFsbExpc3RlbmVycyIsImFkZExpc3RlbmVyIiwiZXJyIiwiY29uc29sZSIsImxvZyIsInNlbmQiLCJkZWxldGVTZXNzaW9uIiwic2Vzc2lvbklkIiwiY3JlYXRlU3RyZWFtUm91dGUiLCJmcm9tU291cmNlSWQiLCJ0b05vZGVJZCIsImRlbGV0ZVN0cmVhbVJvdXRlIiwicHJvcGFnYXRlU3RyZWFtRnJhbWUiLCJmcmFtZSIsInNlbmRCaW5hcnkiLCJjcmVhdGVQbGF5ZXIiLCJwbGF5ZXJJZCIsImNyZWF0ZSIsImNyZWF0ZUdyYXBoIiwic2Vzc2lvbiIsInBsYXllciIsInNsYXZlIiwiZ3JhcGhEZXNjcmlwdGlvbiIsImdyYXBoIiwiR3JhcGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLE9BQU4sQ0FBYztBQUNaQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBTztBQUNoQixTQUFLQSxJQUFMLEdBQVlBLElBQVo7QUFDRDs7QUFFUyxRQUFKQyxJQUFJ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IFBsYXllcnMgZnJvbSAnLi9QbGF5ZXJzLmpzJztcbmltcG9ydCBHcmFwaCBmcm9tICcuLi9jb21tb24vR3JhcGguanMnO1xuXG5jbGFzcyBQcm9qZWN0IHtcbiAgY29uc3RydWN0b3IoY29tbykge1xuICAgIHRoaXMuY29tbyA9IGNvbW87XG4gIH1cblxuICBhc3luYyBpbml0KCkge1xuICAgIHRoaXMuc3RhdGUgPSBhd2FpdCB0aGlzLmNvbW8uY2xpZW50LnN0YXRlTWFuYWdlci5hdHRhY2goJ3Byb2plY3QnKTtcbiAgICB0aGlzLnBsYXllcnMgPSBuZXcgUGxheWVycyh0aGlzLmNvbW8pO1xuICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgU2Vzc2lvbnModGhpcy5jb21vKTtcblxuICAgIC8qKlxuICAgICAqIEBub3RlOiBpZiBwcmVsb2FkQXVkaW9GaWxlcyBpcyB0cnVlLCB3ZSBsb2FkIGFsbCB0aGUgYXVkaW8gZmlsZXMsIHNvXG4gICAgICogdGhhdCB3ZSBjYW4gc3RpbGwgdXBkYXRlIGFjdGl2ZSBhbmQgaW5hY3RpdmUgZmlsZXMgcGVyIHNlc3Npb24gd2l0aG91dFxuICAgICAqIGhhdmluZyB0byByZXN0YXJ0IHRoZSBzZXJ2ZXIgZWFjaCB0aW1lLlxuICAgICAqL1xuICAgIGlmICh0aGlzLnN0YXRlLmdldCgncHJlbG9hZEF1ZGlvRmlsZXMnKSkge1xuICAgICAgY29uc3QgYXVkaW9GaWxlcyA9IHRoaXMuc3RhdGUuZ2V0KCdhdWRpb0ZpbGVzJykucmVkdWNlKChhY2MsIGZpbGUpID0+IHtcbiAgICAgICAgYWNjW2ZpbGUubmFtZV0gPSBmaWxlLnVybDtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIHt9KTtcblxuICAgICAgYXdhaXQgdGhpcy5jb21vLmV4cGVyaWVuY2UucGx1Z2luc1snYXVkaW8tYnVmZmVyLWxvYWRlciddLmxvYWQoYXVkaW9GaWxlcyk7XG4gICAgfVxuICB9XG5cbiAgc3Vic2NyaWJlKGZ1bmMpIHtcbiAgICBjb25zdCB1bnN1YnNjcmliZSA9IHRoaXMuc3RhdGUuc3Vic2NyaWJlKGZ1bmMpO1xuICAgIHJldHVybiB1bnN1YnNjcmliZTtcbiAgfVxuXG4gIGdldFZhbHVlcygpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXRWYWx1ZXMoKTtcbiAgfVxuXG4gIGdldChuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0KG5hbWUpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbihzZXNzaW9uTmFtZSwgZ3JhcGhQcmVzZXQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgYWNrQ2hhbm5lbCA9IGBjb21vOnByb2plY3Q6Y3JlYXRlU2Vzc2lvbjphY2tgO1xuICAgICAgY29uc3QgZXJyQ2hhbm5lbCA9IGBjb21vOnByb2plY3Q6Y3JlYXRlU2Vzc2lvbjplcnJgO1xuXG4gICAgICBjb25zdCByZXNvbHZlUHJvbWlzZSA9IHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGFja0NoYW5uZWwpO1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoZXJyQ2hhbm5lbCk7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihhY2tDaGFubmVsLCByZXNvbHZlUHJvbWlzZSk7XG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihlcnJDaGFubmVsLCBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncHJvamVjdDpjcmVhdGVTZXNzaW9uIGVycm9yJywgZXJyKTtcbiAgICAgICAgcmVzb2x2ZVByb21pc2UobnVsbCk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpwcm9qZWN0OmNyZWF0ZVNlc3Npb246cmVxYCwgc2Vzc2lvbk5hbWUsIGdyYXBoUHJlc2V0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmRlbGV0ZVNlc3Npb246YWNrYDtcbiAgICAgIGNvbnN0IGVyckNoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmRlbGV0ZVNlc3Npb246ZXJyYDtcblxuICAgICAgY29uc3QgcmVzb2x2ZVByb21pc2UgPSB2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhhY2tDaGFubmVsKTtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGVyckNoYW5uZWwpO1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYWNrQ2hhbm5lbCwgcmVzb2x2ZVByb21pc2UpO1xuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoZXJyQ2hhbm5lbCwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3Byb2plY3Q6ZGVsZXRlU2Vzc2lvbiBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOnJlcWAsIHNlc3Npb25JZCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTdHJlYW1Sb3V0ZShmcm9tU291cmNlSWQsIHRvTm9kZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpyb3V0aW5nOmNyZWF0ZVN0cmVhbVJvdXRlOmFja2A7XG4gICAgICBjb25zdCBlcnJDaGFubmVsID0gYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTplcnJgO1xuXG4gICAgICBjb25zdCByZXNvbHZlUHJvbWlzZSA9IHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGFja0NoYW5uZWwpO1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoZXJyQ2hhbm5lbCk7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihhY2tDaGFubmVsLCByZXNvbHZlUHJvbWlzZSk7XG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihlcnJDaGFubmVsLCBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZSBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTpyZXFgLCBmcm9tU291cmNlSWQsIHRvTm9kZUlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVN0cmVhbVJvdXRlKGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgYWNrQ2hhbm5lbCA9IGBjb21vOnJvdXRpbmc6ZGVsZXRlU3RyZWFtUm91dGU6YWNrYDtcbiAgICAgIGNvbnN0IGVyckNoYW5uZWwgPSBgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOmVycmA7XG5cbiAgICAgIGNvbnN0IHJlc29sdmVQcm9taXNlID0gdmFsdWUgPT4ge1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoYWNrQ2hhbm5lbCk7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhlcnJDaGFubmVsKTtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGFja0NoYW5uZWwsIHJlc29sdmVQcm9taXNlKTtcbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGVyckNoYW5uZWwsIGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlIGVycm9yJywgZXJyKTtcbiAgICAgICAgcmVzb2x2ZVByb21pc2UobnVsbCk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOnJlcWAsIGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJvcGFnYXRlU3RyZWFtRnJhbWUoZnJhbWUpIHtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kQmluYXJ5KCdzdHJlYW0nLCBmcmFtZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge0ludH0gcGxheWVySWQgLSBJZCBvZiB0aGUgcGxheWVyIGluIHRoZSBjb21vIGFwcGxpY2F0aW9uLCB0aGVcbiAgICogIGdpdmVuIGBpZGAgc2hvdWxkIGJlIHVuaXF1ZS4gSW4gbW9zdCBjYXNlLCB0aGUgbm9kZSBpZFxuICAgKiAgKGUuZy4gc291ZG53b3Jrcy5jbGllbnQuaWQpIHdpbGwgYmUgYSBnb29kIGNob2ljZS5cbiAgICovXG4gIGFzeW5jIGNyZWF0ZVBsYXllcihwbGF5ZXJJZCA9IG51bGwpIHtcbiAgICByZXR1cm4gdGhpcy5wbGF5ZXJzLmNyZWF0ZShwbGF5ZXJJZCk7XG4gIH1cblxuICAvKipcbiAgICogQG5vdGUgLSB0aGlzIEFQSSBpcyBub3QgYSBnb29kIHRoaW5nLCBpdCBwcmV2ZW50cyB0byBhZGQgdXNlciAvIGFwcGxpY2F0aW9uXG4gICAqIGRlZmluZWQgbW9kdWxlc1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlR3JhcGgoc2Vzc2lvbiwgcGxheWVyLCBzbGF2ZSkge1xuICAgIGNvbnN0IGdyYXBoRGVzY3JpcHRpb24gPSBzZXNzaW9uLmdldCgnZ3JhcGgnKTtcbiAgICBjb25zdCBncmFwaCA9IG5ldyBHcmFwaCh0aGlzLmNvbW8sIGdyYXBoRGVzY3JpcHRpb24sIHNlc3Npb24sIHBsYXllciwgc2xhdmUpO1xuICAgIGF3YWl0IGdyYXBoLmluaXQoKTtcblxuICAgIHJldHVybiBncmFwaDtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQcm9qZWN0O1xuIl19