"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Sessions = _interopRequireDefault(require("./Sessions.js"));

var _Players = _interopRequireDefault(require("./Players.js"));

var _Graph = _interopRequireDefault(require("../common/Graph.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Project {
  constructor(como) {
    this.como = como;
  }

  async init() {
    this.state = await this.como.client.stateManager.attach('project');
    this.players = new _Players.default(this.como);
    this.sessions = new _Sessions.default(this.como);
  }

  subscribe(func) {
    const unsubscribe = this.state.subscribe(func);
    return unsubscribe;
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async createSession(sessionName, graphPreset) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:createSession:ack`;
      const errChannel = `como:project:createSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:createSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:createSession:req`, sessionName, graphPreset);
    });
  }

  async deleteSession(sessionId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:deleteSession:ack`;
      const errChannel = `como:project:deleteSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:deleteSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:deleteSession:req`, sessionId);
    });
  }

  async createStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:createStreamRoute:ack`;
      const errChannel = `como:routing:createStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:createStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:createStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  async deleteStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:deleteStreamRoute:ack`;
      const errChannel = `como:routing:deleteStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:deleteStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:deleteStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  propagateStreamFrame(frame) {
    this.como.client.socket.sendBinary('stream', this.data);
  }
  /**
   * @param {Int} playerId - Id of the player in the como application, the
   *  given `id` should be unique. In most case, the node id
   *  (e.g. soudnworks.client.id) will be a good choice.
   */


  async createPlayer(playerId = null) {
    return this.players.create(playerId);
  }
  /**
   * @note - this API is not a good thing, it prevents to add user / application
   * defined modules
   */


  async createGraph(session, player, slave) {
    const graphDescription = session.get('graph');
    const graph = new _Graph.default(this.como, graphDescription, session, player, slave);
    await graph.init();
    return graph;
  }

}

var _default = Project;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvUHJvamVjdC5qcyJdLCJuYW1lcyI6WyJQcm9qZWN0IiwiY29uc3RydWN0b3IiLCJjb21vIiwiaW5pdCIsInN0YXRlIiwiY2xpZW50Iiwic3RhdGVNYW5hZ2VyIiwiYXR0YWNoIiwicGxheWVycyIsIlBsYXllcnMiLCJzZXNzaW9ucyIsIlNlc3Npb25zIiwic3Vic2NyaWJlIiwiZnVuYyIsInVuc3Vic2NyaWJlIiwiZ2V0VmFsdWVzIiwiZ2V0IiwibmFtZSIsImNyZWF0ZVNlc3Npb24iLCJzZXNzaW9uTmFtZSIsImdyYXBoUHJlc2V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJhY2tDaGFubmVsIiwiZXJyQ2hhbm5lbCIsInJlc29sdmVQcm9taXNlIiwidmFsdWUiLCJzb2NrZXQiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJhZGRMaXN0ZW5lciIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJzZW5kIiwiZGVsZXRlU2Vzc2lvbiIsInNlc3Npb25JZCIsImNyZWF0ZVN0cmVhbVJvdXRlIiwiZnJvbVNvdXJjZUlkIiwidG9Ob2RlSWQiLCJkZWxldGVTdHJlYW1Sb3V0ZSIsInByb3BhZ2F0ZVN0cmVhbUZyYW1lIiwiZnJhbWUiLCJzZW5kQmluYXJ5IiwiZGF0YSIsImNyZWF0ZVBsYXllciIsInBsYXllcklkIiwiY3JlYXRlIiwiY3JlYXRlR3JhcGgiLCJzZXNzaW9uIiwicGxheWVyIiwic2xhdmUiLCJncmFwaERlc2NyaXB0aW9uIiwiZ3JhcGgiLCJHcmFwaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsT0FBTixDQUFjO0FBQ1pDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPO0FBQ2hCLFNBQUtBLElBQUwsR0FBWUEsSUFBWjtBQUNEOztBQUVTLFFBQUpDLElBQUksR0FBRztBQUNYLFNBQUtDLEtBQUwsR0FBYSxNQUFNLEtBQUtGLElBQUwsQ0FBVUcsTUFBVixDQUFpQkMsWUFBakIsQ0FBOEJDLE1BQTlCLENBQXFDLFNBQXJDLENBQW5CO0FBRUEsU0FBS0MsT0FBTCxHQUFlLElBQUlDLGdCQUFKLENBQVksS0FBS1AsSUFBakIsQ0FBZjtBQUNBLFNBQUtRLFFBQUwsR0FBZ0IsSUFBSUMsaUJBQUosQ0FBYSxLQUFLVCxJQUFsQixDQUFoQjtBQUNEOztBQUVEVSxFQUFBQSxTQUFTLENBQUNDLElBQUQsRUFBTztBQUNkLFVBQU1DLFdBQVcsR0FBRyxLQUFLVixLQUFMLENBQVdRLFNBQVgsQ0FBcUJDLElBQXJCLENBQXBCO0FBQ0EsV0FBT0MsV0FBUDtBQUNEOztBQUVEQyxFQUFBQSxTQUFTLEdBQUc7QUFDVixXQUFPLEtBQUtYLEtBQUwsQ0FBV1csU0FBWCxFQUFQO0FBQ0Q7O0FBRURDLEVBQUFBLEdBQUcsQ0FBQ0MsSUFBRCxFQUFPO0FBQ1IsV0FBTyxLQUFLYixLQUFMLENBQVdZLEdBQVgsQ0FBZUMsSUFBZixDQUFQO0FBQ0Q7O0FBRWtCLFFBQWJDLGFBQWEsQ0FBQ0MsV0FBRCxFQUFjQyxXQUFkLEVBQTJCO0FBQzVDLFdBQU8sSUFBSUMsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0QyxZQUFNQyxVQUFVLEdBQUksZ0NBQXBCO0FBQ0EsWUFBTUMsVUFBVSxHQUFJLGdDQUFwQjs7QUFFQSxZQUFNQyxjQUFjLEdBQUdDLEtBQUssSUFBSTtBQUM5QixhQUFLekIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JDLGtCQUF4QixDQUEyQ0wsVUFBM0M7QUFDQSxhQUFLdEIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JDLGtCQUF4QixDQUEyQ0osVUFBM0M7QUFDQUgsUUFBQUEsT0FBTyxDQUFDSyxLQUFELENBQVA7QUFDRCxPQUpEOztBQU1BLFdBQUt6QixJQUFMLENBQVVHLE1BQVYsQ0FBaUJ1QixNQUFqQixDQUF3QkUsV0FBeEIsQ0FBb0NOLFVBQXBDLEVBQWdERSxjQUFoRDtBQUNBLFdBQUt4QixJQUFMLENBQVVHLE1BQVYsQ0FBaUJ1QixNQUFqQixDQUF3QkUsV0FBeEIsQ0FBb0NMLFVBQXBDLEVBQWdETSxHQUFHLElBQUk7QUFDckRDLFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDZCQUFaLEVBQTJDRixHQUEzQztBQUNBTCxRQUFBQSxjQUFjLENBQUMsSUFBRCxDQUFkO0FBQ0QsT0FIRDtBQUtBLFdBQUt4QixJQUFMLENBQVVHLE1BQVYsQ0FBaUJ1QixNQUFqQixDQUF3Qk0sSUFBeEIsQ0FBOEIsZ0NBQTlCLEVBQStEZixXQUEvRCxFQUE0RUMsV0FBNUU7QUFDRCxLQWpCTSxDQUFQO0FBa0JEOztBQUVrQixRQUFiZSxhQUFhLENBQUNDLFNBQUQsRUFBWTtBQUM3QixXQUFPLElBQUlmLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdEMsWUFBTUMsVUFBVSxHQUFJLGdDQUFwQjtBQUNBLFlBQU1DLFVBQVUsR0FBSSxnQ0FBcEI7O0FBRUEsWUFBTUMsY0FBYyxHQUFHQyxLQUFLLElBQUk7QUFDOUIsYUFBS3pCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCQyxrQkFBeEIsQ0FBMkNMLFVBQTNDO0FBQ0EsYUFBS3RCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCQyxrQkFBeEIsQ0FBMkNKLFVBQTNDO0FBQ0FILFFBQUFBLE9BQU8sQ0FBQ0ssS0FBRCxDQUFQO0FBQ0QsT0FKRDs7QUFNQSxXQUFLekIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JFLFdBQXhCLENBQW9DTixVQUFwQyxFQUFnREUsY0FBaEQ7QUFDQSxXQUFLeEIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JFLFdBQXhCLENBQW9DTCxVQUFwQyxFQUFnRE0sR0FBRyxJQUFJO0FBQ3JEQyxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSw2QkFBWixFQUEyQ0YsR0FBM0M7QUFDQUwsUUFBQUEsY0FBYyxDQUFDLElBQUQsQ0FBZDtBQUNELE9BSEQ7QUFLQSxXQUFLeEIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JNLElBQXhCLENBQThCLGdDQUE5QixFQUErREUsU0FBL0Q7QUFDRCxLQWpCTSxDQUFQO0FBa0JEOztBQUVzQixRQUFqQkMsaUJBQWlCLENBQUNDLFlBQUQsRUFBZUMsUUFBZixFQUF5QjtBQUM5QyxXQUFPLElBQUlsQixPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDLFlBQU1DLFVBQVUsR0FBSSxvQ0FBcEI7QUFDQSxZQUFNQyxVQUFVLEdBQUksb0NBQXBCOztBQUVBLFlBQU1DLGNBQWMsR0FBR0MsS0FBSyxJQUFJO0FBQzlCLGFBQUt6QixJQUFMLENBQVVHLE1BQVYsQ0FBaUJ1QixNQUFqQixDQUF3QkMsa0JBQXhCLENBQTJDTCxVQUEzQztBQUNBLGFBQUt0QixJQUFMLENBQVVHLE1BQVYsQ0FBaUJ1QixNQUFqQixDQUF3QkMsa0JBQXhCLENBQTJDSixVQUEzQztBQUNBSCxRQUFBQSxPQUFPLENBQUNLLEtBQUQsQ0FBUDtBQUNELE9BSkQ7O0FBTUEsV0FBS3pCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCRSxXQUF4QixDQUFvQ04sVUFBcEMsRUFBZ0RFLGNBQWhEO0FBQ0EsV0FBS3hCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCRSxXQUF4QixDQUFvQ0wsVUFBcEMsRUFBZ0RNLEdBQUcsSUFBSTtBQUNyREMsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksaUNBQVosRUFBK0NGLEdBQS9DO0FBQ0FMLFFBQUFBLGNBQWMsQ0FBQyxJQUFELENBQWQ7QUFDRCxPQUhEO0FBS0EsV0FBS3hCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCTSxJQUF4QixDQUE4QixvQ0FBOUIsRUFBbUVJLFlBQW5FLEVBQWlGQyxRQUFqRjtBQUNELEtBakJNLENBQVA7QUFrQkQ7O0FBRXNCLFFBQWpCQyxpQkFBaUIsQ0FBQ0YsWUFBRCxFQUFlQyxRQUFmLEVBQXlCO0FBQzlDLFdBQU8sSUFBSWxCLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdEMsWUFBTUMsVUFBVSxHQUFJLG9DQUFwQjtBQUNBLFlBQU1DLFVBQVUsR0FBSSxvQ0FBcEI7O0FBRUEsWUFBTUMsY0FBYyxHQUFHQyxLQUFLLElBQUk7QUFDOUIsYUFBS3pCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCQyxrQkFBeEIsQ0FBMkNMLFVBQTNDO0FBQ0EsYUFBS3RCLElBQUwsQ0FBVUcsTUFBVixDQUFpQnVCLE1BQWpCLENBQXdCQyxrQkFBeEIsQ0FBMkNKLFVBQTNDO0FBQ0FILFFBQUFBLE9BQU8sQ0FBQ0ssS0FBRCxDQUFQO0FBQ0QsT0FKRDs7QUFNQSxXQUFLekIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JFLFdBQXhCLENBQW9DTixVQUFwQyxFQUFnREUsY0FBaEQ7QUFDQSxXQUFLeEIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JFLFdBQXhCLENBQW9DTCxVQUFwQyxFQUFnRE0sR0FBRyxJQUFJO0FBQ3JEQyxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxpQ0FBWixFQUErQ0YsR0FBL0M7QUFDQUwsUUFBQUEsY0FBYyxDQUFDLElBQUQsQ0FBZDtBQUNELE9BSEQ7QUFLQSxXQUFLeEIsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JNLElBQXhCLENBQThCLG9DQUE5QixFQUFtRUksWUFBbkUsRUFBaUZDLFFBQWpGO0FBQ0QsS0FqQk0sQ0FBUDtBQWtCRDs7QUFFREUsRUFBQUEsb0JBQW9CLENBQUNDLEtBQUQsRUFBUTtBQUMxQixTQUFLeEMsSUFBTCxDQUFVRyxNQUFWLENBQWlCdUIsTUFBakIsQ0FBd0JlLFVBQXhCLENBQW1DLFFBQW5DLEVBQTZDLEtBQUtDLElBQWxEO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBOzs7QUFDb0IsUUFBWkMsWUFBWSxDQUFDQyxRQUFRLEdBQUcsSUFBWixFQUFrQjtBQUNsQyxXQUFPLEtBQUt0QyxPQUFMLENBQWF1QyxNQUFiLENBQW9CRCxRQUFwQixDQUFQO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTs7O0FBQ21CLFFBQVhFLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQWtCQyxLQUFsQixFQUF5QjtBQUN4QyxVQUFNQyxnQkFBZ0IsR0FBR0gsT0FBTyxDQUFDakMsR0FBUixDQUFZLE9BQVosQ0FBekI7QUFDQSxVQUFNcUMsS0FBSyxHQUFHLElBQUlDLGNBQUosQ0FBVSxLQUFLcEQsSUFBZixFQUFxQmtELGdCQUFyQixFQUF1Q0gsT0FBdkMsRUFBZ0RDLE1BQWhELEVBQXdEQyxLQUF4RCxDQUFkO0FBQ0EsVUFBTUUsS0FBSyxDQUFDbEQsSUFBTixFQUFOO0FBRUEsV0FBT2tELEtBQVA7QUFDRDs7QUFwSVc7O2VBdUlDckQsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTZXNzaW9ucyBmcm9tICcuL1Nlc3Npb25zLmpzJztcbmltcG9ydCBQbGF5ZXJzIGZyb20gJy4vUGxheWVycy5qcyc7XG5pbXBvcnQgR3JhcGggZnJvbSAnLi4vY29tbW9uL0dyYXBoLmpzJztcblxuY2xhc3MgUHJvamVjdCB7XG4gIGNvbnN0cnVjdG9yKGNvbW8pIHtcbiAgICB0aGlzLmNvbW8gPSBjb21vO1xuICB9XG5cbiAgYXN5bmMgaW5pdCgpIHtcbiAgICB0aGlzLnN0YXRlID0gYXdhaXQgdGhpcy5jb21vLmNsaWVudC5zdGF0ZU1hbmFnZXIuYXR0YWNoKCdwcm9qZWN0Jyk7XG5cbiAgICB0aGlzLnBsYXllcnMgPSBuZXcgUGxheWVycyh0aGlzLmNvbW8pO1xuICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgU2Vzc2lvbnModGhpcy5jb21vKTtcbiAgfVxuXG4gIHN1YnNjcmliZShmdW5jKSB7XG4gICAgY29uc3QgdW5zdWJzY3JpYmUgPSB0aGlzLnN0YXRlLnN1YnNjcmliZShmdW5jKTtcbiAgICByZXR1cm4gdW5zdWJzY3JpYmU7XG4gIH1cblxuICBnZXRWYWx1ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0VmFsdWVzKCk7XG4gIH1cblxuICBnZXQobmFtZSkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldChuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24oc2Vzc2lvbk5hbWUsIGdyYXBoUHJlc2V0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmNyZWF0ZVNlc3Npb246YWNrYDtcbiAgICAgIGNvbnN0IGVyckNoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmNyZWF0ZVNlc3Npb246ZXJyYDtcblxuICAgICAgY29uc3QgcmVzb2x2ZVByb21pc2UgPSB2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhhY2tDaGFubmVsKTtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGVyckNoYW5uZWwpO1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYWNrQ2hhbm5lbCwgcmVzb2x2ZVByb21pc2UpO1xuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoZXJyQ2hhbm5lbCwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3Byb2plY3Q6Y3JlYXRlU2Vzc2lvbiBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpjcmVhdGVTZXNzaW9uOnJlcWAsIHNlc3Npb25OYW1lLCBncmFwaFByZXNldCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uKHNlc3Npb25JZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhY2tDaGFubmVsID0gYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOmFja2A7XG4gICAgICBjb25zdCBlcnJDaGFubmVsID0gYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOmVycmA7XG5cbiAgICAgIGNvbnN0IHJlc29sdmVQcm9taXNlID0gdmFsdWUgPT4ge1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoYWNrQ2hhbm5lbCk7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhlcnJDaGFubmVsKTtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGFja0NoYW5uZWwsIHJlc29sdmVQcm9taXNlKTtcbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGVyckNoYW5uZWwsIGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdwcm9qZWN0OmRlbGV0ZVNlc3Npb24gZXJyb3InLCBlcnIpO1xuICAgICAgICByZXNvbHZlUHJvbWlzZShudWxsKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnByb2plY3Q6ZGVsZXRlU2Vzc2lvbjpyZXFgLCBzZXNzaW9uSWQpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU3RyZWFtUm91dGUoZnJvbVNvdXJjZUlkLCB0b05vZGVJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhY2tDaGFubmVsID0gYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTphY2tgO1xuICAgICAgY29uc3QgZXJyQ2hhbm5lbCA9IGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6ZXJyYDtcblxuICAgICAgY29uc3QgcmVzb2x2ZVByb21pc2UgPSB2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhhY2tDaGFubmVsKTtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGVyckNoYW5uZWwpO1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYWNrQ2hhbm5lbCwgcmVzb2x2ZVByb21pc2UpO1xuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoZXJyQ2hhbm5lbCwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3JvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGUgZXJyb3InLCBlcnIpO1xuICAgICAgICByZXNvbHZlUHJvbWlzZShudWxsKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnJvdXRpbmc6Y3JlYXRlU3RyZWFtUm91dGU6cmVxYCwgZnJvbVNvdXJjZUlkLCB0b05vZGVJZCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTdHJlYW1Sb3V0ZShmcm9tU291cmNlSWQsIHRvTm9kZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOmFja2A7XG4gICAgICBjb25zdCBlcnJDaGFubmVsID0gYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTplcnJgO1xuXG4gICAgICBjb25zdCByZXNvbHZlUHJvbWlzZSA9IHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGFja0NoYW5uZWwpO1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoZXJyQ2hhbm5lbCk7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihhY2tDaGFubmVsLCByZXNvbHZlUHJvbWlzZSk7XG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihlcnJDaGFubmVsLCBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZSBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpkZWxldGVTdHJlYW1Sb3V0ZTpyZXFgLCBmcm9tU291cmNlSWQsIHRvTm9kZUlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByb3BhZ2F0ZVN0cmVhbUZyYW1lKGZyYW1lKSB7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZEJpbmFyeSgnc3RyZWFtJywgdGhpcy5kYXRhKVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7SW50fSBwbGF5ZXJJZCAtIElkIG9mIHRoZSBwbGF5ZXIgaW4gdGhlIGNvbW8gYXBwbGljYXRpb24sIHRoZVxuICAgKiAgZ2l2ZW4gYGlkYCBzaG91bGQgYmUgdW5pcXVlLiBJbiBtb3N0IGNhc2UsIHRoZSBub2RlIGlkXG4gICAqICAoZS5nLiBzb3VkbndvcmtzLmNsaWVudC5pZCkgd2lsbCBiZSBhIGdvb2QgY2hvaWNlLlxuICAgKi9cbiAgYXN5bmMgY3JlYXRlUGxheWVyKHBsYXllcklkID0gbnVsbCkge1xuICAgIHJldHVybiB0aGlzLnBsYXllcnMuY3JlYXRlKHBsYXllcklkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAbm90ZSAtIHRoaXMgQVBJIGlzIG5vdCBhIGdvb2QgdGhpbmcsIGl0IHByZXZlbnRzIHRvIGFkZCB1c2VyIC8gYXBwbGljYXRpb25cbiAgICogZGVmaW5lZCBtb2R1bGVzXG4gICAqL1xuICBhc3luYyBjcmVhdGVHcmFwaChzZXNzaW9uLCBwbGF5ZXIsIHNsYXZlKSB7XG4gICAgY29uc3QgZ3JhcGhEZXNjcmlwdGlvbiA9IHNlc3Npb24uZ2V0KCdncmFwaCcpO1xuICAgIGNvbnN0IGdyYXBoID0gbmV3IEdyYXBoKHRoaXMuY29tbywgZ3JhcGhEZXNjcmlwdGlvbiwgc2Vzc2lvbiwgcGxheWVyLCBzbGF2ZSk7XG4gICAgYXdhaXQgZ3JhcGguaW5pdCgpO1xuXG4gICAgcmV0dXJuIGdyYXBoO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFByb2plY3Q7XG4iXX0=