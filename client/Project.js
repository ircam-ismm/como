"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Sessions = _interopRequireDefault(require("./Sessions.js"));

var _Players = _interopRequireDefault(require("./Players.js"));

var _Graph = _interopRequireDefault(require("../common/Graph.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Project {
  constructor(como) {
    this.como = como;
  }

  async init() {
    this.state = await this.como.client.stateManager.attach('project');
    this.players = new _Players.default(this.como);
    this.sessions = new _Sessions.default(this.como);
  }

  subscribe(func) {
    const unsubscribe = this.state.subscribe(func);
    return unsubscribe;
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async createSession(sessionName, graphPreset) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:createSession:ack`;
      const errChannel = `como:project:createSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:createSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:createSession:req`, sessionName, graphPreset);
    });
  }

  async deleteSession(sessionId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:project:deleteSession:ack`;
      const errChannel = `como:project:deleteSession:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('project:deleteSession error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:project:deleteSession:req`, sessionId);
    });
  }

  async createStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:createStreamRoute:ack`;
      const errChannel = `como:routing:createStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:createStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:createStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  async deleteStreamRoute(fromSourceId, toNodeId) {
    return new Promise((resolve, reject) => {
      const ackChannel = `como:routing:deleteStreamRoute:ack`;
      const errChannel = `como:routing:deleteStreamRoute:err`;

      const resolvePromise = value => {
        this.como.client.socket.removeAllListeners(ackChannel);
        this.como.client.socket.removeAllListeners(errChannel);
        resolve(value);
      };

      this.como.client.socket.addListener(ackChannel, resolvePromise);
      this.como.client.socket.addListener(errChannel, err => {
        console.log('routing:deleteStreamRoute error', err);
        resolvePromise(null);
      });
      this.como.client.socket.send(`como:routing:deleteStreamRoute:req`, fromSourceId, toNodeId);
    });
  }

  propagateStreamFrame(frame) {
    this.como.client.socket.sendBinary('stream', this.data);
  }
  /**
   * @param {Int} playerId - Id of the player in the como application, the
   *  given `id` should be unique. In most case, the node id
   *  (e.g. soudnworks.client.id) will be a good choice.
   */


  async createPlayer(playerId = null) {
    return this.players.create(playerId);
  }
  /**
   * @note - this API is not a good thing, it prevents to add user / application
   * defined modules
   */


  async createGraph(session, player, slave) {
    const graphDescription = session.get('graph');
    const graph = new _Graph.default(this.como, graphDescription, session, player, slave);
    await graph.init();
    return graph;
  }

}

var _default = Project;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvUHJvamVjdC5qcyJdLCJuYW1lcyI6WyJQcm9qZWN0IiwiY29uc3RydWN0b3IiLCJjb21vIiwiaW5pdCIsInN0YXRlIiwiY2xpZW50Iiwic3RhdGVNYW5hZ2VyIiwiYXR0YWNoIiwicGxheWVycyIsIlBsYXllcnMiLCJzZXNzaW9ucyIsIlNlc3Npb25zIiwic3Vic2NyaWJlIiwiZnVuYyIsInVuc3Vic2NyaWJlIiwiZ2V0VmFsdWVzIiwiZ2V0IiwibmFtZSIsImNyZWF0ZVNlc3Npb24iLCJzZXNzaW9uTmFtZSIsImdyYXBoUHJlc2V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJhY2tDaGFubmVsIiwiZXJyQ2hhbm5lbCIsInJlc29sdmVQcm9taXNlIiwidmFsdWUiLCJzb2NrZXQiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJhZGRMaXN0ZW5lciIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJzZW5kIiwiZGVsZXRlU2Vzc2lvbiIsInNlc3Npb25JZCIsImNyZWF0ZVN0cmVhbVJvdXRlIiwiZnJvbVNvdXJjZUlkIiwidG9Ob2RlSWQiLCJkZWxldGVTdHJlYW1Sb3V0ZSIsInByb3BhZ2F0ZVN0cmVhbUZyYW1lIiwiZnJhbWUiLCJzZW5kQmluYXJ5IiwiZGF0YSIsImNyZWF0ZVBsYXllciIsInBsYXllcklkIiwiY3JlYXRlIiwiY3JlYXRlR3JhcGgiLCJzZXNzaW9uIiwicGxheWVyIiwic2xhdmUiLCJncmFwaERlc2NyaXB0aW9uIiwiZ3JhcGgiLCJHcmFwaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsT0FBTixDQUFjO0FBQ1pDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPO0FBQ2hCLFNBQUtBLElBQUwsR0FBWUEsSUFBWjtBQUNEOztBQUVELFFBQU1DLElBQU4sR0FBYTtBQUNYLFNBQUtDLEtBQUwsR0FBYSxNQUFNLEtBQUtGLElBQUwsQ0FBVUcsTUFBVixDQUFpQkMsWUFB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LElBQTlCLEVBQW9DO0FBQ2xDLFdBQU8sS0FBS3RDLE9BQUwsQ0FBYXVDLE1BQWIsQ0FBb0JELFFBQXBCLENBQVA7QUFDRDtBQUVEO0FBQ0Y7QUFDQTtBQUNBOzs7QUFDRSxRQUFNRSxXQUFOLENBQWtCQyxPQUFsQixFQUEyQkMsTUFBM0IsRUFBbUNDLEtBQW5DLEVBQTBDO0FBQ3hDLFVBQU1DLGdCQUFnQixHQUFHSCxPQUFPLENBQUNqQyxHQUFSLENBQVksT0FBWixDQUF6QjtBQUNBLFVBQU1xQyxLQUFLLEdBQUcsSUFBSUMsY0FBSixDQUFVLEtBQUtwRCxJQUFmLEVBQXFCa0QsZ0JBQXJCLEVBQXVDSCxPQUF2QyxFQUFnREMsTUFBaEQsRUFBd0RDLEtBQXhELENBQWQ7QUFDQSxVQUFNRSxLQUFLLENBQUNsRCxJQUFOLEVBQU47QUFFQSxXQUFPa0QsS0FBUDtBQUNEOztBQXBJVzs7ZUF1SUNyRCxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNlc3Npb25zIGZyb20gJy4vU2Vzc2lvbnMuanMnO1xuaW1wb3J0IFBsYXllcnMgZnJvbSAnLi9QbGF5ZXJzLmpzJztcbmltcG9ydCBHcmFwaCBmcm9tICcuLi9jb21tb24vR3JhcGguanMnO1xuXG5jbGFzcyBQcm9qZWN0IHtcbiAgY29uc3RydWN0b3IoY29tbykge1xuICAgIHRoaXMuY29tbyA9IGNvbW87XG4gIH1cblxuICBhc3luYyBpbml0KCkge1xuICAgIHRoaXMuc3RhdGUgPSBhd2FpdCB0aGlzLmNvbW8uY2xpZW50LnN0YXRlTWFuYWdlci5hdHRhY2goJ3Byb2plY3QnKTtcblxuICAgIHRoaXMucGxheWVycyA9IG5ldyBQbGF5ZXJzKHRoaXMuY29tbyk7XG4gICAgdGhpcy5zZXNzaW9ucyA9IG5ldyBTZXNzaW9ucyh0aGlzLmNvbW8pO1xuICB9XG5cbiAgc3Vic2NyaWJlKGZ1bmMpIHtcbiAgICBjb25zdCB1bnN1YnNjcmliZSA9IHRoaXMuc3RhdGUuc3Vic2NyaWJlKGZ1bmMpO1xuICAgIHJldHVybiB1bnN1YnNjcmliZTtcbiAgfVxuXG4gIGdldFZhbHVlcygpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXRWYWx1ZXMoKTtcbiAgfVxuXG4gIGdldChuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0KG5hbWUpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbihzZXNzaW9uTmFtZSwgZ3JhcGhQcmVzZXQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgYWNrQ2hhbm5lbCA9IGBjb21vOnByb2plY3Q6Y3JlYXRlU2Vzc2lvbjphY2tgO1xuICAgICAgY29uc3QgZXJyQ2hhbm5lbCA9IGBjb21vOnByb2plY3Q6Y3JlYXRlU2Vzc2lvbjplcnJgO1xuXG4gICAgICBjb25zdCByZXNvbHZlUHJvbWlzZSA9IHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGFja0NoYW5uZWwpO1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoZXJyQ2hhbm5lbCk7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihhY2tDaGFubmVsLCByZXNvbHZlUHJvbWlzZSk7XG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihlcnJDaGFubmVsLCBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncHJvamVjdDpjcmVhdGVTZXNzaW9uIGVycm9yJywgZXJyKTtcbiAgICAgICAgcmVzb2x2ZVByb21pc2UobnVsbCk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpwcm9qZWN0OmNyZWF0ZVNlc3Npb246cmVxYCwgc2Vzc2lvbk5hbWUsIGdyYXBoUHJlc2V0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmRlbGV0ZVNlc3Npb246YWNrYDtcbiAgICAgIGNvbnN0IGVyckNoYW5uZWwgPSBgY29tbzpwcm9qZWN0OmRlbGV0ZVNlc3Npb246ZXJyYDtcblxuICAgICAgY29uc3QgcmVzb2x2ZVByb21pc2UgPSB2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhhY2tDaGFubmVsKTtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGVyckNoYW5uZWwpO1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoYWNrQ2hhbm5lbCwgcmVzb2x2ZVByb21pc2UpO1xuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuYWRkTGlzdGVuZXIoZXJyQ2hhbm5lbCwgZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3Byb2plY3Q6ZGVsZXRlU2Vzc2lvbiBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cHJvamVjdDpkZWxldGVTZXNzaW9uOnJlcWAsIHNlc3Npb25JZCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTdHJlYW1Sb3V0ZShmcm9tU291cmNlSWQsIHRvTm9kZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGFja0NoYW5uZWwgPSBgY29tbzpyb3V0aW5nOmNyZWF0ZVN0cmVhbVJvdXRlOmFja2A7XG4gICAgICBjb25zdCBlcnJDaGFubmVsID0gYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTplcnJgO1xuXG4gICAgICBjb25zdCByZXNvbHZlUHJvbWlzZSA9IHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKGFja0NoYW5uZWwpO1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoZXJyQ2hhbm5lbCk7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihhY2tDaGFubmVsLCByZXNvbHZlUHJvbWlzZSk7XG4gICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5hZGRMaXN0ZW5lcihlcnJDaGFubmVsLCBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZSBlcnJvcicsIGVycik7XG4gICAgICAgIHJlc29sdmVQcm9taXNlKG51bGwpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86cm91dGluZzpjcmVhdGVTdHJlYW1Sb3V0ZTpyZXFgLCBmcm9tU291cmNlSWQsIHRvTm9kZUlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVN0cmVhbVJvdXRlKGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgYWNrQ2hhbm5lbCA9IGBjb21vOnJvdXRpbmc6ZGVsZXRlU3RyZWFtUm91dGU6YWNrYDtcbiAgICAgIGNvbnN0IGVyckNoYW5uZWwgPSBgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOmVycmA7XG5cbiAgICAgIGNvbnN0IHJlc29sdmVQcm9taXNlID0gdmFsdWUgPT4ge1xuICAgICAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoYWNrQ2hhbm5lbCk7XG4gICAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycyhlcnJDaGFubmVsKTtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGFja0NoYW5uZWwsIHJlc29sdmVQcm9taXNlKTtcbiAgICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LmFkZExpc3RlbmVyKGVyckNoYW5uZWwsIGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlIGVycm9yJywgZXJyKTtcbiAgICAgICAgcmVzb2x2ZVByb21pc2UobnVsbCk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpyb3V0aW5nOmRlbGV0ZVN0cmVhbVJvdXRlOnJlcWAsIGZyb21Tb3VyY2VJZCwgdG9Ob2RlSWQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJvcGFnYXRlU3RyZWFtRnJhbWUoZnJhbWUpIHtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kQmluYXJ5KCdzdHJlYW0nLCB0aGlzLmRhdGEpXG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtJbnR9IHBsYXllcklkIC0gSWQgb2YgdGhlIHBsYXllciBpbiB0aGUgY29tbyBhcHBsaWNhdGlvbiwgdGhlXG4gICAqICBnaXZlbiBgaWRgIHNob3VsZCBiZSB1bmlxdWUuIEluIG1vc3QgY2FzZSwgdGhlIG5vZGUgaWRcbiAgICogIChlLmcuIHNvdWRud29ya3MuY2xpZW50LmlkKSB3aWxsIGJlIGEgZ29vZCBjaG9pY2UuXG4gICAqL1xuICBhc3luYyBjcmVhdGVQbGF5ZXIocGxheWVySWQgPSBudWxsKSB7XG4gICAgcmV0dXJuIHRoaXMucGxheWVycy5jcmVhdGUocGxheWVySWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBub3RlIC0gdGhpcyBBUEkgaXMgbm90IGEgZ29vZCB0aGluZywgaXQgcHJldmVudHMgdG8gYWRkIHVzZXIgLyBhcHBsaWNhdGlvblxuICAgKiBkZWZpbmVkIG1vZHVsZXNcbiAgICovXG4gIGFzeW5jIGNyZWF0ZUdyYXBoKHNlc3Npb24sIHBsYXllciwgc2xhdmUpIHtcbiAgICBjb25zdCBncmFwaERlc2NyaXB0aW9uID0gc2Vzc2lvbi5nZXQoJ2dyYXBoJyk7XG4gICAgY29uc3QgZ3JhcGggPSBuZXcgR3JhcGgodGhpcy5jb21vLCBncmFwaERlc2NyaXB0aW9uLCBzZXNzaW9uLCBwbGF5ZXIsIHNsYXZlKTtcbiAgICBhd2FpdCBncmFwaC5pbml0KCk7XG5cbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHJvamVjdDtcbiJdfQ==