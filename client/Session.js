"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _diffArrays = _interopRequireDefault(require("../common/utils/diffArrays.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LabelAudioFileTable {
  constructor(session) {
    this.session = session;
  }

  query(label) {
    const result = [];
    const labelAudioFileTable = this.session.get('labelAudioFileTable');

    for (let [_label, filename] of labelAudioFileTable) {
      if (label === _label) {
        result.push(filename);
      }
    }

    return result;
  }

  queryBuffers(label) {
    const result = this.query(label);
    return result.map(filename => this.session.audioBuffers[filename]);
  }

  delete(label = null, filename = null) {}

  insert(label, filename) {}

} // we should maybe have a parent StateDecorator class


class Session {
  constructor(como, sessionState) {
    this.como = como;
    this.state = sessionState;
    this.audioBuffers = {};
    this.labelAudioFileTable = new LabelAudioFileTable(this);
  }

  async init() {
    await this.updateAudioFiles();
    this.state.subscribe(updates => {
      for (let name in updates) {
        switch (name) {
          case 'audioFiles':
            {
              this.updateAudioFiles();
              break;
            }
        }
      }
    });
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async set(values) {
    return await this.state.set(values);
  }

  subscribe(func) {
    return this.state.subscribe(func);
  }

  async detach() {
    await this.state.detach();
  }

  onDetach(func) {
    // @note - just a decorator for log
    const callback = () => {
      console.log('@todo - clean session audio buffers');
      func();
    };

    this.state.onDetach(callback);
  }

  onDelete(func) {
    this.state.onDelete(func);
  }

  addExample(example) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:addExample`, sessionId, example);
  }

  deleteExample(exampleUuid) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteExample`, sessionId, exampleUuid);
  }

  clearExamples(label = null) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:clearExamples`, sessionId, label);
  }

  setGraphOptions(moduleId, updates) {
    this.state.set({
      graphOptionsEvent: {
        [moduleId]: updates
      }
    });
  }

  getGraphOptions(moduleId) {
    graphOptions = this.state.get('graphOptions');
    return graphOptions[moduleId];
  }

  createLabel(label) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:createLabel`, sessionId, label);
  }

  updateLabel(oldLabel, newLabel) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:updateLabel`, sessionId, oldLabel, newLabel);
  }

  deleteLabel(label) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteLabel`, sessionId, label);
  }

  toggleAudioFile(filename, active) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:toggleAudioFile`, sessionId, filename, active);
  }

  createLabelAudioFileRow(row) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:createLabelAudioFileRow`, sessionId, row);
  }

  deleteLabelAudioFileRow(row) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteLabelAudioFileRow`, sessionId, row);
  }

  async updateAudioFiles() {
    const audioFiles = this.state.get('audioFiles');
    const activeAudioFiles = audioFiles.filter(audioFile => audioFile.active);
    const audioBufferLoader = this.como.experience.plugins['audio-buffer-loader'];

    if (this.como.project.get('preloadAudioFiles')) {
      // pick audio files from audio-buffer-load cache
      this.audioBuffers = {};
      activeAudioFiles.forEach(file => {
        this.audioBuffers[file.name] = audioBufferLoader.data[file.name];
      });
    } else {
      const filesToLoad = {};
      activeAudioFiles.forEach(file => filesToLoad[file.name] = file.url);
      this.audioBuffers = await audioBufferLoader.load(filesToLoad);
    } // clear audio buffer loader cache


    audioBufferLoader.data = {};
  }

}

var _default = Session;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvU2Vzc2lvbi5qcyJdLCJuYW1lcyI6WyJMYWJlbEF1ZGlvRmlsZVRhYmxlIiwiY29uc3RydWN0b3IiLCJzZXNzaW9uIiwicXVlcnkiLCJsYWJlbCIsInJlc3VsdCIsImxhYmVsQXVkaW9GaWxlVGFibGUiLCJnZXQiLCJfbGFiZWwiLCJmaWxlbmFtZSIsInB1c2giLCJxdWVyeUJ1ZmZlcnMiLCJtYXAiLCJhdWRpb0J1ZmZlcnMiLCJkZWxldGUiLCJpbnNlcnQiLCJTZXNzaW9uIiwiY29tbyIsInNlc3Npb25TdGF0ZSIsInN0YXRlIiwiaW5pdCIsInVwZGF0ZUF1ZGlvRmlsZXMiLCJzdWJzY3JpYmUiLCJ1cGRhdGVzIiwibmFtZSIsImdldFZhbHVlcyIsInNldCIsInZhbHVlcyIsImZ1bmMiLCJkZXRhY2giLCJvbkRldGFjaCIsImNhbGxiYWNrIiwiY29uc29sZSIsImxvZyIsIm9uRGVsZXRlIiwiYWRkRXhhbXBsZSIsImV4YW1wbGUiLCJzZXNzaW9uSWQiLCJjbGllbnQiLCJzb2NrZXQiLCJzZW5kIiwiZGVsZXRlRXhhbXBsZSIsImV4YW1wbGVVdWlkIiwiY2xlYXJFeGFtcGxlcyIsInNldEdyYXBoT3B0aW9ucyIsIm1vZHVsZUlkIiwiZ3JhcGhPcHRpb25zRXZlbnQiLCJnZXRHcmFwaE9wdGlvbnMiLCJncmFwaE9wdGlvbnMiLCJjcmVhdGVMYWJlbCIsInVwZGF0ZUxhYmVsIiwib2xkTGFiZWwiLCJuZXdMYWJlbCIsImRlbGV0ZUxhYmVsIiwidG9nZ2xlQXVkaW9GaWxlIiwiYWN0aXZlIiwiY3JlYXRlTGFiZWxBdWRpb0ZpbGVSb3ciLCJyb3ciLCJkZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyIsImF1ZGlvRmlsZXMiLCJhY3RpdmVBdWRpb0ZpbGVzIiwiZmlsdGVyIiwiYXVkaW9GaWxlIiwiYXVkaW9CdWZmZXJMb2FkZXIiLCJleHBlcmllbmNlIiwicGx1Z2lucyIsInByb2plY3QiLCJmb3JFYWNoIiwiZmlsZSIsImRhdGEiLCJmaWxl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QVcsR0FBRyxFQUFwQjtBQUNBVixNQUFBQSxnQkFBZ0IsQ0FBQ08sT0FBakIsQ0FBeUJDLElBQUksSUFBSUUsV0FBVyxDQUFDRixJQUFJLENBQUM1QyxJQUFOLENBQVgsR0FBeUI0QyxJQUFJLENBQUNHLEdBQS9EO0FBRUEsV0FBSzFELFlBQUwsR0FBb0IsTUFBTWtELGlCQUFpQixDQUFDUyxJQUFsQixDQUF1QkYsV0FBdkIsQ0FBMUI7QUFDRCxLQWpCc0IsQ0FrQnZCOzs7QUFDQVAsSUFBQUEsaUJBQWlCLENBQUNNLElBQWxCLEdBQXlCLEVBQXpCO0FBQ0Q7O0FBcElXOztlQXVJQ3JELE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGlmZkFycmF5cyBmcm9tICcuLi9jb21tb24vdXRpbHMvZGlmZkFycmF5cy5qcyc7XG5cbmNsYXNzIExhYmVsQXVkaW9GaWxlVGFibGUge1xuICBjb25zdHJ1Y3RvcihzZXNzaW9uKSB7XG4gICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbjtcbiAgfVxuXG4gIHF1ZXJ5KGxhYmVsKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gW107XG4gICAgY29uc3QgbGFiZWxBdWRpb0ZpbGVUYWJsZSA9IHRoaXMuc2Vzc2lvbi5nZXQoJ2xhYmVsQXVkaW9GaWxlVGFibGUnKTtcblxuICAgIGZvciAobGV0IFtfbGFiZWwsIGZpbGVuYW1lXSBvZiBsYWJlbEF1ZGlvRmlsZVRhYmxlKSB7XG4gICAgICBpZiAobGFiZWwgPT09IF9sYWJlbCkge1xuICAgICAgICByZXN1bHQucHVzaChmaWxlbmFtZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHF1ZXJ5QnVmZmVycyhsYWJlbCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucXVlcnkobGFiZWwpO1xuICAgIHJldHVybiByZXN1bHQubWFwKGZpbGVuYW1lID0+IHRoaXMuc2Vzc2lvbi5hdWRpb0J1ZmZlcnNbZmlsZW5hbWVdKTtcbiAgfVxuXG4gIGRlbGV0ZShsYWJlbCA9IG51bGwsIGZpbGVuYW1lID0gbnVsbCkge1xuXG4gIH1cblxuICBpbnNlcnQobGFiZWwsIGZpbGVuYW1lKSB7XG5cbiAgfVxufVxuXG4vLyB3ZSBzaG91bGQgbWF5YmUgaGF2ZSBhIHBhcmVudCBTdGF0ZURlY29yYXRvciBjbGFzc1xuY2xhc3MgU2Vzc2lvbiB7XG4gIGNvbnN0cnVjdG9yKGNvbW8sIHNlc3Npb25TdGF0ZSkge1xuICAgIHRoaXMuY29tbyA9IGNvbW87XG4gICAgdGhpcy5zdGF0ZSA9IHNlc3Npb25TdGF0ZTtcblxuICAgIHRoaXMuYXVkaW9CdWZmZXJzID0ge307XG4gICAgdGhpcy5sYWJlbEF1ZGlvRmlsZVRhYmxlID0gbmV3IExhYmVsQXVkaW9GaWxlVGFibGUodGhpcyk7XG4gIH1cblxuICBhc3luYyBpbml0KCkge1xuICAgIGF3YWl0IHRoaXMudXBkYXRlQXVkaW9GaWxlcygpO1xuXG4gICAgdGhpcy5zdGF0ZS5zdWJzY3JpYmUodXBkYXRlcyA9PiB7XG4gICAgICBmb3IgKGxldCBuYW1lIGluIHVwZGF0ZXMpIHtcbiAgICAgICAgc3dpdGNoIChuYW1lKSB7XG4gICAgICAgICAgY2FzZSAnYXVkaW9GaWxlcyc6IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlQXVkaW9GaWxlcygpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXRWYWx1ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0VmFsdWVzKCk7XG4gIH1cblxuICBnZXQobmFtZSkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldChuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIHNldCh2YWx1ZXMpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zdGF0ZS5zZXQodmFsdWVzKTtcbiAgfVxuXG4gIHN1YnNjcmliZShmdW5jKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuc3Vic2NyaWJlKGZ1bmMpO1xuICB9XG5cbiAgYXN5bmMgZGV0YWNoKCkge1xuICAgIGF3YWl0IHRoaXMuc3RhdGUuZGV0YWNoKCk7XG4gIH1cblxuICBvbkRldGFjaChmdW5jKSB7XG4gICAgLy8gQG5vdGUgLSBqdXN0IGEgZGVjb3JhdG9yIGZvciBsb2dcbiAgICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdAdG9kbyAtIGNsZWFuIHNlc3Npb24gYXVkaW8gYnVmZmVycycpO1xuICAgICAgZnVuYygpO1xuICAgIH1cblxuICAgIHRoaXMuc3RhdGUub25EZXRhY2goY2FsbGJhY2spO1xuICB9XG5cbiAgb25EZWxldGUoZnVuYykge1xuICAgIHRoaXMuc3RhdGUub25EZWxldGUoZnVuYyk7XG4gIH1cblxuICBhZGRFeGFtcGxlKGV4YW1wbGUpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246YWRkRXhhbXBsZWAsIHNlc3Npb25JZCwgZXhhbXBsZSk7XG4gIH1cblxuICBkZWxldGVFeGFtcGxlKGV4YW1wbGVVdWlkKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmRlbGV0ZUV4YW1wbGVgLCBzZXNzaW9uSWQsIGV4YW1wbGVVdWlkKTtcbiAgfVxuXG4gIGNsZWFyRXhhbXBsZXMobGFiZWwgPSBudWxsKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmNsZWFyRXhhbXBsZXNgLCBzZXNzaW9uSWQsIGxhYmVsKTtcbiAgfVxuXG4gIHNldEdyYXBoT3B0aW9ucyhtb2R1bGVJZCwgdXBkYXRlcykge1xuICAgIHRoaXMuc3RhdGUuc2V0KHsgZ3JhcGhPcHRpb25zRXZlbnQ6IHsgW21vZHVsZUlkXTogdXBkYXRlcyB9fSk7XG4gIH1cblxuICBnZXRHcmFwaE9wdGlvbnMobW9kdWxlSWQpIHtcbiAgICBncmFwaE9wdGlvbnMgPSB0aGlzLnN0YXRlLmdldCgnZ3JhcGhPcHRpb25zJyk7XG4gICAgcmV0dXJuIGdyYXBoT3B0aW9uc1ttb2R1bGVJZF07XG4gIH1cblxuICBjcmVhdGVMYWJlbChsYWJlbCkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjpjcmVhdGVMYWJlbGAsIHNlc3Npb25JZCwgbGFiZWwpO1xuICB9XG5cbiAgdXBkYXRlTGFiZWwob2xkTGFiZWwsIG5ld0xhYmVsKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOnVwZGF0ZUxhYmVsYCwgc2Vzc2lvbklkLCBvbGRMYWJlbCwgbmV3TGFiZWwpO1xuICB9XG5cbiAgZGVsZXRlTGFiZWwobGFiZWwpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246ZGVsZXRlTGFiZWxgLCBzZXNzaW9uSWQsIGxhYmVsKTtcbiAgfVxuXG4gIHRvZ2dsZUF1ZGlvRmlsZShmaWxlbmFtZSwgYWN0aXZlKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOnRvZ2dsZUF1ZGlvRmlsZWAsIHNlc3Npb25JZCwgZmlsZW5hbWUsIGFjdGl2ZSk7XG4gIH1cblxuICBjcmVhdGVMYWJlbEF1ZGlvRmlsZVJvdyhyb3cpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246Y3JlYXRlTGFiZWxBdWRpb0ZpbGVSb3dgLCBzZXNzaW9uSWQsIHJvdyk7XG4gIH1cblxuICBkZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyhyb3cpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246ZGVsZXRlTGFiZWxBdWRpb0ZpbGVSb3dgLCBzZXNzaW9uSWQsIHJvdyk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVBdWRpb0ZpbGVzKCkge1xuICAgIGNvbnN0IGF1ZGlvRmlsZXMgPSB0aGlzLnN0YXRlLmdldCgnYXVkaW9GaWxlcycpO1xuICAgIGNvbnN0IGFjdGl2ZUF1ZGlvRmlsZXMgPSBhdWRpb0ZpbGVzLmZpbHRlcihhdWRpb0ZpbGUgPT4gYXVkaW9GaWxlLmFjdGl2ZSk7XG4gICAgY29uc3QgYXVkaW9CdWZmZXJMb2FkZXIgPSB0aGlzLmNvbW8uZXhwZXJpZW5jZS5wbHVnaW5zWydhdWRpby1idWZmZXItbG9hZGVyJ107XG5cbiAgICBpZiAodGhpcy5jb21vLnByb2plY3QuZ2V0KCdwcmVsb2FkQXVkaW9GaWxlcycpKSB7XG4gICAgICAvLyBwaWNrIGF1ZGlvIGZpbGVzIGZyb20gYXVkaW8tYnVmZmVyLWxvYWQgY2FjaGVcbiAgICAgIHRoaXMuYXVkaW9CdWZmZXJzID0ge307XG5cbiAgICAgIGFjdGl2ZUF1ZGlvRmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgdGhpcy5hdWRpb0J1ZmZlcnNbZmlsZS5uYW1lXSA9IGF1ZGlvQnVmZmVyTG9hZGVyLmRhdGFbZmlsZS5uYW1lXTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBmaWxlc1RvTG9hZCA9IHt9O1xuICAgICAgYWN0aXZlQXVkaW9GaWxlcy5mb3JFYWNoKGZpbGUgPT4gZmlsZXNUb0xvYWRbZmlsZS5uYW1lXSA9IGZpbGUudXJsKTtcblxuICAgICAgdGhpcy5hdWRpb0J1ZmZlcnMgPSBhd2FpdCBhdWRpb0J1ZmZlckxvYWRlci5sb2FkKGZpbGVzVG9Mb2FkKTtcbiAgICB9XG4gICAgLy8gY2xlYXIgYXVkaW8gYnVmZmVyIGxvYWRlciBjYWNoZVxuICAgIGF1ZGlvQnVmZmVyTG9hZGVyLmRhdGEgPSB7fTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTZXNzaW9uO1xuIl19