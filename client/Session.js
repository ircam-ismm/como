"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _diffArrays = _interopRequireDefault(require("../common/utils/diffArrays.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LabelAudioFileTable {
  constructor(session) {
    this.session = session;
  }

  query(label) {
    const result = [];
    const labelAudioFileTable = this.session.get('labelAudioFileTable');

    for (let [_label, filename] of labelAudioFileTable) {
      if (label === _label) {
        result.push(filename);
      }
    }

    return result;
  }

  queryBuffers(label) {
    const result = this.query(label);
    return result.map(filename => this.session.audioBuffers[filename]);
  }

  delete(label = null, filename = null) {}

  insert(label, filename) {}

} // we should maybe have a parent StateDecorator class


class Session {
  constructor(como, sessionState) {
    this.como = como;
    this.state = sessionState;
    this.audioBuffers = {};
    this.labelAudioFileTable = new LabelAudioFileTable(this);
  }

  async init() {
    await this.updateAudioFiles();
    this.state.subscribe(updates => {
      for (let name in updates) {
        switch (name) {
          case 'audioFiles':
            {
              this.updateAudioFiles();
              break;
            }
        }
      }
    });
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async set(values) {
    return await this.state.set(values);
  }

  subscribe(func) {
    return this.state.subscribe(func);
  }

  async detach() {
    await this.state.detach();
  }

  onDetach(func) {
    // @note - just a decorator for log
    const callback = () => {
      console.log('@todo - clean session audio buffers');
      func();
    };

    this.state.onDetach(callback);
  }

  onDelete(func) {
    this.state.onDelete(func);
  }

  addExample(example) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:addExample`, sessionId, example);
  }

  deleteExample(exampleUuid) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteExample`, sessionId, exampleUuid);
  }

  clearExamples(label = null) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:clearExamples`, sessionId, label);
  }

  setGraphOptions(moduleId, updates) {
    this.state.set({
      graphOptionsEvent: {
        [moduleId]: updates
      }
    });
  }

  getGraphOptions(moduleId) {
    graphOptions = this.state.get('graphOptions');
    return graphOptions[moduleId];
  }

  createLabel(label) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:createLabel`, sessionId, label);
  }

  updateLabel(oldLabel, newLabel) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:updateLabel`, sessionId, oldLabel, newLabel);
  }

  deleteLabel(label) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteLabel`, sessionId, label);
  }

  toggleAudioFile(filename, active) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:toggleAudioFile`, sessionId, filename, active);
  }

  createLabelAudioFileRow(row) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:createLabelAudioFileRow`, sessionId, row);
  }

  deleteLabelAudioFileRow(row) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteLabelAudioFileRow`, sessionId, row);
  }

  async updateAudioFiles() {
    const audioFiles = this.state.get('audioFiles');
    const audioBufferLoader = this.como.experience.plugins['audio-buffer-loader'];
    const activeAudioFiles = audioFiles.filter(audioFile => audioFile.active);
    const filesToLoad = {};
    activeAudioFiles.forEach(file => filesToLoad[file.name] = file.url);
    this.audioBuffers = await audioBufferLoader.load(filesToLoad); // clear audio buffer loader cache

    audioBufferLoader.data = {};
  }

}

var _default = Session;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvU2Vzc2lvbi5qcyJdLCJuYW1lcyI6WyJMYWJlbEF1ZGlvRmlsZVRhYmxlIiwiY29uc3RydWN0b3IiLCJzZXNzaW9uIiwicXVlcnkiLCJsYWJlbCIsInJlc3VsdCIsImxhYmVsQXVkaW9GaWxlVGFibGUiLCJnZXQiLCJfbGFiZWwiLCJmaWxlbmFtZSIsInB1c2giLCJxdWVyeUJ1ZmZlcnMiLCJtYXAiLCJhdWRpb0J1ZmZlcnMiLCJkZWxldGUiLCJpbnNlcnQiLCJTZXNzaW9uIiwiY29tbyIsInNlc3Npb25TdGF0ZSIsInN0YXRlIiwiaW5pdCIsInVwZGF0ZUF1ZGlvRmlsZXMiLCJzdWJzY3JpYmUiLCJ1cGRhdGVzIiwibmFtZSIsImdldFZhbHVlcyIsInNldCIsInZhbHVlcyIsImZ1bmMiLCJkZXRhY2giLCJvbkRldGFjaCIsImNhbGxiYWNrIiwiY29uc29sZSIsImxvZyIsIm9uRGVsZXRlIiwiYWRkRXhhbXBsZSIsImV4YW1wbGUiLCJzZXNzaW9uSWQiLCJjbGllbnQiLCJzb2NrZXQiLCJzZW5kIiwiZGVsZXRlRXhhbXBsZSIsImV4YW1wbGVVdWlkIiwiY2xlYXJFeGFtcGxlcyIsInNldEdyYXBoT3B0aW9ucyIsIm1vZHVsZUlkIiwiZ3JhcGhPcHRpb25zRXZlbnQiLCJnZXRHcmFwaE9wdGlvbnMiLCJncmFwaE9wdGlvbnMiLCJjcmVhdGVMYWJlbCIsInVwZGF0ZUxhYmVsIiwib2xkTGFiZWwiLCJuZXdMYWJlbCIsImRlbGV0ZUxhYmVsIiwidG9nZ2xlQXVkaW9GaWxlIiwiYWN0aXZlIiwiY3JlYXRlTGFiZWxBdWRpb0ZpbGVSb3ciLCJyb3ciLCJkZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyIsImF1ZGlvRmlsZXMiLCJhdWRpb0J1ZmZlckxvYWRlciIsImV4cGVyaWVuY2UiLCJwbHVnaW5zIiwiYWN0aXZlQXVkaW9GaWxlcyIsImZpbHRlciIsImF1ZGlvRmlsZSIsImZpbGVzVG9Mb2FkIiwiZm9yRWFjaCIsImZpbGUiLCJ1cmwiLCJs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IGRpZmZBcnJheXMgZnJvbSAnLi4vY29tbW9uL3V0aWxzL2RpZmZBcnJheXMuanMnO1xuXG5jbGFzcyBMYWJlbEF1ZGlvRmlsZVRhYmxlIHtcbiAgY29uc3RydWN0b3Ioc2Vzc2lvbikge1xuICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb247XG4gIH1cblxuICBxdWVyeShsYWJlbCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgIGNvbnN0IGxhYmVsQXVkaW9GaWxlVGFibGUgPSB0aGlzLnNlc3Npb24uZ2V0KCdsYWJlbEF1ZGlvRmlsZVRhYmxlJyk7XG5cbiAgICBmb3IgKGxldCBbX2xhYmVsLCBmaWxlbmFtZV0gb2YgbGFiZWxBdWRpb0ZpbGVUYWJsZSkge1xuICAgICAgaWYgKGxhYmVsID09PSBfbGFiZWwpIHtcbiAgICAgICAgcmVzdWx0LnB1c2goZmlsZW5hbWUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBxdWVyeUJ1ZmZlcnMobGFiZWwpIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnF1ZXJ5KGxhYmVsKTtcbiAgICByZXR1cm4gcmVzdWx0Lm1hcChmaWxlbmFtZSA9PiB0aGlzLnNlc3Npb24uYXVkaW9CdWZmZXJzW2ZpbGVuYW1lXSk7XG4gIH1cblxuICBkZWxldGUobGFiZWwgPSBudWxsLCBmaWxlbmFtZSA9IG51bGwpIHtcblxuICB9XG5cbiAgaW5zZXJ0KGxhYmVsLCBmaWxlbmFtZSkge1xuXG4gIH1cbn1cblxuLy8gd2Ugc2hvdWxkIG1heWJlIGhhdmUgYSBwYXJlbnQgU3RhdGVEZWNvcmF0b3IgY2xhc3NcbmNsYXNzIFNlc3Npb24ge1xuICBjb25zdHJ1Y3Rvcihjb21vLCBzZXNzaW9uU3RhdGUpIHtcbiAgICB0aGlzLmNvbW8gPSBjb21vO1xuICAgIHRoaXMuc3RhdGUgPSBzZXNzaW9uU3RhdGU7XG5cbiAgICB0aGlzLmF1ZGlvQnVmZmVycyA9IHt9O1xuICAgIHRoaXMubGFiZWxBdWRpb0ZpbGVUYWJsZSA9IG5ldyBMYWJlbEF1ZGlvRmlsZVRhYmxlKHRoaXMpO1xuICB9XG5cbiAgYXN5bmMgaW5pdCgpIHtcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZUF1ZGlvRmlsZXMoKTtcblxuICAgIHRoaXMuc3RhdGUuc3Vic2NyaWJlKHVwZGF0ZXMgPT4ge1xuICAgICAgZm9yIChsZXQgbmFtZSBpbiB1cGRhdGVzKSB7XG4gICAgICAgIHN3aXRjaCAobmFtZSkge1xuICAgICAgICAgIGNhc2UgJ2F1ZGlvRmlsZXMnOiB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUF1ZGlvRmlsZXMoKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0VmFsdWVzKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldFZhbHVlcygpO1xuICB9XG5cbiAgZ2V0KG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXQobmFtZSk7XG4gIH1cblxuICBhc3luYyBzZXQodmFsdWVzKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc3RhdGUuc2V0KHZhbHVlcyk7XG4gIH1cblxuICBzdWJzY3JpYmUoZnVuYykge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLnN1YnNjcmliZShmdW5jKTtcbiAgfVxuXG4gIGFzeW5jIGRldGFjaCgpIHtcbiAgICBhd2FpdCB0aGlzLnN0YXRlLmRldGFjaCgpO1xuICB9XG5cbiAgb25EZXRhY2goZnVuYykge1xuICAgIC8vIEBub3RlIC0ganVzdCBhIGRlY29yYXRvciBmb3IgbG9nXG4gICAgY29uc3QgY2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnQHRvZG8gLSBjbGVhbiBzZXNzaW9uIGF1ZGlvIGJ1ZmZlcnMnKTtcbiAgICAgIGZ1bmMoKTtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXRlLm9uRGV0YWNoKGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGVsZXRlKGZ1bmMpIHtcbiAgICB0aGlzLnN0YXRlLm9uRGVsZXRlKGZ1bmMpO1xuICB9XG5cbiAgYWRkRXhhbXBsZShleGFtcGxlKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmFkZEV4YW1wbGVgLCBzZXNzaW9uSWQsIGV4YW1wbGUpO1xuICB9XG5cbiAgZGVsZXRlRXhhbXBsZShleGFtcGxlVXVpZCkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjpkZWxldGVFeGFtcGxlYCwgc2Vzc2lvbklkLCBleGFtcGxlVXVpZCk7XG4gIH1cblxuICBjbGVhckV4YW1wbGVzKGxhYmVsID0gbnVsbCkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjpjbGVhckV4YW1wbGVzYCwgc2Vzc2lvbklkLCBsYWJlbCk7XG4gIH1cblxuICBzZXRHcmFwaE9wdGlvbnMobW9kdWxlSWQsIHVwZGF0ZXMpIHtcbiAgICB0aGlzLnN0YXRlLnNldCh7IGdyYXBoT3B0aW9uc0V2ZW50OiB7IFttb2R1bGVJZF06IHVwZGF0ZXMgfX0pO1xuICB9XG5cbiAgZ2V0R3JhcGhPcHRpb25zKG1vZHVsZUlkKSB7XG4gICAgZ3JhcGhPcHRpb25zID0gdGhpcy5zdGF0ZS5nZXQoJ2dyYXBoT3B0aW9ucycpO1xuICAgIHJldHVybiBncmFwaE9wdGlvbnNbbW9kdWxlSWRdO1xuICB9XG5cbiAgY3JlYXRlTGFiZWwobGFiZWwpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246Y3JlYXRlTGFiZWxgLCBzZXNzaW9uSWQsIGxhYmVsKTtcbiAgfVxuXG4gIHVwZGF0ZUxhYmVsKG9sZExhYmVsLCBuZXdMYWJlbCkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjp1cGRhdGVMYWJlbGAsIHNlc3Npb25JZCwgb2xkTGFiZWwsIG5ld0xhYmVsKTtcbiAgfVxuXG4gIGRlbGV0ZUxhYmVsKGxhYmVsKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmRlbGV0ZUxhYmVsYCwgc2Vzc2lvbklkLCBsYWJlbCk7XG4gIH1cblxuICB0b2dnbGVBdWRpb0ZpbGUoZmlsZW5hbWUsIGFjdGl2ZSkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjp0b2dnbGVBdWRpb0ZpbGVgLCBzZXNzaW9uSWQsIGZpbGVuYW1lLCBhY3RpdmUpO1xuICB9XG5cbiAgY3JlYXRlTGFiZWxBdWRpb0ZpbGVSb3cocm93KSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmNyZWF0ZUxhYmVsQXVkaW9GaWxlUm93YCwgc2Vzc2lvbklkLCByb3cpO1xuICB9XG5cbiAgZGVsZXRlTGFiZWxBdWRpb0ZpbGVSb3cocm93KSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmRlbGV0ZUxhYmVsQXVkaW9GaWxlUm93YCwgc2Vzc2lvbklkLCByb3cpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlQXVkaW9GaWxlcygpIHtcbiAgICBjb25zdCBhdWRpb0ZpbGVzID0gdGhpcy5zdGF0ZS5nZXQoJ2F1ZGlvRmlsZXMnKTtcbiAgICBjb25zdCBhdWRpb0J1ZmZlckxvYWRlciA9IHRoaXMuY29tby5leHBlcmllbmNlLnBsdWdpbnNbJ2F1ZGlvLWJ1ZmZlci1sb2FkZXInXTtcblxuICAgIGNvbnN0IGFjdGl2ZUF1ZGlvRmlsZXMgPSBhdWRpb0ZpbGVzLmZpbHRlcihhdWRpb0ZpbGUgPT4gYXVkaW9GaWxlLmFjdGl2ZSk7XG4gICAgY29uc3QgZmlsZXNUb0xvYWQgPSB7fTtcbiAgICBhY3RpdmVBdWRpb0ZpbGVzLmZvckVhY2goZmlsZSA9PiBmaWxlc1RvTG9hZFtmaWxlLm5hbWVdID0gZmlsZS51cmwpO1xuXG4gICAgdGhpcy5hdWRpb0J1ZmZlcnMgPSBhd2FpdCBhdWRpb0J1ZmZlckxvYWRlci5sb2FkKGZpbGVzVG9Mb2FkKTtcbiAgICAvLyBjbGVhciBhdWRpbyBidWZmZXIgbG9hZGVyIGNhY2hlXG4gICAgYXVkaW9CdWZmZXJMb2FkZXIuZGF0YSA9IHt9O1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNlc3Npb247XG4iXX0=