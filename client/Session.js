"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _diffArrays = _interopRequireDefault(require("../common/utils/diffArrays.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LabelAudioFileTable {
  constructor(session) {
    this.session = session;
  }

  query(label) {
    const result = [];
    const labelAudioFileTable = this.session.get('labelAudioFileTable');

    for (let [_label, filename] of labelAudioFileTable) {
      if (label === _label) {
        result.push(filename);
      }
    }

    return result;
  }

  queryBuffers(label) {
    const result = this.query(label);
    return result.map(filename => this.session.audioBuffers[filename]);
  }

  delete(label = null, filename = null) {}

  insert(label, filename) {}

} // we should maybe have a parent StateDecorator class


class Session {
  constructor(como, sessionState) {
    this.como = como;
    this.state = sessionState;
    this.audioBuffers = {};
    this.labelAudioFileTable = new LabelAudioFileTable(this);
  }

  async init() {
    await this.updateAudioFiles();
    this.state.subscribe(updates => {
      for (let name in updates) {
        switch (name) {
          case 'audioFiles':
            {
              this.updateAudioFiles();
              break;
            }
        }
      }
    });
  }

  getValues() {
    return this.state.getValues();
  }

  get(name) {
    return this.state.get(name);
  }

  async set(values) {
    return await this.state.set(values);
  }

  subscribe(func) {
    return this.state.subscribe(func);
  }

  async detach() {
    await this.state.detach();
  }

  onDetach(func) {
    // @note - just a decorator for log
    const callback = () => {
      console.log('@todo - clean session audio buffers');
      func();
    };

    this.state.onDetach(callback);
  }

  onDelete(func) {
    this.state.onDelete(func);
  }

  addExample(example) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:addExample`, sessionId, example);
  }

  deleteExample(exampleUuid) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteExample`, sessionId, exampleUuid);
  }

  clearExamples(label = null) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:clearExamples`, sessionId, label);
  }

  setGraphOptions(moduleId, updates) {
    this.state.set({
      graphOptionsEvent: {
        [moduleId]: updates
      }
    });
  }

  getGraphOptions(moduleId) {
    graphOptions = this.state.get('graphOptions');
    return graphOptions[moduleId];
  }

  createLabel(label) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:createLabel`, sessionId, label);
  }

  updateLabel(oldLabel, newLabel) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:updateLabel`, sessionId, oldLabel, newLabel);
  }

  deleteLabel(label) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteLabel`, sessionId, label);
  }

  toggleAudioFile(filename, active) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:toggleAudioFile`, sessionId, filename, active);
  }

  createLabelAudioFileRow(row) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:createLabelAudioFileRow`, sessionId, row);
  }

  deleteLabelAudioFileRow(row) {
    const sessionId = this.state.get('id');
    this.como.client.socket.send(`como:session:deleteLabelAudioFileRow`, sessionId, row);
  }

  async updateAudioFiles() {
    if (!this.como.experience.plugins['audio-buffer-loader']) {
      return;
    }

    const audioFiles = this.state.get('audioFiles');
    const activeAudioFiles = audioFiles.filter(audioFile => audioFile.active);
    const audioBufferLoader = this.como.experience.plugins['audio-buffer-loader'];

    if (this.como.project.get('preloadAudioFiles')) {
      // pick audio files from audio-buffer-load cache
      this.audioBuffers = {};
      activeAudioFiles.forEach(file => {
        this.audioBuffers[file.name] = audioBufferLoader.data[file.name];
      });
    } else {
      // load active files from session
      const filesToLoad = {};
      activeAudioFiles.forEach(file => filesToLoad[file.name] = file.url);
      this.audioBuffers = await audioBufferLoader.load(filesToLoad); // clear audio buffer loader cache

      audioBufferLoader.data = {};
    }
  }

}

var _default = Session;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvU2Vzc2lvbi5qcyJdLCJuYW1lcyI6WyJMYWJlbEF1ZGlvRmlsZVRhYmxlIiwiY29uc3RydWN0b3IiLCJzZXNzaW9uIiwicXVlcnkiLCJsYWJlbCIsInJlc3VsdCIsImxhYmVsQXVkaW9GaWxlVGFibGUiLCJnZXQiLCJfbGFiZWwiLCJmaWxlbmFtZSIsInB1c2giLCJxdWVyeUJ1ZmZlcnMiLCJtYXAiLCJhdWRpb0J1ZmZlcnMiLCJkZWxldGUiLCJpbnNlcnQiLCJTZXNzaW9uIiwiY29tbyIsInNlc3Npb25TdGF0ZSIsInN0YXRlIiwiaW5pdCIsInVwZGF0ZUF1ZGlvRmlsZXMiLCJzdWJzY3JpYmUiLCJ1cGRhdGVzIiwibmFtZSIsImdldFZhbHVlcyIsInNldCIsInZhbHVlcyIsImZ1bmMiLCJkZXRhY2giLCJvbkRldGFjaCIsImNhbGxiYWNrIiwiY29uc29sZSIsImxvZyIsIm9uRGVsZXRlIiwiYWRkRXhhbXBsZSIsImV4YW1wbGUiLCJzZXNzaW9uSWQiLCJjbGllbnQiLCJzb2NrZXQiLCJzZW5kIiwiZGVsZXRlRXhhbXBsZSIsImV4YW1wbGVVdWlkIiwiY2xlYXJFeGFtcGxlcyIsInNldEdyYXBoT3B0aW9ucyIsIm1vZHVsZUlkIiwiZ3JhcGhPcHRpb25zRXZlbnQiLCJnZXRHcmFwaE9wdGlvbnMiLCJncmFwaE9wdGlvbnMiLCJjcmVhdGVMYWJlbCIsInVwZGF0ZUxhYmVsIiwib2xkTGFiZWwiLCJuZXdMYWJlbCIsImRlbGV0ZUxhYmVsIiwidG9nZ2xlQXVkaW9GaWxlIiwiYWN0aXZlIiwiY3JlYXRlTGFiZWxBdWRpb0ZpbGVSb3ciLCJyb3ciLCJkZWxldGVMYWJlbEF1ZGlvRmlsZVJvdyIsImV4cGVyaWVuY2UiLCJwbHVnaW5zIiwiYXVkaW9GaWxlcyIsImFjdGl2ZUF1ZGlvRmlsZXMiLCJmaWx0ZXIiLCJhdWRpb0ZpbGUiLCJhdWRpb0J1ZmZlckxvYWRlciIsInByb2plY3QiLCJmb3JFYWNoIiwiZmlsZSIsImRhdGEiLCJmaWxl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QWlCLENBQUNJLElBQWxCLENBQXVCRCxJQUFJLENBQUM1QyxJQUE1QixDQUEvQjtBQUNELE9BRkQ7QUFHRCxLQVBELE1BT087QUFDTDtBQUNBLFlBQU04QyxXQUFXLEdBQUcsRUFBcEI7QUFDQVIsTUFBQUEsZ0JBQWdCLENBQUNLLE9BQWpCLENBQXlCQyxJQUFJLElBQUlFLFdBQVcsQ0FBQ0YsSUFBSSxDQUFDNUMsSUFBTixDQUFYLEdBQXlCNEMsSUFBSSxDQUFDRyxHQUEvRDtBQUVBLFdBQUsxRCxZQUFMLEdBQW9CLE1BQU1vRCxpQkFBaUIsQ0FBQ08sSUFBbEIsQ0FBdUJGLFdBQXZCLENBQTFCLENBTEssQ0FNTDs7QUFDQUwsTUFBQUEsaUJBQWlCLENBQUNJLElBQWxCLEdBQXlCLEVBQXpCO0FBQ0Q7QUFDRjs7QUF6SVc7O2VBNElDckQsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkaWZmQXJyYXlzIGZyb20gJy4uL2NvbW1vbi91dGlscy9kaWZmQXJyYXlzLmpzJztcblxuY2xhc3MgTGFiZWxBdWRpb0ZpbGVUYWJsZSB7XG4gIGNvbnN0cnVjdG9yKHNlc3Npb24pIHtcbiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uO1xuICB9XG5cbiAgcXVlcnkobGFiZWwpIHtcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcbiAgICBjb25zdCBsYWJlbEF1ZGlvRmlsZVRhYmxlID0gdGhpcy5zZXNzaW9uLmdldCgnbGFiZWxBdWRpb0ZpbGVUYWJsZScpO1xuXG4gICAgZm9yIChsZXQgW19sYWJlbCwgZmlsZW5hbWVdIG9mIGxhYmVsQXVkaW9GaWxlVGFibGUpIHtcbiAgICAgIGlmIChsYWJlbCA9PT0gX2xhYmVsKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKGZpbGVuYW1lKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcXVlcnlCdWZmZXJzKGxhYmVsKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5xdWVyeShsYWJlbCk7XG4gICAgcmV0dXJuIHJlc3VsdC5tYXAoZmlsZW5hbWUgPT4gdGhpcy5zZXNzaW9uLmF1ZGlvQnVmZmVyc1tmaWxlbmFtZV0pO1xuICB9XG5cbiAgZGVsZXRlKGxhYmVsID0gbnVsbCwgZmlsZW5hbWUgPSBudWxsKSB7XG5cbiAgfVxuXG4gIGluc2VydChsYWJlbCwgZmlsZW5hbWUpIHtcblxuICB9XG59XG5cbi8vIHdlIHNob3VsZCBtYXliZSBoYXZlIGEgcGFyZW50IFN0YXRlRGVjb3JhdG9yIGNsYXNzXG5jbGFzcyBTZXNzaW9uIHtcbiAgY29uc3RydWN0b3IoY29tbywgc2Vzc2lvblN0YXRlKSB7XG4gICAgdGhpcy5jb21vID0gY29tbztcbiAgICB0aGlzLnN0YXRlID0gc2Vzc2lvblN0YXRlO1xuXG4gICAgdGhpcy5hdWRpb0J1ZmZlcnMgPSB7fTtcbiAgICB0aGlzLmxhYmVsQXVkaW9GaWxlVGFibGUgPSBuZXcgTGFiZWxBdWRpb0ZpbGVUYWJsZSh0aGlzKTtcbiAgfVxuXG4gIGFzeW5jIGluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGVBdWRpb0ZpbGVzKCk7XG5cbiAgICB0aGlzLnN0YXRlLnN1YnNjcmliZSh1cGRhdGVzID0+IHtcbiAgICAgIGZvciAobGV0IG5hbWUgaW4gdXBkYXRlcykge1xuICAgICAgICBzd2l0Y2ggKG5hbWUpIHtcbiAgICAgICAgICBjYXNlICdhdWRpb0ZpbGVzJzoge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVBdWRpb0ZpbGVzKCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGdldFZhbHVlcygpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXRWYWx1ZXMoKTtcbiAgfVxuXG4gIGdldChuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0KG5hbWUpO1xuICB9XG5cbiAgYXN5bmMgc2V0KHZhbHVlcykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnN0YXRlLnNldCh2YWx1ZXMpO1xuICB9XG5cbiAgc3Vic2NyaWJlKGZ1bmMpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5zdWJzY3JpYmUoZnVuYyk7XG4gIH1cblxuICBhc3luYyBkZXRhY2goKSB7XG4gICAgYXdhaXQgdGhpcy5zdGF0ZS5kZXRhY2goKTtcbiAgfVxuXG4gIG9uRGV0YWNoKGZ1bmMpIHtcbiAgICAvLyBAbm90ZSAtIGp1c3QgYSBkZWNvcmF0b3IgZm9yIGxvZ1xuICAgIGNvbnN0IGNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ0B0b2RvIC0gY2xlYW4gc2Vzc2lvbiBhdWRpbyBidWZmZXJzJyk7XG4gICAgICBmdW5jKCk7XG4gICAgfVxuXG4gICAgdGhpcy5zdGF0ZS5vbkRldGFjaChjYWxsYmFjayk7XG4gIH1cblxuICBvbkRlbGV0ZShmdW5jKSB7XG4gICAgdGhpcy5zdGF0ZS5vbkRlbGV0ZShmdW5jKTtcbiAgfVxuXG4gIGFkZEV4YW1wbGUoZXhhbXBsZSkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjphZGRFeGFtcGxlYCwgc2Vzc2lvbklkLCBleGFtcGxlKTtcbiAgfVxuXG4gIGRlbGV0ZUV4YW1wbGUoZXhhbXBsZVV1aWQpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246ZGVsZXRlRXhhbXBsZWAsIHNlc3Npb25JZCwgZXhhbXBsZVV1aWQpO1xuICB9XG5cbiAgY2xlYXJFeGFtcGxlcyhsYWJlbCA9IG51bGwpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246Y2xlYXJFeGFtcGxlc2AsIHNlc3Npb25JZCwgbGFiZWwpO1xuICB9XG5cbiAgc2V0R3JhcGhPcHRpb25zKG1vZHVsZUlkLCB1cGRhdGVzKSB7XG4gICAgdGhpcy5zdGF0ZS5zZXQoeyBncmFwaE9wdGlvbnNFdmVudDogeyBbbW9kdWxlSWRdOiB1cGRhdGVzIH19KTtcbiAgfVxuXG4gIGdldEdyYXBoT3B0aW9ucyhtb2R1bGVJZCkge1xuICAgIGdyYXBoT3B0aW9ucyA9IHRoaXMuc3RhdGUuZ2V0KCdncmFwaE9wdGlvbnMnKTtcbiAgICByZXR1cm4gZ3JhcGhPcHRpb25zW21vZHVsZUlkXTtcbiAgfVxuXG4gIGNyZWF0ZUxhYmVsKGxhYmVsKSB7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdGF0ZS5nZXQoJ2lkJyk7XG4gICAgdGhpcy5jb21vLmNsaWVudC5zb2NrZXQuc2VuZChgY29tbzpzZXNzaW9uOmNyZWF0ZUxhYmVsYCwgc2Vzc2lvbklkLCBsYWJlbCk7XG4gIH1cblxuICB1cGRhdGVMYWJlbChvbGRMYWJlbCwgbmV3TGFiZWwpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246dXBkYXRlTGFiZWxgLCBzZXNzaW9uSWQsIG9sZExhYmVsLCBuZXdMYWJlbCk7XG4gIH1cblxuICBkZWxldGVMYWJlbChsYWJlbCkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjpkZWxldGVMYWJlbGAsIHNlc3Npb25JZCwgbGFiZWwpO1xuICB9XG5cbiAgdG9nZ2xlQXVkaW9GaWxlKGZpbGVuYW1lLCBhY3RpdmUpIHtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSB0aGlzLnN0YXRlLmdldCgnaWQnKTtcbiAgICB0aGlzLmNvbW8uY2xpZW50LnNvY2tldC5zZW5kKGBjb21vOnNlc3Npb246dG9nZ2xlQXVkaW9GaWxlYCwgc2Vzc2lvbklkLCBmaWxlbmFtZSwgYWN0aXZlKTtcbiAgfVxuXG4gIGNyZWF0ZUxhYmVsQXVkaW9GaWxlUm93KHJvdykge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjpjcmVhdGVMYWJlbEF1ZGlvRmlsZVJvd2AsIHNlc3Npb25JZCwgcm93KTtcbiAgfVxuXG4gIGRlbGV0ZUxhYmVsQXVkaW9GaWxlUm93KHJvdykge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RhdGUuZ2V0KCdpZCcpO1xuICAgIHRoaXMuY29tby5jbGllbnQuc29ja2V0LnNlbmQoYGNvbW86c2Vzc2lvbjpkZWxldGVMYWJlbEF1ZGlvRmlsZVJvd2AsIHNlc3Npb25JZCwgcm93KTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZUF1ZGlvRmlsZXMoKSB7XG4gICAgaWYgKCF0aGlzLmNvbW8uZXhwZXJpZW5jZS5wbHVnaW5zWydhdWRpby1idWZmZXItbG9hZGVyJ10pIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IGF1ZGlvRmlsZXMgPSB0aGlzLnN0YXRlLmdldCgnYXVkaW9GaWxlcycpO1xuICAgIGNvbnN0IGFjdGl2ZUF1ZGlvRmlsZXMgPSBhdWRpb0ZpbGVzLmZpbHRlcihhdWRpb0ZpbGUgPT4gYXVkaW9GaWxlLmFjdGl2ZSk7XG4gICAgY29uc3QgYXVkaW9CdWZmZXJMb2FkZXIgPSB0aGlzLmNvbW8uZXhwZXJpZW5jZS5wbHVnaW5zWydhdWRpby1idWZmZXItbG9hZGVyJ107XG5cbiAgICBpZiAodGhpcy5jb21vLnByb2plY3QuZ2V0KCdwcmVsb2FkQXVkaW9GaWxlcycpKSB7XG4gICAgICAvLyBwaWNrIGF1ZGlvIGZpbGVzIGZyb20gYXVkaW8tYnVmZmVyLWxvYWQgY2FjaGVcbiAgICAgIHRoaXMuYXVkaW9CdWZmZXJzID0ge307XG5cbiAgICAgIGFjdGl2ZUF1ZGlvRmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgdGhpcy5hdWRpb0J1ZmZlcnNbZmlsZS5uYW1lXSA9IGF1ZGlvQnVmZmVyTG9hZGVyLmRhdGFbZmlsZS5uYW1lXTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBsb2FkIGFjdGl2ZSBmaWxlcyBmcm9tIHNlc3Npb25cbiAgICAgIGNvbnN0IGZpbGVzVG9Mb2FkID0ge307XG4gICAgICBhY3RpdmVBdWRpb0ZpbGVzLmZvckVhY2goZmlsZSA9PiBmaWxlc1RvTG9hZFtmaWxlLm5hbWVdID0gZmlsZS51cmwpO1xuXG4gICAgICB0aGlzLmF1ZGlvQnVmZmVycyA9IGF3YWl0IGF1ZGlvQnVmZmVyTG9hZGVyLmxvYWQoZmlsZXNUb0xvYWQpO1xuICAgICAgLy8gY2xlYXIgYXVkaW8gYnVmZmVyIGxvYWRlciBjYWNoZVxuICAgICAgYXVkaW9CdWZmZXJMb2FkZXIuZGF0YSA9IHt9O1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTZXNzaW9uO1xuIl19