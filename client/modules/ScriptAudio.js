"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _AudioModule = _interopRequireDefault(require("./AudioModule.js"));

var _json = _interopRequireDefault(require("json5"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// extend AudioModule to have the bypass node
// @note - the implmentation is mostly the same as ScriptData, but we can't
// derive 2 parents... maybe mixin would help
class ScriptAudio extends _AudioModule.default {
  constructor(graph, type, id, options) {
    // @note - these defaults are weak, we must reinforce this
    options = Object.assign({
      scriptName: 'default'
    }, options);
    super(graph, type, id, options);
    this.scriptService = this.graph.como.experience.plugins['scripts-audio'];
    this.script = null;
  }

  async init() {
    await this.setScript(this.options.scriptName);
  }

  async destroy() {
    super.destroy();

    if (this.script !== null) {
      const script = this.script;
      this.script = null; // this will call the onDetach callback and thus destroy the script

      await script.detach();
    }
  }

  async updateOptions(options) {
    super.updateOptions(options);

    if (!this.script || this.options.scriptName !== this.script.name) {
      await this.setScript(this.options.scriptName);
    }

    if (this.scriptModule && this.options.scriptParams) {
      if (typeof this.options.scriptParams === 'string') {
        try {
          this.options.scriptParams = _json.default.parse(this.options.scriptParams);
        } catch (err) {
          console.error(`Invalid script param, please provide a proper javascript object`);
          console.error(err);
        }
      }

      this.scriptModule.updateParams(this.options.scriptParams);
    }
  }

  async setScript(scriptName) {
    if (this.script !== null) {
      await this.script.detach();
      this.script = null;
    }

    this.script = await this.scriptService.attach(scriptName);
    this.script.subscribe(updates => {
      if (!updates.error) {
        this.initScript();
      }
    });
    this.script.onDetach(() => {
      this.scriptModule.destroy();
      this.scriptModule = null;
    });
    this.initScript();
  }

  initScript() {
    if (this.scriptModule) {
      this.scriptModule.destroy();
    }

    try {
      const scriptModule = this.script.execute(this.graph, this.graph.como.helpers, this.passThroughInNode, this.passThroughOutNode, this.outputFrame);

      if (!('process' in scriptModule) || !('destroy' in scriptModule) || !('updateParams' in scriptModule)) {
        throw new Error(`Invalid scriptModule "${this.script.name}", the script should return an object { updateParams, process, destroy }`);
      }

      this.scriptModule = scriptModule;
    } catch (err) {
      console.log(err);
    }
  }

  execute(inputFrame) {
    if (this.scriptModule) {
      this.outputFrame = this.scriptModule.process(inputFrame, this.outputFrame);
    }

    return this.outputFrame;
  }

}

var _default = ScriptAudio;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQvbW9kdWxlcy9TY3JpcHRBdWRpby5qcyJdLCJuYW1lcyI6WyJTY3JpcHRBdWRpbyIsIkF1ZGlvTW9kdWxlIiwiY29uc3RydWN0b3IiLCJncmFwaCIsInR5cGUiLCJpZCIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJzY3JpcHROYW1lIiwic2NyaXB0U2VydmljZSIsImNvbW8iLCJleHBlcmllbmNlIiwicGx1Z2lucyIsInNjcmlwdCIsImluaXQiLCJzZXRTY3JpcHQiLCJkZXN0cm95IiwiZGV0YWNoIiwidXBkYXRlT3B0aW9ucyIsIm5hbWUiLCJzY3JpcHRNb2R1bGUiLCJzY3JpcHRQYXJhbXMiLCJKU09ONSIsInBhcnNlIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwidXBkYXRlUGFyYW1zIiwiYXR0YWNoIiwic3Vic2NyaWJlIiwidXBkYXRlcyIsImluaXRTY3JpcHQiLCJvbkRldGFjaCIsImV4ZWN1dGUiLCJoZWxwZXJzIiwicGFzc1Rocm91Z2hJbk5vZGUiLCJwYXNzVGhyb3VnaE91dE5vZGUiLCJvdXRwdXRGcmFtZSIsIkVycm9yIiwibG9nIiwiaW5wdXRGcmFtZSIsInByb2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLFdBQU4sU0FBMEJDLG9CQUExQixDQUFzQztBQUNwQ0MsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVFDLElBQVIsRUFBY0MsRUFBZCxFQUFrQkMsT0FBbEIsRUFBMkI7QUFDcEM7QUFDQUEsSUFBQUEsT0FBTyxHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUFFQyxNQUFBQSxVQUFVLEVBQUU7QUFBZCxLQUFkLEVBQXlDSCxPQUF6QyxDQUFWO0FBQ0EsVUFBTUgsS0FBTixFQUFhQyxJQUFiLEVBQW1CQyxFQUFuQixFQUF1QkMsT0FBdkI7QUFFQSxTQUFLSSxhQUFMLEdBQXFCLEtBQUtQLEtBQUwsQ0FBV1EsSUFBWCxD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QixLQUFLekIsTUFBTCxDQUFZTSxJQUFLLDBFQUFwRCxDQUFOO0FBQ0Q7O0FBRUQsV0FBS0MsWUFBTCxHQUFvQkEsWUFBcEI7QUFDRCxLQWpCRCxDQWlCRSxPQUFNSSxHQUFOLEVBQVc7QUFDWEMsTUFBQUEsT0FBTyxDQUFDYyxHQUFSLENBQVlmLEdBQVo7QUFDRDtBQUNGOztBQUVEUyxFQUFBQSxPQUFPLENBQUNPLFVBQUQsRUFBYTtBQUNsQixRQUFJLEtBQUtwQixZQUFULEVBQXVCO0FBQ3JCLFdBQUtpQixXQUFMLEdBQW1CLEtBQUtqQixZQUFMLENBQWtCcUIsT0FBbEIsQ0FBMEJELFVBQTFCLEVBQXNDLEtBQUtILFdBQTNDLENBQW5CO0FBQ0Q7O0FBRUQsV0FBTyxLQUFLQSxXQUFaO0FBQ0Q7O0FBdEdtQzs7ZUF5R3ZCdEMsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBdWRpb01vZHVsZSBmcm9tICcuL0F1ZGlvTW9kdWxlLmpzJztcbmltcG9ydCBKU09ONSBmcm9tICdqc29uNSc7XG5cbi8vIGV4dGVuZCBBdWRpb01vZHVsZSB0byBoYXZlIHRoZSBieXBhc3Mgbm9kZVxuLy8gQG5vdGUgLSB0aGUgaW1wbG1lbnRhdGlvbiBpcyBtb3N0bHkgdGhlIHNhbWUgYXMgU2NyaXB0RGF0YSwgYnV0IHdlIGNhbid0XG4vLyBkZXJpdmUgMiBwYXJlbnRzLi4uIG1heWJlIG1peGluIHdvdWxkIGhlbHBcbmNsYXNzIFNjcmlwdEF1ZGlvIGV4dGVuZHMgQXVkaW9Nb2R1bGUge1xuICBjb25zdHJ1Y3RvcihncmFwaCwgdHlwZSwgaWQsIG9wdGlvbnMpIHtcbiAgICAvLyBAbm90ZSAtIHRoZXNlIGRlZmF1bHRzIGFyZSB3ZWFrLCB3ZSBtdXN0IHJlaW5mb3JjZSB0aGlzXG4gICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBzY3JpcHROYW1lOiAnZGVmYXVsdCcgfSwgb3B0aW9ucyk7XG4gICAgc3VwZXIoZ3JhcGgsIHR5cGUsIGlkLCBvcHRpb25zKTtcblxuICAgIHRoaXMuc2NyaXB0U2VydmljZSA9IHRoaXMuZ3JhcGguY29tby5leHBlcmllbmNlLnBsdWdpbnNbJ3NjcmlwdHMtYXVkaW8nXTtcblxuICAgIHRoaXMuc2NyaXB0ID0gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5zZXRTY3JpcHQodGhpcy5vcHRpb25zLnNjcmlwdE5hbWUpO1xuICB9XG5cbiAgYXN5bmMgZGVzdHJveSgpIHtcbiAgICBzdXBlci5kZXN0cm95KCk7XG5cbiAgICBpZiAodGhpcy5zY3JpcHQgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHNjcmlwdCA9IHRoaXMuc2NyaXB0O1xuICAgICAgdGhpcy5zY3JpcHQgPSBudWxsO1xuICAgICAgLy8gdGhpcyB3aWxsIGNhbGwgdGhlIG9uRGV0YWNoIGNhbGxiYWNrIGFuZCB0aHVzIGRlc3Ryb3kgdGhlIHNjcmlwdFxuICAgICAgYXdhaXQgc2NyaXB0LmRldGFjaCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZU9wdGlvbnMob3B0aW9ucykge1xuICAgIHN1cGVyLnVwZGF0ZU9wdGlvbnMob3B0aW9ucyk7XG5cbiAgICBpZiAoIXRoaXMuc2NyaXB0IHx8ICh0aGlzLm9wdGlvbnMuc2NyaXB0TmFtZSAhPT0gdGhpcy5zY3JpcHQubmFtZSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0U2NyaXB0KHRoaXMub3B0aW9ucy5zY3JpcHROYW1lKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zY3JpcHRNb2R1bGUgJiYgdGhpcy5vcHRpb25zLnNjcmlwdFBhcmFtcykge1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLm9wdGlvbnMuc2NyaXB0UGFyYW1zID09PSAnc3RyaW5nJykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMub3B0aW9ucy5zY3JpcHRQYXJhbXMgPSBKU09ONS5wYXJzZSh0aGlzLm9wdGlvbnMuc2NyaXB0UGFyYW1zKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgSW52YWxpZCBzY3JpcHQgcGFyYW0sIHBsZWFzZSBwcm92aWRlIGEgcHJvcGVyIGphdmFzY3JpcHQgb2JqZWN0YCk7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2NyaXB0TW9kdWxlLnVwZGF0ZVBhcmFtcyh0aGlzLm9wdGlvbnMuc2NyaXB0UGFyYW1zKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXRTY3JpcHQoc2NyaXB0TmFtZSkge1xuICAgIGlmICh0aGlzLnNjcmlwdCAhPT0gbnVsbCkge1xuICAgICAgYXdhaXQgdGhpcy5zY3JpcHQuZGV0YWNoKCk7XG4gICAgICB0aGlzLnNjcmlwdCA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5zY3JpcHQgPSBhd2FpdCB0aGlzLnNjcmlwdFNlcnZpY2UuYXR0YWNoKHNjcmlwdE5hbWUpO1xuXG4gICAgdGhpcy5zY3JpcHQuc3Vic2NyaWJlKHVwZGF0ZXMgPT4ge1xuICAgICAgaWYgKCF1cGRhdGVzLmVycm9yKSB7XG4gICAgICAgIHRoaXMuaW5pdFNjcmlwdCgpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5zY3JpcHQub25EZXRhY2goKCkgPT4ge1xuICAgICAgdGhpcy5zY3JpcHRNb2R1bGUuZGVzdHJveSgpO1xuICAgICAgdGhpcy5zY3JpcHRNb2R1bGUgPSBudWxsO1xuICAgIH0pO1xuXG4gICAgdGhpcy5pbml0U2NyaXB0KCk7XG4gIH1cblxuICBpbml0U2NyaXB0KCkge1xuICAgIGlmICh0aGlzLnNjcmlwdE1vZHVsZSkge1xuICAgICAgdGhpcy5zY3JpcHRNb2R1bGUuZGVzdHJveSgpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY3JpcHRNb2R1bGUgPSB0aGlzLnNjcmlwdC5leGVjdXRlKFxuICAgICAgICB0aGlzLmdyYXBoLFxuICAgICAgICB0aGlzLmdyYXBoLmNvbW8uaGVscGVycyxcbiAgICAgICAgdGhpcy5wYXNzVGhyb3VnaEluTm9kZSxcbiAgICAgICAgdGhpcy5wYXNzVGhyb3VnaE91dE5vZGUsXG4gICAgICAgIHRoaXMub3V0cHV0RnJhbWVcbiAgICAgICk7XG5cbiAgICAgIGlmICghKCdwcm9jZXNzJyBpbiBzY3JpcHRNb2R1bGUpIHx8XG4gICAgICAgICAgISgnZGVzdHJveScgaW4gc2NyaXB0TW9kdWxlKSB8fFxuICAgICAgICAgICEoJ3VwZGF0ZVBhcmFtcycgaW4gc2NyaXB0TW9kdWxlKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzY3JpcHRNb2R1bGUgXCIke3RoaXMuc2NyaXB0Lm5hbWV9XCIsIHRoZSBzY3JpcHQgc2hvdWxkIHJldHVybiBhbiBvYmplY3QgeyB1cGRhdGVQYXJhbXMsIHByb2Nlc3MsIGRlc3Ryb3kgfWApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnNjcmlwdE1vZHVsZSA9IHNjcmlwdE1vZHVsZTtcbiAgICB9IGNhdGNoKGVycikge1xuICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICB9XG4gIH1cblxuICBleGVjdXRlKGlucHV0RnJhbWUpIHtcbiAgICBpZiAodGhpcy5zY3JpcHRNb2R1bGUpIHtcbiAgICAgIHRoaXMub3V0cHV0RnJhbWUgPSB0aGlzLnNjcmlwdE1vZHVsZS5wcm9jZXNzKGlucHV0RnJhbWUsIHRoaXMub3V0cHV0RnJhbWUpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLm91dHB1dEZyYW1lO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNjcmlwdEF1ZGlvO1xuIl19